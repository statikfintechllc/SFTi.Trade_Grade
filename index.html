<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-navbutton-color" content="#000000">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="manifest" href="system/js.on/manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23cc0000'/%3E%3Cpath d='M8 10h6v2H8v-2zm0 4h8v2H8v-2zm0 4h10v2H8v-2z' fill='%23ff6666'/%3E%3Ccircle cx='22' cy='12' r='4' fill='%2300ff00'/%3E%3Cpath d='M22 10v4m-2-2h4' stroke='white' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="system/img/icon-192.png">
    <title>PREPARE Trading Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    html {
        background: #000000;
        height: 100%;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        min-height: 100vh;
        min-height: 100dvh;
        color: #e0e0e0;
        -webkit-font-smoothing: antialiased;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }

    .header {
        background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        color: white;
        padding: 12px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid #cc0000;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .logo {
        width: 28px;
        height: 28px;
    }

    .header h1 {
        font-size: 16px;
        font-weight: 700;
        letter-spacing: 0.5px;
    }

    .hamburger {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .hamburger:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .hamburger-icon {
        width: 24px;
        height: 2px;
        background: white;
        display: block;
        position: relative;
        transition: all 0.3s;
    }

    .hamburger-icon::before,
    .hamburger-icon::after {
        content: '';
        width: 24px;
        height: 2px;
        background: white;
        position: absolute;
        left: 0;
        transition: all 0.3s;
    }

    .hamburger-icon::before {
        top: -8px;
    }

    .hamburger-icon::after {
        top: 8px;
    }

    .hamburger.active .hamburger-icon {
        background: transparent;
    }

    .hamburger.active .hamburger-icon::before {
        transform: rotate(45deg);
        top: 0;
    }

    .hamburger.active .hamburger-icon::after {
        transform: rotate(-45deg);
        top: 0;
    }

    .side-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        height: 100vh;
        background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 60;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.8);
        border-right: 2px solid #cc0000;
        padding-top: env(safe-area-inset-top);
    }

    .side-menu.active {
        transform: translateX(0);
    }

    .menu-header {
        padding: 12px 12px;
        position: sticky;
        top: 0;
        border-bottom: 1px solid #333;
    }

    .menu-logo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 4px;
    }

    .menu-title {
        font-weight: 700;
        font-size: 16px;
        color: white;
    }

    .menu-subtitle {
        font-size: 11px;
        color: #888;
    }

    .menu-nav {
        padding: 16px 12px;
    }

    .menu-btn {
        width: 100%;
        padding: 12px 14px;
        background: none;
        border: none;
        color: #b0b0b0;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 10px;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .menu-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .menu-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        transform: translateX(4px);
        box-shadow: inset 3px 0 0 rgba(204, 0, 0, 0.5);
    }
    
    .menu-btn:hover::before {
        left: 100%;
    }
    
    .menu-btn.active {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
        box-shadow: 0 4px 16px rgba(204, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateX(6px);
    }

    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 55;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .container {
        padding: 10px;
        max-width: 480px;
        margin: 0 auto;
        padding-bottom: 4px;
    }

    .card {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%);
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 
                    0 2px 8px rgba(204, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.1), transparent);
        transition: left 0.6s ease;
    }
    
    .card:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6), 
                    0 4px 16px rgba(204, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border-color: rgba(204, 0, 0, 0.3);
    }
    
    .card:hover::before {
        left: 100%;
    }

    .ticker-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(26, 26, 26, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .ticker-input:focus {
        outline: none;
        border-color: #cc0000;
        background: rgba(13, 13, 13, 0.9);
        box-shadow: 0 0 0 4px rgba(204, 0, 0, 0.15),
                    inset 0 2px 4px rgba(0, 0, 0, 0.4),
                    0 4px 16px rgba(204, 0, 0, 0.3);
        transform: scale(1.02);
    }
    
    .ticker-input::placeholder {
        color: #555;
    }

    .score-display {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        color: white;
        box-shadow: 0 8px 32px rgba(204, 0, 0, 0.5),
                    0 0 40px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }
    
    .score-display::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
        animation: scoreGlow 8s ease-in-out infinite;
    }
    
    @keyframes scoreGlow {
        0%, 100% { transform: translate(0, 0) scale(1); }
        50% { transform: translate(-20%, -20%) scale(1.2); }
    }
    
    .score-display:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 48px rgba(204, 0, 0, 0.7),
                    0 0 60px rgba(204, 0, 0, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.3);
    }

    .score-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
    }

    .score-value {
        font-size: 36px;
        font-weight: 700;
        line-height: 1;
    }

    .score-max {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 4px;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-fill {
        height: 100%;
        background: white;
        border-radius: 6px;
        transition: width 0.3s ease;
    }

    .card-title {
        font-size: 12px;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #333;
    }

    .slider-group {
        margin-bottom: 14px;
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
    }

    .slider-label {
        flex: 1;
    }

    .slider-title {
        font-weight: 600;
        color: #e0e0e0;
        font-size: 13px;
        margin-bottom: 0;
    }

    .slider-subtitle {
        font-size: 9px;
        color: #888;
        display: none;
    }

    .slider-value {
        font-size: 16px;
        font-weight: 700;
        color: #cc0000;
        min-width: 32px;
        text-align: right;
    }

    .slider {
        width: 100%;
        height: 6px;
        border-radius: 6px;
        background: #1a1a1a;
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #cc0000 0%, #ff3333 100%);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(204, 0, 0, 0.4);
    }

    .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #cc0000 0%, #ff3333 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(204, 0, 0, 0.4);
    }

    .slider-range {
        display: none;
    }

    .save-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(204, 0, 0, 0.4), 
                    0 2px 8px rgba(204, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .save-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }
    
    .save-btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 32px rgba(204, 0, 0, 0.6),
                    0 4px 16px rgba(204, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
        filter: brightness(1.1);
    }
    
    .save-btn:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .save-btn:active {
        transform: scale(0.97);
        box-shadow: 0 2px 12px rgba(204, 0, 0, 0.4);
    }

    .history-item {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 12px;
        align-items: center;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                    0 2px 8px rgba(204, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .history-item::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(204, 0, 0, 0.08) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.6s ease, transform 0.6s ease;
        pointer-events: none;
    }
    
    .history-item:hover {
        transform: translateY(-6px) scale(1.02);
        border-color: rgba(204, 0, 0, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
                    0 8px 20px rgba(204, 0, 0, 0.25),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1),
                    0 0 40px rgba(204, 0, 0, 0.15);
    }
    
    .history-item:hover::before {
        opacity: 1;
        transform: scale(1.1) rotate(45deg);
    }
    
    .history-item:active {
        transform: translateY(-2px) scale(0.99);
    }

    .history-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .history-ticker {
        font-size: 18px;
        font-weight: 700;
        color: white;
    }

    .history-grades-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        font-size: 11px;
    }

    .history-grade-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: #b0b0b0;
    }

    .history-grade-letter {
        font-weight: 700;
        color: #cc0000;
        font-size: 12px;
    }

    .history-grade-value {
        color: #e0e0e0;
        font-weight: 600;
    }

    .history-center {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
    }

    .history-score-value {
        font-size: 48px;
        font-weight: 700;
        color: white;
        line-height: 1;
    }

    .history-right {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .history-screenshot {
        width: 100%;
        max-width: 120px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .history-screenshot::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(204, 0, 0, 0.2), rgba(204, 0, 0, 0.05));
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
    }
    
    .history-screenshot:hover {
        border-color: rgba(204, 0, 0, 0.5);
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 12px 32px rgba(204, 0, 0, 0.4),
                    0 0 20px rgba(204, 0, 0, 0.2);
        filter: brightness(1.1) saturate(1.2);
    }
    
    .history-screenshot:hover::after {
        opacity: 1;
    }

    .history-no-screenshot {
        width: 100%;
        max-width: 120px;
        height: 80px;
        border-radius: 6px;
        border: 1px dashed #333;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
        font-size: 10px;
    }

    .history-footer {
        grid-column: 1 / -1;
        display: flex;
        gap: 6px;
        margin-top: 8px;
    }

    .delete-btn {
        width: 100%;
        padding: 8px;
        background: rgba(204, 0, 0, 0.1);
        color: #cc0000;
        border: 1px solid rgba(204, 0, 0, 0.3);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .delete-btn:hover {
        background: rgba(204, 0, 0, 0.2);
    }

    .empty-state {
        text-align: center;
        padding: 40px 16px;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .empty-text {
        color: #666;
        font-size: 14px;
        margin-bottom: 6px;
    }

    .empty-subtext {
        color: #555;
        font-size: 11px;
    }

    .label-text {
        display: block;
        font-size: 10px;
        font-weight: 600;
        color: #b0b0b0;
        margin-bottom: 4px;
    }

    .icon-svg {
        width: 16px;
        height: 16px;
    }

    /* iOS 26 Liquid Glass Style Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.95) 0%, rgba(25, 25, 25, 0.98) 100%);
        border-radius: 24px;
        padding: 28px;
        width: 100%;
        max-width: 320px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.6), 
                    0 8px 24px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.5), transparent);
        animation: modalShimmer 2s ease-in-out infinite;
        pointer-events: none;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    @keyframes modalShimmer {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.8; }
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: white;
        text-align: center;
        margin-bottom: 16px;
    }

    .modal-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        text-transform: uppercase;
        margin-bottom: 16px;
        outline: none;
        transition: all 0.2s;
    }

    .modal-input:focus {
        border-color: rgba(204, 0, 0, 0.6);
        background: rgba(0, 0, 0, 0.6);
    }

    .modal-input::placeholder {
        color: #666;
        text-transform: none;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
    }

    .modal-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
    }

    .modal-btn-confirm {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
    }

    .modal-btn:active {
        transform: scale(0.98);
    }

    .btn-icon {
        width: 14px;
        height: 14px;
        vertical-align: middle;
        margin-right: 4px;
    }

    .compact-card {
        padding: 10px 12px;
    }

    /* Trade plan slider styles */
    #stopLoss-slider::-webkit-slider-thumb {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%) !important;
        box-shadow: 0 2px 6px rgba(255, 68, 68, 0.4) !important;
    }

    #profitTarget-slider::-webkit-slider-thumb {
        background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%) !important;
        box-shadow: 0 2px 6px rgba(0, 255, 0, 0.4) !important;
    }

    #stopLoss-slider::-moz-range-thumb {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%) !important;
        box-shadow: 0 2px 6px rgba(255, 68, 68, 0.4) !important;
    }

    #profitTarget-slider::-moz-range-thumb {
        background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%) !important;
        box-shadow: 0 2px 6px rgba(0, 255, 0, 0.4) !important;
    }

    /* Glass card animation */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    /* Entry price input style */
    #entryPriceInput {
        background: rgba(255, 204, 0, 0.1);
        border-color: rgba(255, 204, 0, 0.3);
    }

    #entryPriceInput:focus {
        border-color: #ffcc00;
        box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
    }

    /* History filter select */
    #historyGradeFilter {
        background: #1a1a1a;
        cursor: pointer;
    }

    #historyGradeFilter option {
        background: #1a1a1a;
        color: #e0e0e0;
    }

    /* Toast Notification Styles */
    .toast-container {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
        width: 90%;
        max-width: 400px;
    }

    .toast {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.95) 0%, rgba(25, 25, 25, 0.98) 100%);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 18px;
        padding: 18px 22px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 
                    0 5px 15px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.12);
        pointer-events: auto;
        animation: toastSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: flex-start;
        gap: 14px;
        position: relative;
        overflow: hidden;
    }
    
    .toast::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, rgba(204, 0, 0, 0.1), transparent 70%);
        pointer-events: none;
    }
    
    .toast::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.6), transparent);
        animation: toastShimmer 2s ease-in-out infinite;
    }
    
    @keyframes toastShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .toast.toast-exit {
        animation: toastSlideOut 0.3s ease-in forwards;
    }

    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes toastSlideOut {
        from {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        to {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
    }

    .toast-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 14px;
    }

    .toast-icon.success {
        background: rgba(0, 255, 0, 0.2);
        color: #00ff00;
    }

    .toast-icon.error {
        background: rgba(255, 68, 68, 0.2);
        color: #ff4444;
    }

    .toast-icon.warning {
        background: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
    }

    .toast-icon.info {
        background: rgba(100, 149, 237, 0.2);
        color: #6495ed;
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-bottom: 4px;
    }

    .toast-message {
        font-size: 12px;
        color: #b0b0b0;
        line-height: 1.4;
        white-space: pre-line;
    }

    .toast-close {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 4px;
        margin: -4px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 16px;
        line-height: 1;
    }

    .toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
    }
</style>

</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="header">
        <button class="hamburger" onclick="toggleMenu()">
            <span class="hamburger-icon"></span>
        </button>
        <div class="header-title">
            <svg class="logo" viewBox="0 0 32 32" fill="none">
                <rect width="32" height="32" rx="6" fill="#cc0000"/>
                <path d="M8 10h6v2H8v-2zm0 4h8v2H8v-2zm0 4h10v2H8v-2z" fill="#ff6666"/>
                <circle cx="22" cy="12" r="4" fill="#00ff00"/>
                <path d="M22 10v4m-2-2h4" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <h1>P.R.E.P</h1>
        </div>
        <div style="width: 40px;"></div>
    </div>

<div class="side-menu" id="sideMenu">
    <div class="menu-header">
        <div class="menu-logo">
            <svg class="logo" viewBox="0 0 32 32" fill="none">
                <rect width="32" height="32" rx="6" fill="#cc0000"/>
                <path d="M8 10h6v2H8v-2zm0 4h8v2H8v-2zm0 4h10v2H8v-2z" fill="#ff6666"/>
                <circle cx="22" cy="12" r="4" fill="#00ff00"/>
                <path d="M22 10v4m-2-2h4" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            <div>
                <div class="menu-title">PREPARE</div>
                <div class="menu-subtitle">Trading Journal</div>
            </div>
        </div>
    </div>
    <div class="menu-nav">
        <button class="menu-btn active" onclick="switchView('grade')" id="gradeBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <span>Grade Stock</span>
        </button>
        <button class="menu-btn" onclick="switchView('tracker')" id="trackerBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Trade Plan</span>
        </button>
        <button class="menu-btn" onclick="switchView('finalize')" id="finalizeBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Finalize Trades</span>
        </button>
        <button class="menu-btn" onclick="switchView('history')" id="historyBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>History</span>
        </button>
        <button class="menu-btn" onclick="switchView('ai')" id="aiBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>
                <circle cx="7.5" cy="14.5" r="1.5" fill="currentColor"></circle>
                <circle cx="16.5" cy="14.5" r="1.5" fill="currentColor"></circle>
            </svg>
            <span>AI Assistant</span>
        </button>
        <button class="menu-btn" onclick="refreshServiceWorker()">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            <span>Refresh</span>
        </button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="container">
    <div id="gradeView">
        <div class="card compact-card">
            <input type="text" class="ticker-input" id="tickerInput" placeholder="ENTER TICKER" maxlength="10">
        </div>

        <div class="card score-display compact-card">
            <div class="score-value"><span id="totalScore">50</span>/100</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 50%"></div>
            </div>
        </div>

        <div class="card">
            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">P - Pattern/Price</div>
                        <div class="slider-subtitle">Technical setup quality</div>
                    </div>
                    <div class="slider-value" id="pattern-value">10</div>
                </div>  
                <input type="range" class="slider" min="1" max="20" value="10" id="pattern-slider" oninput="updateSlider('pattern', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">R - Risk/Reward</div>
                        <div class="slider-subtitle">Trade R:R ratio</div>
                    </div>
                    <div class="slider-value" id="risk-value">10</div>
                </div>
                <input type="range" class="slider" min="1" max="20" value="10" id="risk-slider" oninput="updateSlider('risk', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">E - Ease of Entry/Exit</div>
                        <div class="slider-subtitle">Liquidity & execution</div>
                    </div>
                    <div class="slider-value" id="entry-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="entry-slider" oninput="updateSlider('entry', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">P - Past Performance</div>
                        <div class="slider-subtitle">History of spiking</div>
                    </div>
                    <div class="slider-value" id="performance-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="performance-slider" oninput="updateSlider('performance', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">A - At What Time Is It?</div>
                        <div class="slider-subtitle">Personal schedule fit</div>
                    </div>
                    <div class="slider-value" id="time-value">10</div>
                </div>
                <input type="range" class="slider" min="1" max="20" value="10" id="time-slider" oninput="updateSlider('time', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">R - Reason/Catalyst</div>
                        <div class="slider-subtitle">News or event driver</div>
                    </div>
                    <div class="slider-value" id="catalyst-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="catalyst-slider" oninput="updateSlider('catalyst', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">E - Market Environment</div>
                        <div class="slider-subtitle">Overall market conditions</div>
                    </div>
                    <div class="slider-value" id="environment-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="environment-slider" oninput="updateSlider('environment', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>
        </div>

        <div class="card">
            <input type="file" id="screenshotInput" accept="image/*" style="display: none;">
            <div id="screenshotPreview" style="display: none; margin-bottom: 8px; position: relative;">
                <img id="previewImg" style="width: 100%; border-radius: 6px; border: 1px solid #333;">
                <button id="clearScreenshotBtn" style="position: absolute; top: 4px; right: 4px; background: rgba(204,0,0,0.9); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px;">Ã—</button>
            </div>
            <button id="addScreenshotBtn" class="save-btn" style="padding: 8px; background: linear-gradient(135deg, #333 0%, #222 100%);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span id="screenshotBtnText">Add Screenshot</span>
            </button>
        </div>

        <button class="save-btn" onclick="continueToTracker()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 16 16 12 12 8"></polyline>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Continue
        </button>
    </div>

    <div id="trackerView" style="display: none;">
        <div class="card" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Trade Plan Builder
            </div>
            
            <div id="trackerTickerDisplay" style="text-align: center; margin-bottom: 12px;">
                <span style="font-size: 24px; font-weight: 700; color: white;" id="trackerTickerLabel">---</span>
                <span style="font-size: 12px; color: #888; display: block;">Score: <span id="trackerScoreLabel">--</span>/100</span>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #ffcc00;">ðŸ’° Ideal Entry Price</div>
                    </div>
                </div>
                <input type="number" class="ticker-input" id="entryPriceInput" placeholder="Enter price (e.g., 1.05)" step="0.01" min="0.01" max="10000" style="text-transform: none; font-size: 16px; text-align: center;">
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #ff4444;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Stop Loss
                        </div>
                        <div class="slider-subtitle" style="display: block;">Protect your capital</div>
                    </div>
                    <div class="slider-value" style="color: #ff4444;" id="stopLoss-value">7%</div>
                </div>
                <input type="range" class="slider" min="5" max="10" value="7" step="0.5" id="stopLoss-slider" oninput="updateTrackerSlider('stopLoss', this.value)" style="background: linear-gradient(to right, #ff4444 0%, #ff4444 40%, #1a1a1a 40%, #1a1a1a 100%);">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 2px;">
                    <span>5%</span>
                    <span id="stopPriceDisplay" style="color: #ff4444; font-weight: 600;">$0.00</span>
                    <span>10%</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #00ff00;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 8v8m-4-4h8"></path>
                            </svg>
                            Profit Target
                        </div>
                        <div class="slider-subtitle" style="display: block;">Set your goal</div>
                    </div>
                    <div class="slider-value" style="color: #00ff00;" id="profitTarget-value">20%</div>
                </div>
                <input type="range" class="slider" min="15" max="30" value="20" step="1" id="profitTarget-slider" oninput="updateTrackerSlider('profitTarget', this.value)" style="background: linear-gradient(to right, #00ff00 0%, #00ff00 33%, #1a1a1a 33%, #1a1a1a 100%);">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 2px;">
                    <span>15%</span>
                    <span id="targetPriceDisplay" style="color: #00ff00; font-weight: 600;">$0.00</span>
                    <span>30%</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #6495ed; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Trade Thoughts</span>
                        </div>
                        <div class="slider-subtitle" style="display: block;">What are you thinking?</div>
                    </div>
                </div>
                <textarea class="ticker-input" id="tradeThoughtsInput" placeholder="Write down your thoughts about this trade..." style="text-transform: none; font-size: 12px; min-height: 80px; resize: vertical; line-height: 1.4;"></textarea>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, rgba(0, 100, 0, 0.2) 0%, rgba(100, 0, 0, 0.2) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.15);">
            <div style="text-align: center;">
                <div style="font-size: 11px; color: #888; margin-bottom: 4px;">RISK / REWARD RATIO</div>
                <div style="font-size: 36px; font-weight: 700; color: white;" id="rrRatioDisplay">
                    <span id="rrRatioValue">0.0</span><span style="font-size: 18px; color: #888;">:1</span>
                </div>
                <div id="rrQuality" style="font-size: 12px; margin-top: 4px; padding: 4px 12px; border-radius: 12px; display: inline-block;">--</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; text-align: center;">
                <div style="background: rgba(255, 204, 0, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 204, 0, 0.3);">
                    <div style="font-size: 10px; color: #ffcc00; margin-bottom: 2px;">ENTRY</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryEntry">$0.00</div>
                </div>
                <div style="background: rgba(255, 68, 68, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 68, 68, 0.3);">
                    <div style="font-size: 10px; color: #ff4444; margin-bottom: 2px;">STOP</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryStop">$0.00</div>
                </div>
                <div style="background: rgba(0, 255, 0, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(0, 255, 0, 0.3);">
                    <div style="font-size: 10px; color: #00ff00; margin-bottom: 2px;">TARGET</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryTarget">$0.00</div>
                </div>
            </div>
        </div>

        <button class="save-btn" onclick="saveTradePlan()" style="background: linear-gradient(135deg, #00aa00 0%, #006600 100%); box-shadow: 0 4px 15px rgba(0, 170, 0, 0.3);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save Trade Plan
        </button>

        <button class="save-btn" onclick="switchView('grade')" style="margin-top: 8px; background: linear-gradient(135deg, #333 0%, #222 100%);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Grade
        </button>
    </div>

    <div id="finalizeView" style="display: none;">
        <h2 style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px;">Finalize Trades</h2>
        
        <div class="card" style="margin-bottom: 12px; background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
            <div style="font-size: 11px; color: #888; line-height: 1.5;">
                <p>Review and finalize your planned trades. Mark trades as <span style="color: #ff4444; font-weight: 600;">Rejected</span> (not taken) or <span style="color: #00ff00; font-weight: 600;">Accepted</span> (executed) to track your results.</p>
            </div>
        </div>
        
        <div id="finalizeContainer"></div>
    </div>

    <div id="historyView" style="display: none;">
        <h2 style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px;">Trade History</h2>
        
        <div class="card" style="margin-bottom: 12px; background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 8px;">
            <div style="background: rgba(26, 26, 26, 0.8); border: 2px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 8px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                <input type="text" class="ticker-input" id="historySearchInput" placeholder="Search ticker..." style="width: 100%; padding: 12px 14px; font-size: 14px; border: none; background: transparent; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                <div style="display: flex; gap: 6px; align-items: center;">
                    <select id="historyGradeFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Grades</option>
                        <option value="A">A (90+)</option>
                        <option value="B">B (75-89)</option>
                        <option value="C">C (60-74)</option>
                        <option value="D">D (Below 60)</option>
                    </select>
                    <select id="historyStatusFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Status</option>
                        <option value="finalized">Finalized</option>
                        <option value="non-finalized">Non-Finalized</option>
                    </select>
                    <select id="historyStrategyFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Strategies</option>
                    </select>
                    <button class="save-btn" onclick="filterHistory()" aria-label="Search" style="flex: 0 0 auto; padding: 8px; font-size: 12px; border-radius: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="historyContainer"></div>
    </div>

    <div id="aiView" style="display: none;">
        <h2 style="font-size: 14px; font-weight: 700; color: white; margin-bottom: 8px;">AI Trading Assistant</h2>
        <div class="card">
            <label class="label-text">GitHub Token (for GitHub Models API)</label>
            <input type="password" class="ticker-input" id="githubToken" placeholder="ghp_..." style="text-transform: none; font-size: 12px;">
            <button class="save-btn" style="margin-top: 8px; padding: 8px;" onclick="saveToken()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                </svg>
                Save Token
            </button>
        </div>
        
        <div class="card">
            <label class="label-text">Quick Actions</label>
            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                <button class="save-btn" style="flex: 1; min-width: 45%; padding: 6px; font-size: 10px;" onclick="reviewGrades()" aria-label="Review grades">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                    Review Grades
                </button>
                <button class="save-btn" style="flex: 1; min-width: 45%; padding: 6px; font-size: 10px;" onclick="findPatterns()" aria-label="Find trading patterns">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    Find Patterns
                </button>
                <button class="save-btn" style="flex: 1; min-width: 45%; padding: 6px; font-size: 10px;" onclick="getSentiment()" aria-label="Get market sentiment">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                    Market Sentiment
                </button>
                <button class="save-btn" style="flex: 1; min-width: 45%; padding: 6px; font-size: 10px;" onclick="showTickerModal()" aria-label="Analyze ticker">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    Analyze Ticker
                </button>
            </div>
        </div>

        <div class="card">
            <label class="label-text">Chat with Copilot</label>
            <div id="chatMessages" style="max-height: 200px; overflow-y: auto; margin-bottom: 8px; font-size: 11px;"></div>
            <textarea id="aiPrompt" class="ticker-input" placeholder="Ask about trades, patterns, sentiment..." style="text-transform: none; font-size: 12px; min-height: 50px; resize: vertical;"></textarea>
            <div style="display: flex; gap: 6px; margin-top: 8px;">
                <button class="save-btn" style="flex: 1; padding: 8px;" onclick="askAI()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Send
                </button>
                <button class="save-btn" style="padding: 8px; background: linear-gradient(135deg, #333 0%, #222 100%);" onclick="clearChat()">Clear</button>
            </div>
        </div>
        <div class="card" id="aiResponseCard" style="display: none;">
            <label class="label-text">AI Response</label>
            <div id="aiResponse" style="font-size: 11px; line-height: 1.4; white-space: pre-wrap; color: #e0e0e0;"></div>
        </div>
    </div>
</div>

<!-- iOS Liquid Glass Style Ticker Modal -->
<div class="modal-overlay" id="tickerModal">
    <div class="modal-content">
        <div class="modal-title">Analyze Ticker</div>
        <input type="text" class="modal-input" id="tickerModalInput" placeholder="Enter symbol (e.g., AAPL)" maxlength="10">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideTickerModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmTickerAnalysis()">Analyze</button>
        </div>
    </div>
</div>

<!-- Trade Details Modal -->
<div class="modal-overlay" id="tradeDetailsModal">
    <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-title" id="tradeDetailsTitle">Trade Details</div>
        <div id="tradeDetailsContent" style="font-size: 12px; color: #e0e0e0; line-height: 1.6;">
            <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-buttons" style="margin-top: 16px;">
            <button class="modal-btn modal-btn-cancel" onclick="hideTradeDetailsModal()" style="width: 100%;">Close</button>
        </div>
    </div>
</div>

<!-- Finalize Trade Modal -->
<div class="modal-overlay" id="finalizeTradeModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-title">Finalize Trade: <span id="finalizeModalTicker"></span></div>
        <div id="finalizeModalContent" style="font-size: 12px; color: #e0e0e0; margin-bottom: 16px;">
            <!-- Initial choice or detailed finalization form -->
        </div>
        <div id="finalizeModalButtons" class="modal-buttons">
            <!-- Buttons will be populated dynamically -->
        </div>
    </div>
</div>

<!-- Full Screen Image Viewer Modal -->
<div class="modal-overlay" id="imageViewerModal" style="background: rgba(0, 0, 0, 0.95); cursor: pointer;">
    <button onclick="hideImageViewer()" aria-label="Close image viewer" style="position: fixed; top: 60px; right: 20px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 24px; z-index: 101; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <img id="fullScreenImage" src="" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; cursor: default;" onclick="event.stopPropagation();" alt="Full screen view">
</div>

<script>
    // Configuration constants
    const CONFIG = {
        MAX_SCREENSHOT_SIZE: 2 * 1024 * 1024, // 2MB max for screenshots
        MAX_GRADES_FOR_REVIEW: 10,
        MAX_GRADES_FOR_PATTERNS: 20,
        CHAT_MESSAGE_PREVIEW_LENGTH: 200,
        AI_MODEL: 'gpt-4o-mini',
        AI_MAX_TOKENS: 1500,  // Increased for more detailed responses
        AI_TEMPERATURE: 0.7,
        API_ENDPOINT: 'https://models.inference.ai.azure.com/chat/completions'
    };

    const state = {
        pattern: 10,
        risk: 10,
        entry: 5,
        performance: 5,
        time: 10,
        catalyst: 5,
        environment: 5
    };

    // Trade plan state
    const trackerState = {
        ticker: '',
        scores: null,
        total: 0,
        screenshot: null,
        stopLossPercent: 7,
        profitTargetPercent: 20,
        entryPrice: 0,
        thoughts: ''
    };

    let currentScreenshot = null;
    let chatHistory = [];
    let historyFilterTicker = '';
    let historyFilterGrade = '';
    let historyFilterStatus = '';
    let historyFilterStrategy = '';
    let currentFinalizeTradeIndex = null;

    /**
     * Reset all history filter state variables to their default (unfiltered) values.
     * Intended to be called whenever the user clears history filters in the UI.
     */
    function resetHistoryFilters() {
        historyFilterTicker = '';
        historyFilterGrade = '';
        historyFilterStatus = '';
        historyFilterStrategy = '';
    }

    /**
     * Convenience helper: clear filters and, if available, trigger a history refresh.
     * This can be wired to a "Clear Filters" button or similar UI control.
     */
    function clearHistoryFiltersAndRefreshHistory() {
        resetHistoryFilters();

        // If a global history-rendering function exists, call it to refresh the view.
        if (typeof renderHistory === 'function') {
            renderHistory();
        }
    }

    // Expose helpers globally so they can be used from inline handlers or other scripts.
    window.resetHistoryFilters = resetHistoryFilters;
    window.clearHistoryFiltersAndRefreshHistory = clearHistoryFiltersAndRefreshHistory;

    // Toast Notification System
    function showToast(message, type = 'info', title = null, duration = 4000, navigationView = null) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        // Make toast clickable if navigation is provided
        if (navigationView) {
            toast.style.cursor = 'pointer';
            toast.addEventListener('click', function(e) {
                // Don't navigate if clicking the close button
                if (!e.target.closest('.toast-close')) {
                    switchView(navigationView);
                    closeToast();
                }
            });
        }
        
        const icons = {
            success: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            error: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            warning: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        
        const defaultTitles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Info'
        };
        
        const displayTitle = title || defaultTitles[type] || 'Notification';
        
        // Helper to close toast with animation
        function closeToast() {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }
        
        toast.innerHTML = `
            <div class="toast-icon ${type}">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-title">${escapeHtml(displayTitle)}</div>
                <div class="toast-message">${message}</div>
                ${navigationView ? '<div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 4px;">Click to view</div>' : ''}
            </div>
            <button class="toast-close" aria-label="Close notification">Ã—</button>
        `;
        
        // Add click listener for close button
        toast.querySelector('.toast-close').addEventListener('click', closeToast);
        
        container.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            if (toast.parentElement) {
                closeToast();
            }
        }, duration);
        
        return toast;
    }

    // Security: HTML escape function to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const hamburger = document.querySelector('.hamburger');
        
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    function switchView(view) {
        const gradeView = document.getElementById('gradeView');
        const trackerView = document.getElementById('trackerView');
        const finalizeView = document.getElementById('finalizeView');
        const historyView = document.getElementById('historyView');
        const aiView = document.getElementById('aiView');
        const gradeBtn = document.getElementById('gradeBtn');
        const trackerBtn = document.getElementById('trackerBtn');
        const finalizeBtn = document.getElementById('finalizeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const aiBtn = document.getElementById('aiBtn');

        // Hide all views and deactivate all buttons
        gradeView.style.display = 'none';
        trackerView.style.display = 'none';
        finalizeView.style.display = 'none';
        historyView.style.display = 'none';
        aiView.style.display = 'none';
        gradeBtn.classList.remove('active');
        trackerBtn.classList.remove('active');
        finalizeBtn.classList.remove('active');
        historyBtn.classList.remove('active');
        aiBtn.classList.remove('active');

        if (view === 'grade') {
            gradeView.style.display = 'block';
            gradeBtn.classList.add('active');
        } else if (view === 'tracker') {
            trackerView.style.display = 'block';
            trackerBtn.classList.add('active');
            initializeTracker();
        } else if (view === 'finalize') {
            finalizeView.style.display = 'block';
            finalizeBtn.classList.add('active');
            loadFinalizeView();
        } else if (view === 'history') {
            historyView.style.display = 'block';
            historyBtn.classList.add('active');
            loadHistory();
        } else if (view === 'ai') {
            aiView.style.display = 'block';
            aiBtn.classList.add('active');
            loadToken();
        }
        
        // Only toggle menu if it's open (for menu button clicks)
        const menu = document.getElementById('sideMenu');
        if (menu.classList.contains('active')) {
            toggleMenu();
        }
    }

    function updateSlider(name, value, max) {
        state[name] = parseInt(value);
        document.getElementById(`${name}-value`).textContent = value;
        
        const slider = document.getElementById(`${name}-slider`);
        const percent = ((value - 1) / (max - 1)) * 100;
        slider.style.background = `linear-gradient(to right, #cc0000 0%, #cc0000 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        
        updateTotal();
    }

    function updateTotal() {
        const total = Object.values(state).reduce((a, b) => a + b, 0);
        document.getElementById('totalScore').textContent = total;
        document.getElementById('progressFill').style.width = `${(total / 100) * 100}%`;
    }

    // Trade Plan Functions
    function continueToTracker() {
        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        
        if (!ticker) {
            showToast('Please enter a ticker symbol', 'warning', 'Missing Ticker');
            return;
        }

        // Store grade data in trade plan state
        trackerState.ticker = ticker;
        trackerState.scores = { ...state };
        trackerState.total = Object.values(state).reduce((a, b) => a + b, 0);
        trackerState.screenshot = currentScreenshot;
        
        // Navigate to trade plan view
        switchView('tracker');
    }

    function initializeTracker() {
        // Display ticker and score
        document.getElementById('trackerTickerLabel').textContent = trackerState.ticker || '---';
        document.getElementById('trackerScoreLabel').textContent = trackerState.total || '--';
        
        // Reset entry price input
        document.getElementById('entryPriceInput').value = '';
        
        // Reset thoughts input
        document.getElementById('tradeThoughtsInput').value = '';
        
        // Initialize slider values and display
        trackerState.stopLossPercent = 7;
        trackerState.profitTargetPercent = 20;
        trackerState.entryPrice = 0;
        trackerState.thoughts = '';
        
        document.getElementById('stopLoss-slider').value = 7;
        document.getElementById('profitTarget-slider').value = 20;
        
        updateTrackerSlider('stopLoss', 7);
        updateTrackerSlider('profitTarget', 20);
        updateTrackerCalculations();
        
        // Add entry price input listener (only once)
        const entryInput = document.getElementById('entryPriceInput');
        if (entryInput && !entryInput._hasTrackerListener) {
            entryInput.addEventListener('input', function() {
                trackerState.entryPrice = parseFloat(this.value) || 0;
                updateTrackerCalculations();
            });
            entryInput._hasTrackerListener = true;
        }
    }

    function updateTrackerSlider(name, value) {
        const floatValue = parseFloat(value);
        
        if (name === 'stopLoss') {
            trackerState.stopLossPercent = floatValue;
            document.getElementById('stopLoss-value').textContent = floatValue + '%';
            
            // Update slider background
            const percent = ((floatValue - 5) / (10 - 5)) * 100;
            document.getElementById('stopLoss-slider').style.background = 
                `linear-gradient(to right, #ff4444 0%, #ff4444 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        } else if (name === 'profitTarget') {
            trackerState.profitTargetPercent = floatValue;
            document.getElementById('profitTarget-value').textContent = floatValue + '%';
            
            // Update slider background
            const percent = ((floatValue - 15) / (30 - 15)) * 100;
            document.getElementById('profitTarget-slider').style.background = 
                `linear-gradient(to right, #00ff00 0%, #00ff00 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        }
        
        updateTrackerCalculations();
    }

    function updateTrackerCalculations() {
        const entry = trackerState.entryPrice;
        const stopPercent = trackerState.stopLossPercent;
        const targetPercent = trackerState.profitTargetPercent;
        
        if (entry > 0) {
            const stopPrice = entry * (1 - stopPercent / 100);
            const targetPrice = entry * (1 + targetPercent / 100);
            const riskAmount = entry - stopPrice;
            const rewardAmount = targetPrice - entry;
            const rrRatio = riskAmount > 0 ? (rewardAmount / riskAmount).toFixed(1) : 0;
            
            // Update displays
            document.getElementById('stopPriceDisplay').textContent = '$' + stopPrice.toFixed(2);
            document.getElementById('targetPriceDisplay').textContent = '$' + targetPrice.toFixed(2);
            document.getElementById('summaryEntry').textContent = '$' + entry.toFixed(2);
            document.getElementById('summaryStop').textContent = '$' + stopPrice.toFixed(2);
            document.getElementById('summaryTarget').textContent = '$' + targetPrice.toFixed(2);
            document.getElementById('rrRatioValue').textContent = rrRatio;
            
            // Update R:R quality indicator
            const rrQualityEl = document.getElementById('rrQuality');
            const rrNum = parseFloat(rrRatio);
            if (rrNum >= 3) {
                rrQualityEl.textContent = 'ðŸ”¥ Excellent';
                rrQualityEl.style.background = 'rgba(0, 255, 0, 0.3)';
                rrQualityEl.style.color = '#00ff00';
            } else if (rrNum >= 2) {
                rrQualityEl.textContent = 'âœ… Good';
                rrQualityEl.style.background = 'rgba(0, 200, 0, 0.3)';
                rrQualityEl.style.color = '#00cc00';
            } else if (rrNum >= 1.5) {
                rrQualityEl.textContent = 'âš ï¸ Acceptable';
                rrQualityEl.style.background = 'rgba(255, 204, 0, 0.3)';
                rrQualityEl.style.color = '#ffcc00';
            } else {
                rrQualityEl.textContent = 'âŒ Poor';
                rrQualityEl.style.background = 'rgba(255, 68, 68, 0.3)';
                rrQualityEl.style.color = '#ff4444';
            }
        } else {
            // Reset displays when no entry price
            document.getElementById('stopPriceDisplay').textContent = '$0.00';
            document.getElementById('targetPriceDisplay').textContent = '$0.00';
            document.getElementById('summaryEntry').textContent = '$0.00';
            document.getElementById('summaryStop').textContent = '$0.00';
            document.getElementById('summaryTarget').textContent = '$0.00';
            document.getElementById('rrRatioValue').textContent = '0.0';
            
            const rrQualityEl = document.getElementById('rrQuality');
            rrQualityEl.textContent = 'Enter price';
            rrQualityEl.style.background = 'rgba(136, 136, 136, 0.3)';
            rrQualityEl.style.color = '#888';
        }
    }

    function saveTradePlan() {
        if (!trackerState.ticker) {
            showToast('No trade to save. Please grade a stock first.', 'warning', 'Missing Data');
            return;
        }
        
        const entry = trackerState.entryPrice;
        if (!entry || entry <= 0) {
            showToast('Please enter a valid entry price', 'warning', 'Invalid Price');
            return;
        }
        
        // Get the thoughts from the textarea
        const thoughts = document.getElementById('tradeThoughtsInput').value.trim();
        
        const stopPrice = entry * (1 - trackerState.stopLossPercent / 100);
        const targetPrice = entry * (1 + trackerState.profitTargetPercent / 100);
        const riskAmount = entry - stopPrice;
        const rewardAmount = targetPrice - entry;
        const rrRatio = riskAmount > 0 ? parseFloat((rewardAmount / riskAmount).toFixed(1)) : 0;
        
        const trade = {
            id: Date.now().toString(),
            ticker: trackerState.ticker,
            timestamp: new Date().toISOString(),
            grade: {
                scores: trackerState.scores,
                total: trackerState.total
            },
            screenshot: trackerState.screenshot,
            plan: {
                entry: entry,
                stopLoss: parseFloat(stopPrice.toFixed(2)),
                stopPercent: trackerState.stopLossPercent,
                target: parseFloat(targetPrice.toFixed(2)),
                targetPercent: trackerState.profitTargetPercent,
                riskReward: rrRatio,
                thoughts: thoughts
            },
            execution: {
                actualEntry: null,
                actualExit: null,
                outcome: null,
                pnl: null
            }
        };
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.unshift(trade);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        showToast(`Entry: $${entry.toFixed(2)} | Stop: $${stopPrice.toFixed(2)} | Target: $${targetPrice.toFixed(2)}<br>R:R Ratio: ${rrRatio}:1`, 'success', `${trade.ticker} Trade Plan Saved`, 5000, 'history');
        
        // Reset for next trade
        document.getElementById('tickerInput').value = '';
        clearScreenshot();
        resetSliders();
        trackerState.ticker = '';
        trackerState.scores = null;
        trackerState.total = 0;
        trackerState.screenshot = null;
        trackerState.thoughts = '';
        
        // Go back to grade view
        switchView('grade');
    }

    function getGradeLetter(total) {
        if (total >= 90) return 'A';
        if (total >= 75) return 'B';
        if (total >= 60) return 'C';
        return 'D';
    }

    function filterHistory() {
        historyFilterTicker = document.getElementById('historySearchInput').value.trim().toUpperCase();
        historyFilterGrade = document.getElementById('historyGradeFilter').value;
        historyFilterStatus = document.getElementById('historyStatusFilter').value;
        historyFilterStrategy = document.getElementById('historyStrategyFilter').value;
        loadHistory();
    }

    // Screenshot handling functions with size validation
    function handleScreenshot(input) {
        const file = input.files[0];
        if (file) {
            // Validate file size
            if (file.size > CONFIG.MAX_SCREENSHOT_SIZE) {
                showToast(`Maximum size is ${CONFIG.MAX_SCREENSHOT_SIZE / (1024 * 1024)}MB. Please choose a smaller image.`, 'error', 'Screenshot Too Large');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentScreenshot = e.target.result;
                document.getElementById('previewImg').src = currentScreenshot;
                document.getElementById('screenshotPreview').style.display = 'block';
                document.getElementById('screenshotBtnText').textContent = 'Change Screenshot';
            };
            reader.onerror = function() {
                showToast('Failed to read the selected file. Please try again with a different screenshot.', 'error', 'File Error');
                clearScreenshot();
            };
            reader.readAsDataURL(file);
        }
    }

    function clearScreenshot() {
        currentScreenshot = null;
        document.getElementById('screenshotPreview').style.display = 'none';
        document.getElementById('screenshotInput').value = '';
        document.getElementById('screenshotBtnText').textContent = 'Add Screenshot';
    }

    function saveGrade() {
        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        
        if (!ticker) {
            showToast('Please enter a ticker symbol', 'warning', 'Missing Ticker');
            return;
        }

        const grade = {
            id: Date.now().toString(),
            ticker: ticker,
            timestamp: new Date().toISOString(),
            scores: { ...state },
            total: Object.values(state).reduce((a, b) => a + b, 0),
            screenshot: currentScreenshot
        };

        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.unshift(grade);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));

        showToast(`Score: ${grade.total}/100`, 'success', `${ticker} Saved`);
        
        document.getElementById('tickerInput').value = '';
        clearScreenshot();
        resetSliders();
    }

    function resetSliders() {
        state.pattern = 10;
        state.risk = 10;
        state.entry = 5;
        state.performance = 5;
        state.time = 10;
        state.catalyst = 5;
        state.environment = 5;

        document.getElementById('pattern-slider').value = 10;
        document.getElementById('risk-slider').value = 10;
        document.getElementById('entry-slider').value = 5;
        document.getElementById('performance-slider').value = 5;
        document.getElementById('time-slider').value = 10;
        document.getElementById('catalyst-slider').value = 5;
        document.getElementById('environment-slider').value = 5;

        updateSlider('pattern', 10, 20);
        updateSlider('risk', 10, 20);
        updateSlider('entry', 5, 10);
        updateSlider('performance', 5, 10);
        updateSlider('time', 10, 20);
        updateSlider('catalyst', 5, 10);
        updateSlider('environment', 5, 10);
    }

    function loadHistory() {
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const container = document.getElementById('historyContainer');

        // Populate strategy filter dropdown with unique strategies
        const strategySet = new Set();
        for (const g of grades) {
            if (g && g.outcome && g.outcome.strategy) {
                strategySet.add(g.outcome.strategy);
            }
        }
        const strategies = Array.from(strategySet);
        const strategyFilter = document.getElementById('historyStrategyFilter');
        if (strategyFilter) {
            const currentValue = strategyFilter.value;
            strategyFilter.innerHTML = '<option value="">All Strategies</option>' + 
                strategies.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
            strategyFilter.value = currentValue;
        }

        // Apply filters
        if (historyFilterTicker) {
            grades = grades.filter(g => g.ticker === historyFilterTicker);
        }
        if (historyFilterGrade) {
            grades = grades.filter(g => {
                const total = g.total || (g.grade ? g.grade.total : 0);
                const letter = getGradeLetter(total);
                return letter === historyFilterGrade;
            });
        }
        if (historyFilterStatus) {
            if (historyFilterStatus === 'finalized') {
                grades = grades.filter(g => g.finalized === true);
            } else if (historyFilterStatus === 'non-finalized') {
                grades = grades.filter(g => !g.finalized);
            }
        }
        if (historyFilterStrategy) {
            grades = grades.filter(g => g.outcome && g.outcome.strategy === historyFilterStrategy);
        }

        if (grades.length === 0) {
            const hasFilters = historyFilterTicker || historyFilterGrade || historyFilterStatus || historyFilterStrategy;
            container.innerHTML = `
                <div class="card empty-state" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            <polyline points="17 6 23 6 23 12"/>
                        </svg>
                    </div>
                    <div class="empty-text">${hasFilters ? 'No trades match your filters' : 'No trades saved yet'}</div>
                    <div class="empty-subtext">${hasFilters ? 'Try adjusting your search criteria' : 'Start grading stocks to build your history'}</div>
                </div>
            `;
            return;
        }

        container.innerHTML = grades.map((grade, index) => {
            // Handle both old format (scores at top level) and new format (grade.scores)
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const hasPlan = grade.plan && grade.plan.entry;
            const isFinalized = grade.finalized === true;
            const gradeLetter = getGradeLetter(total);
            const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
            
            // Finalized status badge
            let statusBadge = '';
            let outcomeDisplay = '';
            if (isFinalized && grade.outcome) {
                const isWin = grade.outcome.result === 'target';
                const pnl = grade.outcome.pnlPercent;
                const pnlColor = isWin ? '#00ff00' : '#ff4444';
                const pnlIcon = isWin ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><polyline points="20 6 9 17 4 12"></polyline></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                statusBadge = `<span style="color: ${pnlColor}; font-size: 16px; margin-left: 4px;">${pnlIcon}</span>`;
                outcomeDisplay = `<span style="color: ${pnlColor}; font-weight: 600; font-size: 12px;">${isWin ? '+' : ''}${pnl.toFixed(1)}%</span>`;
            } else if (hasPlan && !isFinalized) {
                statusBadge = '<span style="color: #888; font-size: 16px; margin-left: 4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>';
            }
            
            return `
            <div class="history-item" data-index="${index}" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="showTradeDetailsModal(${index})">
                <div class="history-left">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="history-ticker">${escapeHtml(grade.ticker)}</div>
                        <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;">${gradeLetter}</span>
                        ${statusBadge}
                        ${outcomeDisplay}
                    </div>
                    ${hasPlan ? `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; font-size: 10px;">
                        <div style="text-align: center; padding: 4px; background: rgba(255, 204, 0, 0.15); border-radius: 4px;">
                            <div style="color: #ffcc00;">ENTRY</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(255, 68, 68, 0.15); border-radius: 4px; ${isFinalized && grade.outcome && grade.outcome.result === 'stop' ? 'border: 2px solid #ff4444;' : ''}">
                            <div style="color: #ff4444;">STOP</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.stopLoss.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(0, 255, 0, 0.15); border-radius: 4px; ${isFinalized && grade.outcome && grade.outcome.result === 'target' ? 'border: 2px solid #00ff00;' : ''}">
                            <div style="color: #00ff00;">TARGET</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.target.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 6px; text-align: center; font-size: 11px; color: #888;">
                        R:R <span style="color: white; font-weight: 600;">${grade.plan.riskReward}:1</span>
                        ${grade.plan.thoughts ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-left: 8px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' : ''}
                    </div>
                    ${isFinalized && grade.outcome ? `
                        <div style="margin-top: 4px; text-align: center; font-size: 10px;">
                            ${grade.outcome.strategy ? `<span style="color: #6495ed;">Strategy: ${escapeHtml(grade.outcome.strategy)}</span>` : ''}
                            ${grade.outcome.positionSize ? `<span style="color: #888; margin-left: 8px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span role="img" aria-label="Position size">${grade.outcome.positionSize} ${grade.outcome.positionUnit ?? 'shares'}</span></span>` : ''}
                        </div>
                    ` : ''}
                    ` : `
                    <div class="history-grades-grid" style="margin-top: 8px;">
                        <div class="history-grade-item">
                            <span class="history-grade-letter">P</span>
                            <span class="history-grade-value">${scores.pattern || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">R</span>
                            <span class="history-grade-value">${scores.risk || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">E</span>
                            <span class="history-grade-value">${scores.entry || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">P</span>
                            <span class="history-grade-value">${scores.performance || 0}</span>
                        </div>
                    </div>
                    `}
                </div>
                <div class="history-center">
                    <div class="history-score-value">${total}</div>
                </div>
                <div class="history-right">
                    ${grade.screenshot && grade.screenshot.startsWith('data:image/') ? `
                        <img src="${encodeURI(grade.screenshot)}" class="history-screenshot" onclick="event.stopPropagation(); showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                    ` : `
                        <div class="history-no-screenshot">No screenshot</div>
                    `}
                </div>
                <div class="history-footer">
                    <button class="delete-btn history-analyze-btn" style="flex: 1;" data-index="${index}" onclick="event.stopPropagation();">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="7.5" cy="14.5" r="1.5" fill="currentColor"/><circle cx="16.5" cy="14.5" r="1.5" fill="currentColor"/></svg>
                        Analyze
                    </button>
                    <button class="delete-btn history-delete-btn" style="flex: 1;" data-index="${index}" onclick="event.stopPropagation();">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Delete
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    const historyContainer = document.getElementById('historyContainer');
    if (historyContainer) {
        historyContainer.addEventListener('click', function (event) {
            const analyzeButton = event.target.closest('button.history-analyze-btn');
            const deleteButton = event.target.closest('button.history-delete-btn');

            if (analyzeButton && historyContainer.contains(analyzeButton)) {
                const index = parseInt(analyzeButton.getAttribute('data-index'), 10);
                if (!Number.isNaN(index)) {
                    analyzeGradeWithAI(index);
                }
            } else if (deleteButton && historyContainer.contains(deleteButton)) {
                const index = parseInt(deleteButton.getAttribute('data-index'), 10);
                if (!Number.isNaN(index)) {
                    deleteGrade(index);
                }
            }
        });
    }
    
    function viewScreenshot(gradeIdOrIndex) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        // Try to find by ID first, then fall back to index for legacy grades
        let grade = grades.find(g => g.id === gradeIdOrIndex);
        if (!grade) {
            const index = parseInt(gradeIdOrIndex, 10);
            if (!isNaN(index) && index >= 0 && index < grades.length) {
                grade = grades[index];
            }
        }
        if (grade && grade.screenshot) {
            showImageViewer(grade.screenshot);
        }
    }

    function showImageViewer(imageData) {
        const modal = document.getElementById('imageViewerModal');
        const img = document.getElementById('fullScreenImage');
        img.src = imageData;
        modal.classList.add('active');
    }

    function hideImageViewer() {
        const modal = document.getElementById('imageViewerModal');
        modal.classList.remove('active');
        document.getElementById('fullScreenImage').src = '';
    }

    // Load non-finalized trades for finalization
    function loadFinalizeView() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const container = document.getElementById('finalizeContainer');

        // Filter for non-finalized trades that have plans
        const nonFinalizedTrades = grades.filter(g => {
            const hasPlan = g.plan && g.plan.entry;
            const isFinalized = g.finalized === true;
            return hasPlan && !isFinalized;
        });

        if (nonFinalizedTrades.length === 0) {
            container.innerHTML = `
                <div class="card empty-state" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                    </div>
                    <div class="empty-text">No trades to finalize</div>
                    <div class="empty-subtext">Create and save trade plans to track their outcomes</div>
                </div>
            `;
            return;
        }

        container.innerHTML = nonFinalizedTrades.map(grade => {
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const gradeLetter = getGradeLetter(total);
            const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
            const originalIndex = grades.indexOf(grade);
            
            return `
            <div class="history-item" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="showFinalizeModal(${originalIndex})">
                <div class="history-left">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="history-ticker">${escapeHtml(grade.ticker)}</div>
                        <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;">${gradeLetter}</span>
                        <span style="color: #ffcc00; font-size: 11px;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span role="img" aria-label="Pending">Pending</span>
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; font-size: 10px;">
                        <div style="text-align: center; padding: 4px; background: rgba(255, 204, 0, 0.15); border-radius: 4px;">
                            <div style="color: #ffcc00;">ENTRY</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(255, 68, 68, 0.15); border-radius: 4px;">
                            <div style="color: #ff4444;">STOP</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.stopLoss.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(0, 255, 0, 0.15); border-radius: 4px;">
                            <div style="color: #00ff00;">TARGET</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.target.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 6px; text-align: center; font-size: 11px; color: #888;">
                        R:R <span style="color: white; font-weight: 600;">${grade.plan.riskReward}:1</span>
                    </div>
                </div>
                <div class="history-center">
                    <div class="history-score-value">${total}</div>
                </div>
                <div class="history-right">
                    ${grade.screenshot && grade.screenshot.startsWith('data:image/') ? `
                        <img src="${encodeURI(grade.screenshot)}" class="history-screenshot" onclick="event.stopPropagation(); showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                    ` : `
                        <div class="history-no-screenshot">No screenshot</div>
                    `}
                </div>
            </div>
        `;
        }).join('');
    }

    // Show finalize modal with reject/accept options
    function showFinalizeModal(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        
        if (!grade) return;
        
        currentFinalizeTradeIndex = index;
        const modal = document.getElementById('finalizeTradeModal');
        document.getElementById('finalizeModalTicker').textContent = grade.ticker;
        
        // Show initial choice: Reject or Accept
        document.getElementById('finalizeModalContent').innerHTML = `
            <div style="text-align: center; padding: 16px 0;">
                <p style="margin-bottom: 16px; line-height: 1.5;">Did you execute this trade?</p>
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">TRADE PLAN</div>
                    <div style="display: flex; justify-content: space-around; font-size: 12px;">
                        <div><span style="color: #ffcc00;">Entry:</span> $${grade.plan.entry.toFixed(2)}</div>
                        <div><span style="color: #ff4444;">Stop:</span> $${grade.plan.stopLoss.toFixed(2)}</div>
                        <div><span style="color: #00ff00;">Target:</span> $${grade.plan.target.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('finalizeModalButtons').innerHTML = `
            <button class="modal-btn" onclick="rejectTrade()" style="flex: 1; background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Rejected (Not Taken)
            </button>
            <button class="modal-btn modal-btn-confirm" onclick="showAcceptForm()" style="flex: 1;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Accepted (Executed)
            </button>
        `;
        
        modal.classList.add('active');
    }

    function hideFinalizeModal() {
        document.getElementById('finalizeTradeModal').classList.remove('active');
        currentFinalizeTradeIndex = null;
    }

    // Reject trade - delete it from the journal
    function rejectTrade() {
        if (currentFinalizeTradeIndex === null) return;
        
        if (!confirm('Are you sure you want to reject this trade? It will be deleted from your journal.')) {
            return;
        }
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        grades.splice(currentFinalizeTradeIndex, 1);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        showToast(`Trade plan deleted`, 'info', `${grade.ticker} Rejected`, 4000, 'history');
        hideFinalizeModal();
        loadFinalizeView();
    }

    // Show form to accept trade and enter details
    function showAcceptForm() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        if (!grade) return;
        
        document.getElementById('finalizeModalContent').innerHTML = `
            <div style="margin-bottom: 12px;">
                <label class="label-text">Which target was satisfied?</label>
                <div style="display: flex; gap: 8px; margin-top: 4px;">
                    <button id="stopLossBtn" class="modal-btn" onclick="selectOutcome('stop')" aria-label="Select Stop Loss" style="flex: 1; background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Stop Loss<br>
                        <span style="font-size: 10px;">$${grade.plan.stopLoss.toFixed(2)} (-${grade.plan.stopPercent}%)</span>
                    </button>
                    <button id="targetBtn" class="modal-btn modal-btn-confirm" onclick="selectOutcome('target')" aria-label="Select Profit Target" style="flex: 1;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 8v8m-4-4h8"></path>
                        </svg>
                        Profit Target<br>
                        <span style="font-size: 10px;">$${grade.plan.target.toFixed(2)} (+${grade.plan.targetPercent}%)</span>
                    </button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                    <label class="label-text">Position Size</label>
                    <input type="number" id="positionSizeInput" class="ticker-input" placeholder="e.g., 100" min="1" style="text-transform: none; font-size: 12px; padding: 8px;">
                </div>
                <div>
                    <label class="label-text">Unit</label>
                    <select id="positionUnitSelect" class="ticker-input" style="text-transform: none; font-size: 12px; padding: 8px; cursor: pointer;">
                        <option value="shares">Shares</option>
                        <option value="contracts">Contracts</option>
                        <option value="lots">Lots</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 12px;">
                <label class="label-text">Strategy Used</label>
                <textarea id="strategyInput" class="ticker-input" placeholder="e.g., 52w High Breakout, Support Bounce, etc." style="text-transform: none; font-size: 12px; min-height: 60px; resize: vertical;"></textarea>
            </div>
            <input type="hidden" id="selectedOutcome" value="">
        `;
        
        document.getElementById('finalizeModalButtons').innerHTML = `
            <button class="modal-btn modal-btn-cancel" onclick="showFinalizeModal(${currentFinalizeTradeIndex})">
                Back
            </button>
            <button class="modal-btn modal-btn-confirm" onclick="acceptTrade()">
                Finalize Trade
            </button>
        `;
    }

    function selectOutcome(outcome) {
        document.getElementById('selectedOutcome').value = outcome;
        
        // Visual feedback
        const stopBtn = document.getElementById('stopLossBtn');
        const targetBtn = document.getElementById('targetBtn');
        
        if (outcome === 'stop') {
            stopBtn.style.border = '2px solid #ff4444';
            stopBtn.style.background = 'rgba(255, 68, 68, 0.3)';
            targetBtn.style.border = '1px solid rgba(0, 255, 0, 0.3)';
            targetBtn.style.background = 'rgba(0, 255, 0, 0.2)';
        } else {
            targetBtn.style.border = '2px solid #00ff00';
            targetBtn.style.background = 'rgba(0, 255, 0, 0.3)';
            stopBtn.style.border = '1px solid rgba(255, 68, 68, 0.3)';
            stopBtn.style.background = 'rgba(255, 68, 68, 0.2)';
        }
    }

    // Accept trade and finalize with outcome
    function acceptTrade() {
        if (currentFinalizeTradeIndex === null) return;
        
        const outcome = document.getElementById('selectedOutcome').value;
        const strategy = document.getElementById('strategyInput').value.trim();
        const positionSize = document.getElementById('positionSizeInput').value.trim();
        const positionUnit = document.getElementById('positionUnitSelect').value;
        
        if (!outcome) {
            showToast('Please select which target was satisfied', 'warning', 'Missing Information');
            return;
        }
        
        if (!strategy) {
            showToast('Please enter the strategy you used', 'warning', 'Missing Strategy');
            return;
        }
        
        const parsedPositionSize = parseFloat(positionSize);
        if (!positionSize || isNaN(parsedPositionSize) || parsedPositionSize <= 0) {
            showToast('Please enter a valid position size', 'warning', 'Missing Position Size');
            return;
        }
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        // Calculate P&L
        const entryPrice = grade.plan.entry;
        const exitPrice = outcome === 'stop' ? grade.plan.stopLoss : grade.plan.target;
        const pnlPercent = outcome === 'stop' ? -grade.plan.stopPercent : grade.plan.targetPercent;
        
        // Update grade with finalization data
        grade.finalized = true;
        grade.finalizedAt = new Date().toISOString();
        grade.outcome = {
            result: outcome,
            exitPrice: exitPrice,
            pnlPercent: pnlPercent,
            strategy: strategy,
            positionSize: parsedPositionSize,
            positionUnit: positionUnit
        };
        
        grades[currentFinalizeTradeIndex] = grade;
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        const outcomeText = outcome === 'stop' ? `Loss: -${grade.plan.stopPercent}%` : `Win: +${grade.plan.targetPercent}%`;
        showToast(`Exit: $${exitPrice.toFixed(2)} | ${outcomeText}<br>Strategy: ${strategy}<br>Position: ${parsedPositionSize} ${positionUnit}`, 'success', `${grade.ticker} Trade Finalized`, 5000, 'history');
        
        hideFinalizeModal();
        loadFinalizeView();
        if (typeof loadHistory === 'function') {
            loadHistory();
        }
    }


    function analyzeGradeWithAI(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        if (grade) {
            // Handle both old format (scores at top level) and new format (grade.scores)
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const hasPlan = grade.plan && grade.plan.entry;
            
            // Set the prompt value directly since DOM is already loaded
            const aiPrompt = document.getElementById('aiPrompt');
            if (aiPrompt) {
                let prompt = `Analyze this trade grade for ${grade.ticker}:\nTotal Score: ${total}/100\nPattern: ${scores.pattern || 0}/20\nRisk/Reward: ${scores.risk || 0}/20\nEntry/Exit: ${scores.entry || 0}/10\nPast Performance: ${scores.performance || 0}/10\nTiming: ${scores.time || 0}/20\nCatalyst: ${scores.catalyst || 0}/10\nEnvironment: ${scores.environment || 0}/10`;
                
                if (hasPlan) {
                    prompt += `\n\nTrade Plan:\nEntry: $${grade.plan.entry.toFixed(2)}\nStop Loss: $${grade.plan.stopLoss.toFixed(2)} (${grade.plan.stopPercent}%)\nTarget: $${grade.plan.target.toFixed(2)} (${grade.plan.targetPercent}%)\nRisk/Reward Ratio: ${grade.plan.riskReward}:1`;
                }
                
                prompt += '\n\nProvide insights and suggestions for improvement.';
                aiPrompt.value = prompt;
            }
            switchView('ai');
        }
    }

    function deleteGrade(index) {
        if (!confirm('Delete this grade?')) return;
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.splice(index, 1);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        loadHistory();
    }

    // Ticker Modal functions
    function showTickerModal() {
        document.getElementById('tickerModal').classList.add('active');
        document.getElementById('tickerModalInput').value = '';
        document.getElementById('tickerModalInput').focus();
    }

    function hideTickerModal() {
        document.getElementById('tickerModal').classList.remove('active');
    }

    function confirmTickerAnalysis() {
        const ticker = document.getElementById('tickerModalInput').value.trim().toUpperCase();
        if (ticker) {
            document.getElementById('aiPrompt').value = `Analyze ${ticker} for trading:\n- Technical setup quality\n- Key support/resistance levels\n- Recent price action\n- Volume analysis\n- Risk/reward for entry today\n\nProvide a PREPARE score estimate.`;
            hideTickerModal();
        }
    }

    // Trade Details Modal functions
    function showTradeDetailsModal(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        
        if (!grade) return;
        
        const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
        const total = grade.total || (grade.grade ? grade.grade.total : 0);
        const hasPlan = grade.plan && grade.plan.entry;
        const isFinalized = grade.finalized === true;
        const gradeLetter = getGradeLetter(total);
        const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
        
        // Build the modal content
        let content = `
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 12px;">
                    <span style="font-size: 24px; font-weight: 700; color: white;">${escapeHtml(grade.ticker)}</span>
                    <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 4px 12px; border-radius: 8px; font-size: 14px; font-weight: 700;">${gradeLetter} - ${total}/100</span>
                </div>
                <div style="font-size: 10px; color: #888; text-align: center;">
                    ${new Date(grade.timestamp).toLocaleString()}
                </div>
            </div>
        `;
        
        // Add finalized status if applicable
        if (isFinalized && grade.outcome) {
            const isWin = grade.outcome.result === 'target';
            const pnl = grade.outcome.pnlPercent;
            const pnlColor = isWin ? '#00ff00' : '#ff4444';
            const statusText = isWin ? 'WIN' : 'LOSS';
            
            content += `
                <div style="background: ${isWin ? 'rgba(0, 255, 0, 0.15)' : 'rgba(255, 68, 68, 0.15)'}; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid ${pnlColor};">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: ${pnlColor}; font-weight: 700; margin-bottom: 4px;">${statusText}: ${isWin ? '+' : ''}${pnl.toFixed(1)}%</div>
                        <div style="font-size: 11px; color: #888;">Exit Price: $${grade.outcome.exitPrice.toFixed(2)}</div>
                        <div style="font-size: 11px; color: #888;">Finalized: ${new Date(grade.finalizedAt).toLocaleString()}</div>
                    </div>
                </div>
            `;
        } else if (hasPlan && !isFinalized) {
            content += `
                <div style="background: rgba(255, 204, 0, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(255, 204, 0, 0.3);">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: #ffcc00; font-weight: 700;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span role="img" aria-label="Pending">PENDING FINALIZATION</span>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">Visit "Finalize Trades" to record the outcome</div>
                    </div>
                </div>
            `;
        }
        
        // Add PREPARE scores
        content += `
            <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">PREPARE Scores</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                    <div><span style="color: #cc0000; font-weight: 600;">P</span> Pattern: <span style="color: white;">${scores.pattern || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">R</span> Risk: <span style="color: white;">${scores.risk || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">E</span> Entry: <span style="color: white;">${scores.entry || 0}/10</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">P</span> Performance: <span style="color: white;">${scores.performance || 0}/10</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">A</span> Timing: <span style="color: white;">${scores.time || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">R</span> Catalyst: <span style="color: white;">${scores.catalyst || 0}/10</span></div>
                    <div style="grid-column: 1 / -1;"><span style="color: #cc0000; font-weight: 600;">E</span> Environment: <span style="color: white;">${scores.environment || 0}/10</span></div>
                </div>
            </div>
        `;
        
        // Add trade plan if available
        if (hasPlan) {
            content += `
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">Trade Plan</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="text-align: center; padding: 8px; background: rgba(255, 204, 0, 0.15); border-radius: 6px;">
                            <div style="color: #ffcc00; font-size: 10px;">ENTRY</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(255, 68, 68, 0.15); border-radius: 6px; ${isFinalized && grade.outcome && grade.outcome.result === 'stop' ? 'border: 2px solid #ff4444;' : ''}">
                            <div style="color: #ff4444; font-size: 10px;">STOP</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.stopLoss.toFixed(2)}</div>
                            <div style="color: #ff4444; font-size: 9px;">${grade.plan.stopPercent}%</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(0, 255, 0, 0.15); border-radius: 6px; ${isFinalized && grade.outcome && grade.outcome.result === 'target' ? 'border: 2px solid #00ff00;' : ''}">
                            <div style="color: #00ff00; font-size: 10px;">TARGET</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.target.toFixed(2)}</div>
                            <div style="color: #00ff00; font-size: 9px;">${grade.plan.targetPercent}%</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: rgba(100, 149, 237, 0.15); border-radius: 6px;">
                        <span style="color: #6495ed; font-size: 10px;">RISK/REWARD RATIO: </span>
                        <span style="color: white; font-weight: 600; font-size: 14px;">${grade.plan.riskReward}:1</span>
                    </div>
                </div>
            `;
            
            // Add strategy and position size if finalized
            if (isFinalized && grade.outcome) {
                if (grade.outcome.strategy || grade.outcome.positionSize) {
                    content += `
                        <div style="background: rgba(100, 149, 237, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            ${grade.outcome.strategy ? `
                                <div style="margin-bottom: ${grade.outcome.positionSize ? '8px' : '0'};">
                                    <div style="font-weight: 600; margin-bottom: 4px; color: #6495ed; font-size: 11px;">STRATEGY USED</div>
                                    <div style="font-size: 12px; line-height: 1.5; color: #e0e0e0;">${escapeHtml(grade.outcome.strategy)}</div>
                                </div>
                            ` : ''}
                            ${grade.outcome.positionSize ? `
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px; color: #6495ed; font-size: 11px;">POSITION SIZE</div>
                                    <div style="font-size: 12px; line-height: 1.5; color: #e0e0e0;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                            <rect x="3" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="14" width="7" height="7"></rect>
                                            <rect x="3" y="14" width="7" height="7"></rect>
                                        </svg>
                                        <span role="img" aria-label="Position size">${grade.outcome.positionSize} ${grade.outcome.positionUnit ?? 'shares'}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            // Add trade thoughts if available
            if (grade.plan.thoughts) {
                content += `
                    <div style="background: rgba(100, 149, 237, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #6495ed; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Trade Thoughts</span>
                        </div>
                        <div style="font-size: 11px; line-height: 1.5; color: #e0e0e0; white-space: pre-wrap;">${escapeHtml(grade.plan.thoughts)}</div>
                    </div>
                `;
            }
        }
        
        // Add screenshot if available
        if (grade.screenshot && grade.screenshot.startsWith('data:image/')) {
            content += `
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">Screenshot</div>
                    <img src="${encodeURI(grade.screenshot)}" style="width: 100%; border-radius: 6px; cursor: pointer;" onclick="showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                </div>
            `;
        }
        
        document.getElementById('tradeDetailsTitle').textContent = `${grade.ticker} - Trade Details`;
        document.getElementById('tradeDetailsContent').innerHTML = content;
        document.getElementById('tradeDetailsModal').classList.add('active');
    }

    function hideTradeDetailsModal() {
        document.getElementById('tradeDetailsModal').classList.remove('active');
    }

    // AI Assistant functions
    async function saveToken() {
        const token = document.getElementById('githubToken').value.trim();
        if (token) {
            localStorage.setItem('githubToken', token);
            showToast('Token saved, fetching available models...', 'success', 'Token Saved');
            await fetchAvailableModels(token);
        }
    }

    function loadToken() {
        const token = localStorage.getItem('githubToken');
        if (token) {
            document.getElementById('githubToken').value = token;
            // Fetch models on load if token exists
            fetchAvailableModels(token);
        }
    }

    async function fetchAvailableModels(token) {
        try {
            const response = await fetch('https://api.github.com/models', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github+json',
                    'X-GitHub-Api-Version': '2022-11-28'
                }
            });

            if (response.ok) {
                const models = await response.json();
                const modelNames = models.map(m => m.name || m.id).join(', ');
                console.log('Available models:', modelNames);
                showToast(`${models.length} models available: ${modelNames.substring(0, 100)}...`, 'info', 'Models Loaded', 8000);
                localStorage.setItem('availableModels', JSON.stringify(models));
            } else {
                console.warn('Could not fetch models:', response.status);
                showToast('Token saved, but could not fetch models list', 'warning', 'Limited Access');
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            // Don't show error to user, token still works for chat
        }
    }

    async function askAI() {
        const token = localStorage.getItem('githubToken');
        const prompt = document.getElementById('aiPrompt').value.trim();
        
        if (!token) {
            showToast('Please enter and save your GitHub token first', 'warning', 'Token Required');
            return;
        }
        
        if (!prompt) {
            showToast('Please enter a question or prompt', 'warning', 'Missing Prompt');
            return;
        }

        const responseCard = document.getElementById('aiResponseCard');
        const responseDiv = document.getElementById('aiResponse');
        
        responseCard.style.display = 'block';
        responseDiv.textContent = 'Thinking...';

        try {
            const response = await fetch(CONFIG.API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    model: CONFIG.AI_MODEL,
                    messages: [
                        {
                            role: 'system',
                            content: `You are an expert trading analyst with deep knowledge of technical analysis, fundamental analysis, and market dynamics. 

Your expertise includes:
- Technical patterns (breakouts, reversals, support/resistance)
- Risk management and position sizing
- Entry/exit timing and strategy development
- Market psychology and sentiment analysis
- Current market conditions and sector rotation
- Real-time news impact on stock movements

When analyzing trades:
1. Be specific and actionable - provide exact levels, percentages, and concrete steps
2. Consider current market environment and sentiment
3. Reference relevant technical indicators and patterns
4. Suggest specific risk management rules
5. Provide both bullish and bearish scenarios
6. Keep responses detailed but organized with clear sections

Format your responses with:
- Key findings at the top
- Detailed analysis in the middle
- Actionable recommendations at the bottom

Be direct, professional, and avoid generic advice. Treat this as real money at stake.`
                        },
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    max_tokens: CONFIG.AI_MAX_TOKENS,
                    temperature: CONFIG.AI_TEMPERATURE
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                throw new Error(`API Error: ${response.status} - ${errorData}`);
            }

            const data = await response.json();
            const aiMessage = data.choices[0].message.content;
            
            // Add to chat history
            addChatMessage('user', prompt);
            addChatMessage('assistant', aiMessage);
            
            responseCard.style.display = 'block';
            responseDiv.textContent = aiMessage;
            document.getElementById('aiPrompt').value = '';
        } catch (error) {
            console.error('AI request failed:', error);
            responseDiv.textContent = 'An error occurred while contacting the AI service. Make sure your GitHub token has access to GitHub Models and try again.';
        }
    }

    function addChatMessage(role, content) {
        const chatMessages = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.style.cssText = `padding: 6px 8px; margin-bottom: 6px; border-radius: 6px; ${role === 'user' ? 'background: #333; margin-left: 20%;' : 'background: #1a1a1a; margin-right: 20%;'}`;
        
        // Security: Use DOM methods instead of innerHTML to prevent XSS
        const strong = document.createElement('strong');
        strong.style.color = role === 'user' ? '#cc0000' : '#00ff00';
        strong.textContent = role === 'user' ? 'You: ' : 'AI: ';
        msgDiv.appendChild(strong);
        
        const previewLength = CONFIG.CHAT_MESSAGE_PREVIEW_LENGTH;
        const textNode = document.createTextNode(content.substring(0, previewLength) + (content.length > previewLength ? '...' : ''));
        msgDiv.appendChild(textNode);
        
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        chatHistory.push({ role, content });
    }

    function clearChat() {
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.textContent = '';
        }
        chatHistory = [];
    }

    // Quick action functions
    function reviewGrades() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        if (grades.length === 0) {
            showToast('No grades to review. Save some grades first!', 'info', 'No Grades');
            return;
        }
        
        const summary = grades.slice(0, CONFIG.MAX_GRADES_FOR_REVIEW).map(g => `${g.ticker}: ${g.total}/100`).join(', ');
        document.getElementById('aiPrompt').value = `Review my recent trades and provide insights:\n${summary}\n\nAnalyze patterns, identify strengths/weaknesses, and suggest improvements.`;
    }

    function findPatterns() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        if (grades.length < 2) {
            showToast('Need at least 2 grades to find patterns. Keep grading!', 'info', 'More Data Needed');
            return;
        }
        
        const data = grades.slice(0, CONFIG.MAX_GRADES_FOR_PATTERNS).map(g => ({
            ticker: g.ticker,
            total: g.total,
            pattern: g.scores.pattern,
            risk: g.scores.risk,
            catalyst: g.scores.catalyst
        }));
        
        document.getElementById('aiPrompt').value = `Find patterns in my trading grades:\n${JSON.stringify(data, null, 2)}\n\nIdentify what makes my high-scoring trades different from low-scoring ones.`;
    }

    function getSentiment() {
        document.getElementById('aiPrompt').value = `What is the current market sentiment? Consider:\n- Major indices (SPY, QQQ, DIA)\n- VIX levels\n- Sector rotation\n- Recent market news\n\nProvide a brief actionable summary for day trading.`;
    }

    // Refresh service worker only (not local storage or settings)
    function refreshServiceWorker() {
        toggleMenu();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(function(registration) {
                if (registration) {
                    registration.update().then(function() {
                        // Force the waiting service worker to become active
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        // Clear caches to get fresh frontend assets
                        caches.keys().then(function(cacheNames) {
                            return Promise.all(
                                cacheNames.map(function(cacheName) {
                                    return caches.delete(cacheName);
                                })
                            );
                        }).then(function() {
                            window.location.reload();
                        }).catch(function() {
                            window.location.reload();
                        });
                    });
                } else {
                    window.location.reload();
                }
            }).catch(function() {
                window.location.reload();
            });
        } else {
            window.location.reload();
        }
    }

    // Initialize on load - set up all event listeners and initialize UI
    window.onload = function() {
        // Initialize sliders
        updateSlider('pattern', 10, 20);
        updateSlider('risk', 10, 20);
        updateSlider('entry', 5, 10);
        updateSlider('performance', 5, 10);
        updateSlider('time', 10, 20);
        updateSlider('catalyst', 5, 10);
        updateSlider('environment', 5, 10);
        
        // Set up screenshot event listeners
        const screenshotInput = document.getElementById('screenshotInput');
        const addScreenshotBtn = document.getElementById('addScreenshotBtn');
        const clearScreenshotBtn = document.getElementById('clearScreenshotBtn');
        
        if (screenshotInput) {
            screenshotInput.addEventListener('change', function() {
                handleScreenshot(this);
            });
        }
        
        if (addScreenshotBtn) {
            addScreenshotBtn.addEventListener('click', function() {
                screenshotInput.click();
            });
        }
        
        if (clearScreenshotBtn) {
            clearScreenshotBtn.addEventListener('click', clearScreenshot);
        }
        
        // Set up ticker modal keyboard handling
        const tickerModalInput = document.getElementById('tickerModalInput');
        if (tickerModalInput) {
            tickerModalInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmTickerAnalysis();
                }
            });
        }
        
        // Close modal on overlay click
        const tickerModal = document.getElementById('tickerModal');
        if (tickerModal) {
            tickerModal.addEventListener('click', function(e) {
                if (e.target === tickerModal) {
                    hideTickerModal();
                }
            });
        }
        
        // Close trade details modal on overlay click
        const tradeDetailsModal = document.getElementById('tradeDetailsModal');
        if (tradeDetailsModal) {
            tradeDetailsModal.addEventListener('click', function(e) {
                if (e.target === tradeDetailsModal) {
                    hideTradeDetailsModal();
                }
            });
        }
        
        // Close finalize modal on overlay click
        const finalizeTradeModal = document.getElementById('finalizeTradeModal');
        if (finalizeTradeModal) {
            finalizeTradeModal.addEventListener('click', function(e) {
                if (e.target === finalizeTradeModal) {
                    hideFinalizeModal();
                }
            });
        }
        
        // Close image viewer on overlay click
        const imageViewerModal = document.getElementById('imageViewerModal');
        if (imageViewerModal) {
            imageViewerModal.addEventListener('click', function(e) {
                if (e.target === imageViewerModal) {
                    hideImageViewer();
                }
            });
        }
        
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('system/js.on/sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                    showToast('Some offline features may not be available. You can continue using the app online.', 'warning', 'Offline Mode Limited');
                });
        }
    };
</script>
</body>
</html>
