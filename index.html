<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-navbutton-color" content="#000000">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="manifest" href="system/js.on/manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23cc0000'/%3E%3Cpath d='M8 10h6v2H8v-2zm0 4h8v2H8v-2zm0 4h10v2H8v-2z' fill='%23ff6666'/%3E%3Ccircle cx='22' cy='12' r='4' fill='%2300ff00'/%3E%3Cpath d='M22 10v4m-2-2h4' stroke='white' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="system/img/icon-192.png">
    <title>PREPARE Trading Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    html {
        background: #000000;
        height: 100%;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        min-height: 100vh;
        min-height: 100dvh;
        color: #e0e0e0;
        -webkit-font-smoothing: antialiased;
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
    }

    .header {
        background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
        color: white;
        padding: 12px 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid #cc0000;
    }

    .header-title {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .logo {
        width: 32px;
        height: 32px;
    }

    .header h1 {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .hamburger {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .hamburger:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .hamburger-icon {
        width: 24px;
        height: 2px;
        background: white;
        display: block;
        position: relative;
        transition: all 0.3s;
    }

    .hamburger-icon::before,
    .hamburger-icon::after {
        content: '';
        width: 24px;
        height: 2px;
        background: white;
        position: absolute;
        left: 0;
        transition: all 0.3s;
    }

    .hamburger-icon::before {
        top: -8px;
    }

    .hamburger-icon::after {
        top: 8px;
    }

    .hamburger.active .hamburger-icon {
        background: transparent;
    }

    .hamburger.active .hamburger-icon::before {
        transform: rotate(45deg);
        top: 0;
    }

    .hamburger.active .hamburger-icon::after {
        transform: rotate(-45deg);
        top: 0;
    }

    .side-menu {
        position: fixed;
        top: 0;
        left: 0;
        width: 280px;
        height: 100vh;
        background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 60;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.8);
        border-right: 2px solid #cc0000;
        padding-top: env(safe-area-inset-top);
    }

    .side-menu.active {
        transform: translateX(0);
    }

    .menu-header {
        padding: 12px 12px;
        position: sticky;
        top: 0;
        border-bottom: 1px solid #333;
    }

    .menu-logo {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 4px;
    }

    .menu-logo .logo {
        width: 42px;
        height: 42px;
    }

    .menu-title {
        font-weight: 700;
        font-size: 14px;
        color: white;
        line-height: 1.3;
    }

    .menu-subtitle {
        font-size: 10px;
        color: #888;
        line-height: 1.3;
    }

    .menu-nav {
        padding: 16px 12px;
    }

    .menu-btn {
        width: 100%;
        padding: 12px 14px;
        background: none;
        border: none;
        color: #b0b0b0;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        border-radius: 10px;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .menu-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.1), transparent);
        transition: left 0.5s ease;
    }
    
    .menu-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        transform: translateX(4px);
        box-shadow: inset 3px 0 0 rgba(204, 0, 0, 0.5);
    }
    
    .menu-btn:hover::before {
        left: 100%;
    }
    
    .menu-btn.active {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
        box-shadow: 0 4px 16px rgba(204, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateX(6px);
    }

    .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 55;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    .overlay.active {
        opacity: 1;
        pointer-events: all;
    }

    .container {
        padding: 10px 10px 0 10px;
        max-width: 480px;
        margin: 0 auto;
    }

    .card {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%);
        border-radius: 12px;
        padding: 12px 14px;
        margin-bottom: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 
                    0 2px 8px rgba(204, 0, 0, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.1), transparent);
        transition: left 0.6s ease;
    }
    
    .card:hover {
        transform: translateY(-4px) scale(1.01);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6), 
                    0 4px 16px rgba(204, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border-color: rgba(204, 0, 0, 0.3);
    }
    
    .card:hover::before {
        left: 100%;
    }

    .ticker-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(26, 26, 26, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        text-transform: uppercase;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .ticker-input:focus {
        outline: none;
        border-color: #cc0000;
        background: rgba(13, 13, 13, 0.9);
        box-shadow: 0 0 0 4px rgba(204, 0, 0, 0.15),
                    inset 0 2px 4px rgba(0, 0, 0, 0.4),
                    0 4px 16px rgba(204, 0, 0, 0.3);
        transform: scale(1.02);
    }
    
    .ticker-input::placeholder {
        color: #555;
    }

    .score-display {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        color: white;
        box-shadow: 0 8px 32px rgba(204, 0, 0, 0.5),
                    0 0 40px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.2);
        transition: all 0.4s ease;
        position: relative;
        overflow: hidden;
    }
    
    .score-display::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, transparent 60%);
        animation: scoreGlow 8s ease-in-out infinite;
    }
    
    @keyframes scoreGlow {
        0%, 100% { transform: translate(0, 0) scale(1); }
        50% { transform: translate(-20%, -20%) scale(1.2); }
    }
    
    .score-display:hover {
        transform: scale(1.05);
        box-shadow: 0 12px 48px rgba(204, 0, 0, 0.7),
                    0 0 60px rgba(204, 0, 0, 0.3),
                    inset 0 2px 0 rgba(255, 255, 255, 0.3);
    }

    .score-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 4px;
    }

    .score-value {
        font-size: 36px;
        font-weight: 700;
        line-height: 1;
    }

    .score-max {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 4px;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-fill {
        height: 100%;
        background: white;
        border-radius: 6px;
        transition: width 0.3s ease;
    }

    .card-title {
        font-size: 12px;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #333;
    }

    .slider-group {
        margin-bottom: 14px;
    }

    .slider-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2px;
    }

    .slider-label {
        flex: 1;
    }

    .slider-title {
        font-weight: 600;
        color: #e0e0e0;
        font-size: 13px;
        margin-bottom: 0;
    }

    .slider-subtitle {
        font-size: 9px;
        color: #888;
        display: none;
    }

    .slider-value {
        font-size: 16px;
        font-weight: 700;
        color: #cc0000;
        min-width: 32px;
        text-align: right;
    }

    .slider {
        width: 100%;
        height: 6px;
        border-radius: 6px;
        background: #1a1a1a;
        outline: none;
        -webkit-appearance: none;
        cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #cc0000 0%, #ff3333 100%);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(204, 0, 0, 0.4);
    }

    .slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: linear-gradient(135deg, #cc0000 0%, #ff3333 100%);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(204, 0, 0, 0.4);
    }

    .slider-range {
        display: none;
    }

    .save-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 20px rgba(204, 0, 0, 0.4), 
                    0 2px 8px rgba(204, 0, 0, 0.3),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .save-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s ease, height 0.6s ease;
    }
    
    .save-btn:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 32px rgba(204, 0, 0, 0.6),
                    0 4px 16px rgba(204, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
        filter: brightness(1.1);
    }
    
    .save-btn:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .save-btn:active {
        transform: scale(0.97);
        box-shadow: 0 2px 12px rgba(204, 0, 0, 0.4);
    }

    .history-item {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 12px;
        align-items: center;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                    0 2px 8px rgba(204, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.05);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .history-item::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(204, 0, 0, 0.08) 0%, transparent 70%);
        opacity: 0;
        transition: opacity 0.6s ease, transform 0.6s ease;
        pointer-events: none;
    }
    
    .history-item:hover {
        transform: translateY(-6px) scale(1.02);
        border-color: rgba(204, 0, 0, 0.3);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
                    0 8px 20px rgba(204, 0, 0, 0.25),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1),
                    0 0 40px rgba(204, 0, 0, 0.15);
    }
    
    .history-item:hover::before {
        opacity: 1;
        transform: scale(1.1) rotate(45deg);
    }
    
    .history-item:active {
        transform: translateY(-2px) scale(0.99);
    }

    .history-left {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .history-ticker {
        font-size: 18px;
        font-weight: 700;
        color: white;
    }

    .history-grades-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
        font-size: 11px;
    }

    .history-grade-item {
        display: flex;
        align-items: center;
        gap: 4px;
        color: #b0b0b0;
    }

    .history-grade-letter {
        font-weight: 700;
        color: #cc0000;
        font-size: 12px;
    }

    .history-grade-value {
        color: #e0e0e0;
        font-weight: 600;
    }

    .history-center {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 8px;
    }

    .history-score-value {
        font-size: 48px;
        font-weight: 700;
        color: white;
        line-height: 1;
    }

    .history-right {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .history-screenshot {
        width: 100%;
        max-width: 120px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .history-screenshot::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 8px;
        background: linear-gradient(135deg, rgba(204, 0, 0, 0.2), rgba(204, 0, 0, 0.05));
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
    }
    
    .history-screenshot:hover {
        border-color: rgba(204, 0, 0, 0.5);
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 12px 32px rgba(204, 0, 0, 0.4),
                    0 0 20px rgba(204, 0, 0, 0.2);
        filter: brightness(1.1) saturate(1.2);
    }
    
    .history-screenshot:hover::after {
        opacity: 1;
    }

    .history-no-screenshot {
        width: 100%;
        max-width: 120px;
        height: 80px;
        border-radius: 6px;
        border: 1px dashed #333;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
        font-size: 10px;
    }

    .history-footer {
        grid-column: 1 / -1;
        display: flex;
        gap: 6px;
        margin-top: 8px;
    }

    .delete-btn {
        width: 100%;
        padding: 8px;
        background: rgba(204, 0, 0, 0.1);
        color: #cc0000;
        border: 1px solid rgba(204, 0, 0, 0.3);
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .delete-btn:hover {
        background: rgba(204, 0, 0, 0.2);
    }

    .empty-state {
        text-align: center;
        padding: 40px 16px;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .empty-text {
        color: #666;
        font-size: 14px;
        margin-bottom: 6px;
    }

    .empty-subtext {
        color: #555;
        font-size: 11px;
    }

    .label-text {
        display: block;
        font-size: 10px;
        font-weight: 600;
        color: #b0b0b0;
        margin-bottom: 4px;
    }

    .icon-svg {
        width: 16px;
        height: 16px;
    }

    /* iOS 26 Liquid Glass Style Modal */
    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .modal-overlay.active {
        display: flex;
    }

    .modal-content {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.95) 0%, rgba(25, 25, 25, 0.98) 100%);
        border-radius: 24px;
        padding: 28px;
        width: 100%;
        max-width: 320px;
        box-shadow: 0 32px 64px rgba(0, 0, 0, 0.6), 
                    0 8px 24px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1),
                    inset 0 -1px 0 rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .modal-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.5), transparent);
        animation: modalShimmer 2s ease-in-out infinite;
        pointer-events: none;
    }
    
    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    @keyframes modalShimmer {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.8; }
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: white;
        text-align: center;
        margin-bottom: 16px;
    }

    .modal-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        color: white;
        font-size: 16px;
        text-transform: uppercase;
        margin-bottom: 16px;
        outline: none;
        transition: all 0.2s;
    }

    .modal-input:focus {
        border-color: rgba(204, 0, 0, 0.6);
        background: rgba(0, 0, 0, 0.6);
    }

    .modal-input::placeholder {
        color: #666;
        text-transform: none;
    }

    .modal-buttons {
        display: flex;
        gap: 10px;
    }

    .modal-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
    }

    .modal-btn-confirm {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
    }

    .modal-btn:active {
        transform: scale(0.98);
    }

    .btn-icon {
        width: 14px;
        height: 14px;
        vertical-align: middle;
        margin-right: 4px;
    }

    .compact-card {
        padding: 10px 12px;
    }

    /* Trade plan slider styles */
    #stopLoss-slider::-webkit-slider-thumb {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%) !important;
        box-shadow: 0 2px 6px rgba(255, 68, 68, 0.4) !important;
    }

    #profitTarget-slider::-webkit-slider-thumb {
        background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%) !important;
        box-shadow: 0 2px 6px rgba(0, 255, 0, 0.4) !important;
    }

    #stopLoss-slider::-moz-range-thumb {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%) !important;
        box-shadow: 0 2px 6px rgba(255, 68, 68, 0.4) !important;
    }

    #profitTarget-slider::-moz-range-thumb {
        background: linear-gradient(135deg, #00ff00 0%, #00aa00 100%) !important;
        box-shadow: 0 2px 6px rgba(0, 255, 0, 0.4) !important;
    }

    /* Glass card animation */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    /* Entry price input style */
    #entryPriceInput {
        background: rgba(255, 204, 0, 0.1);
        border-color: rgba(255, 204, 0, 0.3);
    }

    #entryPriceInput:focus {
        border-color: #ffcc00;
        box-shadow: 0 0 10px rgba(255, 204, 0, 0.2);
    }

    /* History filter select */
    #historyGradeFilter {
        background: #1a1a1a;
        cursor: pointer;
    }

    #historyGradeFilter option {
        background: #1a1a1a;
        color: #e0e0e0;
    }

    /* Toast Notification Styles */
    .toast-container {
        position: fixed;
        top: 70px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 200;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
        width: 90%;
        max-width: 400px;
    }

    .toast {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.95) 0%, rgba(25, 25, 25, 0.98) 100%);
        backdrop-filter: blur(30px);
        -webkit-backdrop-filter: blur(30px);
        border-radius: 18px;
        padding: 18px 22px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 
                    0 5px 15px rgba(204, 0, 0, 0.2),
                    inset 0 2px 0 rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.12);
        pointer-events: auto;
        animation: toastSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: flex-start;
        gap: 14px;
        position: relative;
        overflow: hidden;
    }
    
    .toast::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top right, rgba(204, 0, 0, 0.1), transparent 70%);
        pointer-events: none;
    }
    
    .toast::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 2px;
        background: linear-gradient(90deg, transparent, rgba(204, 0, 0, 0.6), transparent);
        animation: toastShimmer 2s ease-in-out infinite;
    }
    
    @keyframes toastShimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .toast.toast-exit {
        animation: toastSlideOut 0.3s ease-in forwards;
    }

    @keyframes toastSlideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    @keyframes toastSlideOut {
        from {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
        to {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
    }

    .toast-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 14px;
    }

    .toast-icon.success {
        background: rgba(0, 255, 0, 0.2);
        color: #00ff00;
    }

    .toast-icon.error {
        background: rgba(255, 68, 68, 0.2);
        color: #ff4444;
    }

    .toast-icon.warning {
        background: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
    }

    .toast-icon.info {
        background: rgba(100, 149, 237, 0.2);
        color: #6495ed;
    }

    .toast-content {
        flex: 1;
    }

    .toast-title {
        font-size: 14px;
        font-weight: 600;
        color: white;
        margin-bottom: 4px;
    }

    .toast-message {
        font-size: 12px;
        color: #b0b0b0;
        line-height: 1.4;
        white-space: pre-line;
    }

    .toast-close {
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        padding: 4px;
        margin: -4px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 16px;
        line-height: 1;
    }

    .toast-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
    }

    /* Chat Window Styles */
    .chat-window-container {
        background: linear-gradient(135deg, rgba(26, 26, 26, 0.98) 0%, rgba(13, 13, 13, 0.98) 100%);
        border-top: 2px solid #cc0000;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
        display: flex;
        flex-direction: column;
        height: 400px;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        margin-top: 0;
        margin-bottom: 1px;
        position: relative;
    }

    .chat-model-bar {
        position: sticky;
        top: 0;
        z-index: 10;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
    }

    /* Floating Chat Buttons */
    .chat-floating-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(40, 40, 40, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #888;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .chat-floating-btn:hover {
        background: rgba(204, 0, 0, 0.2);
        border-color: rgba(204, 0, 0, 0.4);
        color: #cc0000;
    }

    .chat-floating-btn svg {
        width: 16px;
        height: 16px;
    }

    /* Chat History Dropdown */
    .chat-history-dropdown {
        position: absolute;
        top: 100%;
        left: 12px;
        margin-top: 4px;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.98) 0%, rgba(20, 20, 20, 0.99) 100%);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        min-width: 240px;
        max-height: 300px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 100;
        display: none;
        animation: dropdownFadeIn 0.2s ease-out;
    }

    .chat-history-dropdown.active {
        display: block;
    }

    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-history-header {
        padding: 12px 16px;
        font-size: 12px;
        font-weight: 600;
        color: #888;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chat-history-list {
        max-height: 250px;
        overflow-y: auto;
    }

    .chat-history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chat-history-item:hover {
        background: rgba(204, 0, 0, 0.15);
    }

    .chat-history-item-content {
        flex: 1;
        min-width: 0;
    }

    .chat-history-item-title {
        font-size: 12px;
        color: #e0e0e0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-history-item-date {
        font-size: 10px;
        color: #666;
        margin-top: 2px;
    }

    .chat-history-item-delete {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s ease;
    }

    .chat-history-item:hover .chat-history-item-delete {
        opacity: 1;
    }

    .chat-history-item-delete:hover {
        background: rgba(255, 0, 0, 0.2);
        color: #ff4444;
    }

    .chat-history-item-delete svg {
        width: 14px;
        height: 14px;
    }

    .chat-history-empty {
        padding: 20px 16px;
        text-align: center;
        color: #666;
        font-size: 12px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-message {
        display: flex;
        gap: 8px;
        animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .chat-message.user {
        flex-direction: row-reverse;
    }

    .chat-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
        font-weight: 600;
        overflow: hidden;
    }

    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .chat-avatar svg {
        width: 20px;
        height: 20px;
    }

    .chat-message.user .chat-avatar {
        background: linear-gradient(135deg, #cc0000 0%, #990000 100%);
        color: white;
    }

    .chat-message.assistant .chat-avatar {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: white;
    }

    .chat-bubble {
        max-width: 75%;
        padding: 12px 14px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .chat-message.user .chat-bubble {
        background: linear-gradient(135deg, rgba(204, 0, 0, 0.2) 0%, rgba(153, 0, 0, 0.3) 100%);
        border: 1px solid rgba(204, 0, 0, 0.3);
        color: #fff;
        border-top-right-radius: 4px;
    }

    .chat-message.assistant .chat-bubble {
        background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(30, 30, 30, 0.95) 100%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e0e0e0;
        border-top-left-radius: 4px;
    }

    .chat-bubble pre {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 12px;
        overflow-x: auto;
        margin: 8px 0;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 12px;
        line-height: 1.4;
    }

    .chat-bubble code {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 12px;
    }

    .chat-bubble pre code {
        background: none;
        padding: 0;
    }

    /* Code block header with language label */
    .chat-bubble .code-block-wrapper {
        position: relative;
        margin: 8px 0;
    }

    .chat-bubble .code-block-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(60, 60, 60, 0.8);
        padding: 6px 12px;
        border-radius: 6px 6px 0 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
    }

    .chat-bubble .code-lang-label {
        font-size: 10px;
        color: #00bfa5;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .chat-bubble .code-copy-btn {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        padding: 2px 6px;
        font-size: 10px;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .chat-bubble .code-copy-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
    }

    .chat-bubble .code-block-wrapper pre {
        margin: 0;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }

    /* Syntax highlighting colors */
    .chat-bubble code .keyword { color: #ff79c6; }
    .chat-bubble code .string { color: #f1fa8c; }
    .chat-bubble code .number { color: #bd93f9; }
    .chat-bubble code .comment { color: #6272a4; font-style: italic; }
    .chat-bubble code .function { color: #50fa7b; }
    .chat-bubble code .operator { color: #ff79c6; }
    .chat-bubble code .property { color: #66d9ef; }
    .chat-bubble code .tag { color: #ff79c6; }
    .chat-bubble code .attr-name { color: #50fa7b; }
    .chat-bubble code .attr-value { color: #f1fa8c; }

    .chat-bubble p {
        margin: 8px 0;
    }

    .chat-bubble p:first-child {
        margin-top: 0;
    }

    .chat-bubble p:last-child {
        margin-bottom: 0;
    }

    .chat-bubble ul, .chat-bubble ol {
        margin: 8px 0;
        padding-left: 20px;
    }

    .chat-bubble li {
        margin: 4px 0;
    }

    .chat-bubble strong {
        font-weight: 700;
        color: #fff;
    }

    .chat-input-bar {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding: 12px 12px 0 12px;
        background: linear-gradient(135deg, rgba(20, 20, 20, 0.95) 0%, rgba(10, 10, 10, 0.98) 100%);
        display: flex;
        gap: 8px;
        align-items: flex-end;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 12px;
    }

    .chat-input-wrapper {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(26, 26, 26, 0.8);
        border: 2px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 8px 12px;
        transition: all 0.3s ease;
    }

    .chat-input-wrapper:focus-within {
        border-color: #cc0000;
        background: rgba(13, 13, 13, 0.9);
        box-shadow: 0 0 0 4px rgba(204, 0, 0, 0.15);
    }

    .chat-textarea {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: white;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        max-height: 100px;
        min-height: 24px;
    }

    .chat-textarea::placeholder {
        color: #555;
    }

    .chat-controls {
        display: flex;
        gap: 6px;
        align-items: center;
    }

    .chat-icon-btn {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        padding: 6px;
        border-radius: 6px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #cc0000;
    }

    .chat-icon-btn svg {
        width: 18px;
        height: 18px;
    }

    .chat-send-icon-btn {
        color: #cc0000;
    }

    .chat-send-icon-btn:hover {
        background: rgba(204, 0, 0, 0.2);
        color: #ff0000;
    }

    .chat-send-icon-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Web Search Toggle Styles - Icon only button */
    .web-search-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        border-radius: 6px;
        background: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .web-search-toggle:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .web-search-toggle.active {
        background: rgba(0, 150, 136, 0.2);
    }

    .web-search-toggle.active .web-search-icon {
        color: #00bfa5;
    }

    .web-search-icon {
        width: 18px;
        height: 18px;
        color: #888;
        transition: color 0.2s ease;
    }

    .web-search-toggle:hover .web-search-icon {
        color: #00bfa5;
    }

    /* More Menu Button Styles */
    .more-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px;
        border-radius: 6px;
        background: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .more-menu-btn:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .more-menu-btn svg {
        width: 18px;
        height: 18px;
        color: #888;
        transition: color 0.2s ease;
    }

    .more-menu-btn:hover svg {
        color: #cc0000;
    }

    /* Quick Actions Popup Styles */
    .quick-actions-popup {
        position: absolute;
        bottom: 100%;
        right: 0;
        margin-bottom: 8px;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.98) 0%, rgba(20, 20, 20, 0.99) 100%);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 8px;
        min-width: 180px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        z-index: 100;
        display: none;
        animation: popupFadeIn 0.2s ease-out;
    }

    .quick-actions-popup.active {
        display: block;
    }

    @keyframes popupFadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .quick-action-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 8px;
        background: none;
        border: none;
        color: #e0e0e0;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        width: 100%;
        text-align: left;
        transition: all 0.2s ease;
    }

    .quick-action-item:hover {
        background: rgba(204, 0, 0, 0.15);
        color: white;
    }

    .quick-action-item svg {
        width: 16px;
        height: 16px;
        color: #888;
        flex-shrink: 0;
    }

    .quick-action-item:hover svg {
        color: #cc0000;
    }

    /* Usage Stats Card Styles - Compact */
    .usage-stats-card {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }

    .usage-stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 6px;
        background: rgba(40, 40, 40, 0.4);
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .usage-stat-value {
        font-size: 16px;
        font-weight: 700;
        color: #00bfa5;
        margin-bottom: 1px;
    }

    .usage-stat-label {
        font-size: 8px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Live Status Indicator Styles */
    .chat-status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.98) 100%);
        border-radius: 8px;
        margin-bottom: 8px;
        animation: statusFadeIn 0.3s ease-out;
    }

    @keyframes statusFadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .status-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-top-color: #00bfa5;
        border-radius: 50%;
        animation: statusSpin 0.8s linear infinite;
    }

    @keyframes statusSpin {
        to { transform: rotate(360deg); }
    }

    .status-text {
        font-size: 12px;
        color: #00bfa5;
        font-weight: 500;
    }

    .status-searching .status-spinner {
        border-top-color: #00bfa5;
    }

    .status-searching .status-text {
        color: #00bfa5;
    }

    .status-crawling .status-spinner {
        border-top-color: #ff9800;
    }

    .status-crawling .status-text {
        color: #ff9800;
    }

    .status-processing .status-spinner {
        border-top-color: #9c27b0;
    }

    .status-processing .status-text {
        color: #9c27b0;
    }

    .status-complete .status-spinner {
        animation: none;
        border-color: #4caf50;
        background: #4caf50;
    }

    .status-complete .status-text {
        color: #4caf50;
    }

    /* Citation Styles */
    .chat-citation {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        background: rgba(0, 150, 136, 0.15);
        border: 1px solid rgba(0, 150, 136, 0.3);
        border-radius: 4px;
        font-size: 10px;
        color: #00bfa5;
        text-decoration: none;
        transition: all 0.2s ease;
        margin: 2px 4px 2px 0;
    }

    .chat-citation:hover {
        background: rgba(0, 150, 136, 0.25);
        border-color: rgba(0, 150, 136, 0.5);
    }

    .chat-citations-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-citations-label {
        font-size: 10px;
        color: #888;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .chat-citations-list {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .chat-model-select {
        background: rgba(26, 26, 26, 0.9);
        border: 1px solid rgba(204, 0, 0, 0.3);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
        width: auto;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .chat-model-select:hover:not(:disabled) {
        border-color: rgba(204, 0, 0, 0.6);
        background: rgba(13, 13, 13, 0.95);
        box-shadow: 0 4px 12px rgba(204, 0, 0, 0.2);
    }

    .chat-model-select:focus {
        border-color: #cc0000;
        box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.2);
    }

    .chat-model-select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .chat-model-select option {
        background: #1a1a1a;
        color: white;
        padding: 8px;
    }

    .chat-file-input {
        display: none;
    }

    .chat-empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
    }

    .chat-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    .chat-empty-text {
        font-size: 14px;
        margin-bottom: 6px;
    }

    .chat-empty-subtext {
        font-size: 12px;
        color: #555;
    }

    @media (max-width: 480px) {
        .chat-window-container {
            height: 450px;
            margin-top: 0;
            margin-bottom: 1px;
        }

        .chat-model-bar {
            padding: 6px 8px;
        }

        .chat-model-select {
            font-size: 11px;
            padding: 5px 10px;
            max-width: 95%;
        }

        .chat-bubble {
            max-width: 85%;
            font-size: 12px;
        }

        .chat-input-bar {
            padding: 8px 8px 0 8px;
            gap: 6px;
        }

        .chat-input-wrapper {
            flex: 1;
            min-width: 0;
            gap: 4px;
            padding: 6px 10px;
        }

        .chat-textarea {
            font-size: 13px;
        }

        .chat-controls {
            gap: 4px;
            flex-shrink: 0;
        }
    }

        .chat-icon-btn {
            padding: 4px;
        }

        .chat-icon-btn svg {
            width: 16px;
            height: 16px;
        }
    }
</style>

</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="header">
        <button class="hamburger" onclick="toggleMenu()">
            <span class="hamburger-icon"></span>
        </button>
        <div class="header-title">
            <svg class="logo" viewBox="0 0 285 285" xmlns="http://www.w3.org/2000/svg">
                <rect x="0" y="0" width="285" height="285" rx="64" fill="#C0392B"/>
                <path d="M30 84 L60 94 L90 89 L120 79 L150 99 L180 94 L210 89 L240 84 L255 86" stroke="#FFA500" stroke-width="3" stroke-dasharray="6 4" fill="none" opacity="0.8"/>
                <rect x="33" y="104" width="12" height="36" fill="white"/>
                <line x1="39" y1="94" x2="39" y2="104" stroke="white" stroke-width="2.5"/>
                <line x1="39" y1="140" x2="39" y2="150" stroke="white" stroke-width="2.5"/>
                <rect x="58" y="114" width="12" height="28" fill="#212121"/>
                <line x1="64" y1="102" x2="64" y2="114" stroke="#212121" stroke-width="2.5"/>
                <line x1="64" y1="142" x2="64" y2="154" stroke="#212121" stroke-width="2.5"/>
                <rect x="83" y="99" width="12" height="42" fill="white"/>
                <line x1="89" y1="88" x2="89" y2="99" stroke="white" stroke-width="2.5"/>
                <line x1="89" y1="141" x2="89" y2="152" stroke="white" stroke-width="2.5"/>
                <rect x="108" y="74" width="12" height="52" fill="white"/>
                <line x1="114" y1="62" x2="114" y2="74" stroke="white" stroke-width="2.5"/>
                <line x1="114" y1="126" x2="114" y2="138" stroke="white" stroke-width="2.5"/>
                <rect x="133" y="94" width="12" height="38" fill="#212121"/>
                <line x1="139" y1="82" x2="139" y2="94" stroke="#212121" stroke-width="2.5"/>
                <line x1="139" y1="132" x2="139" y2="144" stroke="#212121" stroke-width="2.5"/>
                <rect x="158" y="109" width="12" height="30" fill="#212121"/>
                <line x1="164" y1="97" x2="164" y2="109" stroke="#212121" stroke-width="2.5"/>
                <line x1="164" y1="139" x2="164" y2="151" stroke="#212121" stroke-width="2.5"/>
                <rect x="183" y="102" width="12" height="34" fill="white"/>
                <line x1="189" y1="90" x2="189" y2="102" stroke="white" stroke-width="2.5"/>
                <line x1="189" y1="136" x2="189" y2="148" stroke="white" stroke-width="2.5"/>
                <rect x="208" y="80" width="12" height="48" fill="white"/>
                <line x1="214" y1="68" x2="214" y2="80" stroke="white" stroke-width="2.5"/>
                <line x1="214" y1="128" x2="214" y2="148" stroke="white" stroke-width="2.5"/>
                <rect x="233" y="60" width="12" height="44" fill="white"/>
                <line x1="239" y1="46" x2="239" y2="60" stroke="white" stroke-width="2.5"/>
                <line x1="239" y1="104" x2="239" y2="110" stroke="white" stroke-width="2.5"/>
                <path d="M15 174H270" stroke="white" stroke-width="4" stroke-linecap="round"/>
                <path d="M39 174V190L24 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="24" cy="205" r="4" fill="white"/>
                <path d="M64 174V198L49 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="49" cy="213" r="4" fill="white"/>
                <path d="M89 174V205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="89" cy="205" r="4" fill="white"/>
                <path d="M114 174V198L129 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="129" cy="213" r="4" fill="white"/>
                <path d="M139 174V190L154 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="154" cy="205" r="4" fill="white"/>
                <path d="M164 174V205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="164" cy="205" r="4" fill="white"/>
                <path d="M189 174V190L204 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="204" cy="205" r="4" fill="white"/>
                <path d="M214 174V198L229 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="229" cy="213" r="4" fill="white"/>
                <path d="M239 174V190L254 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="254" cy="205" r="4" fill="white"/>
            </svg>
            <h1>SFTi P.R.E.P</h1>
        </div>
        <div style="width: 40px;"></div>
    </div>

<div class="side-menu" id="sideMenu">
    <div class="menu-header">
        <div class="menu-logo">
            <svg class="logo" viewBox="0 0 285 285" xmlns="http://www.w3.org/2000/svg">
                <rect x="0" y="0" width="285" height="285" rx="64" fill="#C0392B"/>
                <path d="M30 84 L60 94 L90 89 L120 79 L150 99 L180 94 L210 89 L240 84 L255 86" stroke="#FFA500" stroke-width="3" stroke-dasharray="6 4" fill="none" opacity="0.8"/>
                <rect x="33" y="104" width="12" height="36" fill="white"/>
                <line x1="39" y1="94" x2="39" y2="104" stroke="white" stroke-width="2.5"/>
                <line x1="39" y1="140" x2="39" y2="150" stroke="white" stroke-width="2.5"/>
                <rect x="58" y="114" width="12" height="28" fill="#212121"/>
                <line x1="64" y1="102" x2="64" y2="114" stroke="#212121" stroke-width="2.5"/>
                <line x1="64" y1="142" x2="64" y2="154" stroke="#212121" stroke-width="2.5"/>
                <rect x="83" y="99" width="12" height="42" fill="white"/>
                <line x1="89" y1="88" x2="89" y2="99" stroke="white" stroke-width="2.5"/>
                <line x1="89" y1="141" x2="89" y2="152" stroke="white" stroke-width="2.5"/>
                <rect x="108" y="74" width="12" height="52" fill="white"/>
                <line x1="114" y1="62" x2="114" y2="74" stroke="white" stroke-width="2.5"/>
                <line x1="114" y1="126" x2="114" y2="138" stroke="white" stroke-width="2.5"/>
                <rect x="133" y="94" width="12" height="38" fill="#212121"/>
                <line x1="139" y1="82" x2="139" y2="94" stroke="#212121" stroke-width="2.5"/>
                <line x1="139" y1="132" x2="139" y2="144" stroke="#212121" stroke-width="2.5"/>
                <rect x="158" y="109" width="12" height="30" fill="#212121"/>
                <line x1="164" y1="97" x2="164" y2="109" stroke="#212121" stroke-width="2.5"/>
                <line x1="164" y1="139" x2="164" y2="151" stroke="#212121" stroke-width="2.5"/>
                <rect x="183" y="102" width="12" height="34" fill="white"/>
                <line x1="189" y1="90" x2="189" y2="102" stroke="white" stroke-width="2.5"/>
                <line x1="189" y1="136" x2="189" y2="148" stroke="white" stroke-width="2.5"/>
                <rect x="208" y="80" width="12" height="48" fill="white"/>
                <line x1="214" y1="68" x2="214" y2="80" stroke="white" stroke-width="2.5"/>
                <line x1="214" y1="128" x2="214" y2="148" stroke="white" stroke-width="2.5"/>
                <rect x="233" y="60" width="12" height="44" fill="white"/>
                <line x1="239" y1="46" x2="239" y2="60" stroke="white" stroke-width="2.5"/>
                <line x1="239" y1="104" x2="239" y2="110" stroke="white" stroke-width="2.5"/>
                <path d="M15 174H270" stroke="white" stroke-width="4" stroke-linecap="round"/>
                <path d="M39 174V190L24 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="24" cy="205" r="4" fill="white"/>
                <path d="M64 174V198L49 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="49" cy="213" r="4" fill="white"/>
                <path d="M89 174V205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="89" cy="205" r="4" fill="white"/>
                <path d="M114 174V198L129 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="129" cy="213" r="4" fill="white"/>
                <path d="M139 174V190L154 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="154" cy="205" r="4" fill="white"/>
                <path d="M164 174V205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="164" cy="205" r="4" fill="white"/>
                <path d="M189 174V190L204 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="204" cy="205" r="4" fill="white"/>
                <path d="M214 174V198L229 213" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="229" cy="213" r="4" fill="white"/>
                <path d="M239 174V190L254 205" stroke="white" stroke-width="2.5" stroke-linecap="round" fill="none"/>
                <circle cx="254" cy="205" r="4" fill="white"/>
            </svg>
            <div>
                <div class="menu-title">SFTi P.R.E.P</div>
                <div class="menu-subtitle">Disciplined Trading P.R.E.P & Review</div>
            </div>
        </div>
    </div>
    <div class="menu-nav">
        <button class="menu-btn active" onclick="switchView('grade')" id="gradeBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            <span>Grade Stock</span>
        </button>
        <button class="menu-btn" onclick="switchView('tracker')" id="trackerBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span>Trade Plan</span>
        </button>
        <button class="menu-btn" onclick="switchView('finalize')" id="finalizeBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            <span>Finalize Trades</span>
        </button>
        <button class="menu-btn" onclick="switchView('history')" id="historyBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span>History</span>
        </button>
        <button class="menu-btn" onclick="switchView('ai')" id="aiBtn">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"></path>
                <circle cx="7.5" cy="14.5" r="1.5" fill="currentColor"></circle>
                <circle cx="16.5" cy="14.5" r="1.5" fill="currentColor"></circle>
            </svg>
            <span>AI Assistant</span>
        </button>
        <button class="menu-btn" onclick="refreshServiceWorker()">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            <span>Refresh</span>
        </button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<div class="container">
    <div id="gradeView">
        <div class="card compact-card">
            <input type="text" class="ticker-input" id="tickerInput" placeholder="ENTER TICKER" maxlength="10">
        </div>

        <div class="card score-display compact-card">
            <div class="score-value"><span id="totalScore">50</span>/100</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 50%"></div>
            </div>
        </div>

        <div class="card">
            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">P - Pattern/Price</div>
                        <div class="slider-subtitle">Technical setup quality</div>
                    </div>
                    <div class="slider-value" id="pattern-value">10</div>
                </div>  
                <input type="range" class="slider" min="1" max="20" value="10" id="pattern-slider" oninput="updateSlider('pattern', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">R - Risk/Reward</div>
                        <div class="slider-subtitle">Trade R:R ratio</div>
                    </div>
                    <div class="slider-value" id="risk-value">10</div>
                </div>
                <input type="range" class="slider" min="1" max="20" value="10" id="risk-slider" oninput="updateSlider('risk', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">E - Ease of Entry/Exit</div>
                        <div class="slider-subtitle">Liquidity & execution</div>
                    </div>
                    <div class="slider-value" id="entry-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="entry-slider" oninput="updateSlider('entry', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">P - Past Performance</div>
                        <div class="slider-subtitle">History of spiking</div>
                    </div>
                    <div class="slider-value" id="performance-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="performance-slider" oninput="updateSlider('performance', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">A - At What Time Is It?</div>
                        <div class="slider-subtitle">Personal schedule fit</div>
                    </div>
                    <div class="slider-value" id="time-value">10</div>
                </div>
                <input type="range" class="slider" min="1" max="20" value="10" id="time-slider" oninput="updateSlider('time', this.value, 20)">
                <div class="slider-range"><span>1</span><span>20</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">R - Reason/Catalyst</div>
                        <div class="slider-subtitle">News or event driver</div>
                    </div>
                    <div class="slider-value" id="catalyst-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="catalyst-slider" oninput="updateSlider('catalyst', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title">E - Market Environment</div>
                        <div class="slider-subtitle">Overall market conditions</div>
                    </div>
                    <div class="slider-value" id="environment-value">5</div>
                </div>
                <input type="range" class="slider" min="1" max="10" value="5" id="environment-slider" oninput="updateSlider('environment', this.value, 10)">
                <div class="slider-range"><span>1</span><span>10</span></div>
            </div>
        </div>

        <div class="card">
            <input type="file" id="screenshotInput" accept="image/*" style="display: none;">
            <div id="screenshotPreview" style="display: none; margin-bottom: 8px; position: relative;">
                <img id="previewImg" style="width: 100%; border-radius: 6px; border: 1px solid #333;">
                <button id="clearScreenshotBtn" style="position: absolute; top: 4px; right: 4px; background: rgba(204,0,0,0.9); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px;"></button>
            </div>
            <button id="addScreenshotBtn" class="save-btn" style="padding: 8px; background: linear-gradient(135deg, #333 0%, #222 100%);">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
                <span id="screenshotBtnText">Add Screenshot</span>
            </button>
        </div>

        <button class="save-btn" onclick="continueToTracker()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 16 16 12 12 8"></polyline>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            Continue
        </button>
    </div>

    <div id="trackerView" style="display: none;">
        <div class="card" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div class="card-title" style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#cc0000" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Trade Plan Builder
            </div>
            
            <div id="trackerTickerDisplay" style="text-align: center; margin-bottom: 12px;">
                <span style="font-size: 24px; font-weight: 700; color: white;" id="trackerTickerLabel">---</span>
                <span style="font-size: 12px; color: #888; display: block;">Score: <span id="trackerScoreLabel">--</span>/100</span>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #ffcc00;"> Ideal Entry Price</div>
                    </div>
                </div>
                <input type="number" class="ticker-input" id="entryPriceInput" placeholder="Enter price (e.g., 1.05)" step="0.01" min="0.01" max="10000" style="text-transform: none; font-size: 16px; text-align: center;">
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #ff4444;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            Stop Loss
                        </div>
                        <div class="slider-subtitle" style="display: block;">Protect your capital</div>
                    </div>
                    <div class="slider-value" style="color: #ff4444;" id="stopLoss-value">7%</div>
                </div>
                <input type="range" class="slider" min="5" max="10" value="7" step="0.5" id="stopLoss-slider" oninput="updateTrackerSlider('stopLoss', this.value)" style="background: linear-gradient(to right, #ff4444 0%, #ff4444 40%, #1a1a1a 40%, #1a1a1a 100%);">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 2px;">
                    <span>5%</span>
                    <span id="stopPriceDisplay" style="color: #ff4444; font-weight: 600;">$0.00</span>
                    <span>10%</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #00ff00;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 8v8m-4-4h8"></path>
                            </svg>
                            Profit Target
                        </div>
                        <div class="slider-subtitle" style="display: block;">Set your goal</div>
                    </div>
                    <div class="slider-value" style="color: #00ff00;" id="profitTarget-value">20%</div>
                </div>
                <input type="range" class="slider" min="15" max="30" value="20" step="1" id="profitTarget-slider" oninput="updateTrackerSlider('profitTarget', this.value)" style="background: linear-gradient(to right, #00ff00 0%, #00ff00 33%, #1a1a1a 33%, #1a1a1a 100%);">
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; margin-top: 2px;">
                    <span>15%</span>
                    <span id="targetPriceDisplay" style="color: #00ff00; font-weight: 600;">$0.00</span>
                    <span>30%</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <div class="slider-label">
                        <div class="slider-title" style="color: #6495ed; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Trade Thoughts</span>
                        </div>
                        <div class="slider-subtitle" style="display: block;">What are you thinking?</div>
                    </div>
                </div>
                <textarea class="ticker-input" id="tradeThoughtsInput" placeholder="Write down your thoughts about this trade..." style="text-transform: none; font-size: 12px; min-height: 80px; resize: vertical; line-height: 1.4;"></textarea>
            </div>
        </div>

        <div class="card" style="background: linear-gradient(135deg, rgba(0, 100, 0, 0.2) 0%, rgba(100, 0, 0, 0.2) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.15);">
            <div style="text-align: center;">
                <div style="font-size: 11px; color: #888; margin-bottom: 4px;">RISK / REWARD RATIO</div>
                <div style="font-size: 36px; font-weight: 700; color: white;" id="rrRatioDisplay">
                    <span id="rrRatioValue">0.0</span><span style="font-size: 18px; color: #888;">:1</span>
                </div>
                <div id="rrQuality" style="font-size: 12px; margin-top: 4px; padding: 4px 12px; border-radius: 12px; display: inline-block;">--</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px; text-align: center;">
                <div style="background: rgba(255, 204, 0, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 204, 0, 0.3);">
                    <div style="font-size: 10px; color: #ffcc00; margin-bottom: 2px;">ENTRY</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryEntry">$0.00</div>
                </div>
                <div style="background: rgba(255, 68, 68, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 68, 68, 0.3);">
                    <div style="font-size: 10px; color: #ff4444; margin-bottom: 2px;">STOP</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryStop">$0.00</div>
                </div>
                <div style="background: rgba(0, 255, 0, 0.15); padding: 8px; border-radius: 8px; border: 1px solid rgba(0, 255, 0, 0.3);">
                    <div style="font-size: 10px; color: #00ff00; margin-bottom: 2px;">TARGET</div>
                    <div style="font-size: 14px; font-weight: 600; color: white;" id="summaryTarget">$0.00</div>
                </div>
            </div>
        </div>

        <button class="save-btn" onclick="saveTradePlan()" style="background: linear-gradient(135deg, #00aa00 0%, #006600 100%); box-shadow: 0 4px 15px rgba(0, 170, 0, 0.3);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save Trade Plan
        </button>

        <button class="save-btn" onclick="switchView('grade')" style="margin-top: 8px; background: linear-gradient(135deg, #333 0%, #222 100%);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Grade
        </button>
    </div>

    <div id="finalizeView" style="display: none;">
        <h2 style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px;">Finalize Trades</h2>
        
        <div class="card" style="margin-bottom: 12px; background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
            <div style="font-size: 11px; color: #888; line-height: 1.5;">
                <p>Review and finalize your planned trades. Mark trades as <span style="color: #ff4444; font-weight: 600;">Rejected</span> (not taken) or <span style="color: #00ff00; font-weight: 600;">Accepted</span> (executed) to track your results.</p>
            </div>
        </div>
        
        <div id="finalizeContainer"></div>
    </div>

    <div id="historyView" style="display: none;">
        <h2 style="font-size: 18px; font-weight: 700; color: white; margin-bottom: 12px;">Trade History</h2>
        
        <div class="card" style="margin-bottom: 12px; background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); padding: 8px;">
            <div style="background: rgba(26, 26, 26, 0.8); border: 2px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 8px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
                <input type="text" class="ticker-input" id="historySearchInput" placeholder="Search ticker..." style="width: 100%; padding: 12px 14px; font-size: 14px; border: none; background: transparent; margin-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                <div style="display: flex; gap: 6px; align-items: center;">
                    <select id="historyGradeFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Grades</option>
                        <option value="A">A (90+)</option>
                        <option value="B">B (75-89)</option>
                        <option value="C">C (60-74)</option>
                        <option value="D">D (Below 60)</option>
                    </select>
                    <select id="historyStatusFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Status</option>
                        <option value="finalized">Finalized</option>
                        <option value="non-finalized">Non-Finalized</option>
                    </select>
                    <select id="historyStrategyFilter" class="ticker-input" style="flex: 1; padding: 10px 8px; font-size: 13px; text-transform: none; border-radius: 8px; background: rgba(40, 40, 40, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); height: 38px;">
                        <option value="">All Strategies</option>
                    </select>
                    <button class="save-btn" onclick="filterHistory()" aria-label="Search" style="flex: 0 0 auto; padding: 8px; font-size: 12px; border-radius: 8px; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="historyContainer"></div>
    </div>

    <div id="aiView" style="display: none;">
        <h2 style="font-size: 14px; font-weight: 700; color: white; margin-bottom: 6px;">AI Trading Assistant</h2>
        
        <!-- Token Access Cards - Two side by side (compact) -->
        <div style="display: flex; gap: 8px; margin-bottom: 6px;">
            <!-- GitHub Token Card - Compact with real-time status -->
            <div class="card" style="flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 8px;" onclick="showGithubTokenModal()" aria-label="Configure GitHub token">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" style="color: #e0e0e0; margin-bottom: 4px;">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <div id="githubTokenStatus" style="text-align: center;">
                    <div style="font-size: 10px; font-weight: 600; color: #888;">GitHub Token</div>
                    <div id="githubTokenStatusText" style="font-size: 9px; color: #666; margin-top: 1px;">Click to configure</div>
                </div>
            </div>
            
            <!-- Market API Card - Compact Starlink-style with Coming Soon modal -->
            <div class="card" style="flex: 1; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 8px;" onclick="showMarketApiModal()" aria-label="Configure Market API">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #e0e0e0; margin-bottom: 4px;">
                    <!-- Starlink-inspired satellite/connection icon -->
                    <circle cx="12" cy="12" r="3" fill="currentColor"/>
                    <path d="M12 2v3" stroke-linecap="round"/>
                    <path d="M12 19v3" stroke-linecap="round"/>
                    <path d="M2 12h3" stroke-linecap="round"/>
                    <path d="M19 12h3" stroke-linecap="round"/>
                    <path d="M4.93 4.93l2.12 2.12" stroke-linecap="round"/>
                    <path d="M16.95 16.95l2.12 2.12" stroke-linecap="round"/>
                    <path d="M4.93 19.07l2.12-2.12" stroke-linecap="round"/>
                    <path d="M16.95 7.05l2.12-2.12" stroke-linecap="round"/>
                    <circle cx="12" cy="12" r="8" stroke-dasharray="4 2"/>
                </svg>
                <div id="marketApiStatus" style="text-align: center;">
                    <div style="font-size: 10px; font-weight: 600; color: #888;">Market API</div>
                    <div id="marketApiStatusText" style="font-size: 9px; color: #666; margin-top: 1px;">Token Needed</div>
                </div>
            </div>
        </div>
        
        <!-- Usage & Stats Card (compact) -->
        <div class="card" style="margin-bottom: 6px; padding: 8px 12px;">
            <label class="label-text" style="margin-bottom: 6px;">Usage & Stats</label>
            <div class="usage-stats-card">
                <div class="usage-stat-item">
                    <div class="usage-stat-value" id="statMessages">0</div>
                    <div class="usage-stat-label">Messages</div>
                </div>
                <div class="usage-stat-item">
                    <div class="usage-stat-value" id="statSearches">0</div>
                    <div class="usage-stat-label">Web Searches</div>
                </div>
                <div class="usage-stat-item">
                    <div class="usage-stat-value" id="statTokensUsed">0</div>
                    <div class="usage-stat-label">Tokens Used</div>
                </div>
                <div class="usage-stat-item">
                    <div class="usage-stat-value" id="statModel">--</div>
                    <div class="usage-stat-label">Active Model</div>
                </div>
            </div>
        </div>

        <!-- Chat Window - Fixed at bottom when AI view is active -->
        <div class="chat-window-container" id="chatWindow" style="display: none;">
            <div class="chat-model-bar">
                <!-- Chat History Button (Left) -->
                <button class="chat-floating-btn chat-history-btn" onclick="toggleChatHistoryDropdown(event)" title="Chat History" aria-label="Chat History">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </button>
                <!-- Chat History Dropdown -->
                <div id="chatHistoryDropdown" class="chat-history-dropdown">
                    <div class="chat-history-header">Chat History</div>
                    <div id="chatHistoryList" class="chat-history-list">
                        <!-- Chat history items will be populated dynamically -->
                    </div>
                </div>
                
                <select id="chatModelSelect" class="chat-model-select" title="Select AI model" disabled aria-label="AI Model Selector - Save GitHub token to load available models">
                    <option value="">Save GitHub token to load models</option>
                </select>
                
                <!-- New Chat Button (Right) -->
                <button class="chat-floating-btn chat-new-btn" onclick="startNewChat()" title="New Chat" aria-label="New Chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
            <div class="chat-messages" id="chatMessagesContainer">
                <div class="chat-empty-state">
                    <div class="chat-empty-icon"></div>
                    <div class="chat-empty-text">Start a conversation</div>
                    <div class="chat-empty-subtext">Ask about trades, patterns, or market sentiment</div>
                </div>
            </div>
            <div class="chat-input-bar">
                <!-- Live Status Indicator - shown during web search operations -->
                <div id="chatStatusIndicator" class="chat-status-indicator" style="display: none;">
                    <div class="status-spinner"></div>
                    <span class="status-text">Thinking...</span>
                </div>
                <div class="chat-input-wrapper">
                    <textarea 
                        id="aiPrompt" 
                        class="chat-textarea" 
                        placeholder="Talk about Markets..."
                        rows="1"
                        onkeydown="handleChatKeyPress(event)"
                        oninput="autoResizeTextarea(this)"></textarea>
                    <div class="chat-controls">
                        <input type="file" id="chatFileInput" class="chat-file-input" accept="image/*" onchange="handleChatFileUpload(this)">
                        <button class="chat-icon-btn" onclick="document.getElementById('chatFileInput').click()" title="Attach file" aria-label="Attach file">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                            </svg>
                        </button>
                        <!-- Web Search Toggle - SVG only -->
                        <div id="webSearchToggle" class="web-search-toggle chat-icon-btn" onclick="toggleWebSearch()" title="Toggle web search" aria-label="Toggle web search">
                            <svg class="web-search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                        </div>
                        <!-- More Menu Button - Quick Actions -->
                        <div class="more-menu-btn" onclick="toggleQuickActionsPopup(event)" title="Quick Actions" aria-label="Quick Actions">
                            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                <circle cx="12" cy="5" r="2"></circle>
                                <circle cx="12" cy="12" r="2"></circle>
                                <circle cx="12" cy="19" r="2"></circle>
                            </svg>
                            <!-- Quick Actions Popup -->
                            <div id="quickActionsPopup" class="quick-actions-popup">
                                <button class="quick-action-item" onclick="reviewGrades(); hideQuickActionsPopup();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
                                    Review Grades
                                </button>
                                <button class="quick-action-item" onclick="findPatterns(); hideQuickActionsPopup();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                                    Find Patterns
                                </button>
                                <button class="quick-action-item" onclick="getSentiment(); hideQuickActionsPopup();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
                                    Market Sentiment
                                </button>
                                <button class="quick-action-item" onclick="showTickerModal(); hideQuickActionsPopup();">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                    Analyze Ticker
                                </button>
                            </div>
                        </div>
                        <button class="chat-icon-btn chat-send-icon-btn" onclick="askAI()" id="chatSendBtn" title="Send message" aria-label="Send message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- iOS Liquid Glass Style Ticker Modal -->
<div class="modal-overlay" id="tickerModal">
    <div class="modal-content">
        <div class="modal-title">Analyze Ticker</div>
        <input type="text" class="modal-input" id="tickerModalInput" placeholder="Enter symbol (e.g., AAPL)" maxlength="10">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideTickerModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmTickerAnalysis()">Analyze</button>
        </div>
    </div>
</div>

<!-- Trade Details Modal -->
<div class="modal-overlay" id="tradeDetailsModal">
    <div class="modal-content" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
        <div class="modal-title" id="tradeDetailsTitle">Trade Details</div>
        <div id="tradeDetailsContent" style="font-size: 12px; color: #e0e0e0; line-height: 1.6;">
            <!-- Content will be populated dynamically -->
        </div>
        <div class="modal-buttons" style="margin-top: 16px;">
            <button class="modal-btn modal-btn-cancel" onclick="hideTradeDetailsModal()" style="width: 100%;">Close</button>
        </div>
    </div>
</div>

<!-- Finalize Trade Modal -->
<div class="modal-overlay" id="finalizeTradeModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-title">Finalize Trade: <span id="finalizeModalTicker"></span></div>
        <div id="finalizeModalContent" style="font-size: 12px; color: #e0e0e0; margin-bottom: 16px;">
            <!-- Initial choice or detailed finalization form -->
        </div>
        <div id="finalizeModalButtons" class="modal-buttons">
            <!-- Buttons will be populated dynamically -->
        </div>
    </div>
</div>

<!-- Full Screen Image Viewer Modal -->
<div class="modal-overlay" id="imageViewerModal" style="background: rgba(0, 0, 0, 0.95); cursor: pointer;">
    <button onclick="hideImageViewer()" aria-label="Close image viewer" style="position: fixed; top: 60px; right: 20px; background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 24px; z-index: 101; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
    <img id="fullScreenImage" src="" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; cursor: default;" onclick="event.stopPropagation();" alt="Full screen view">
</div>

<!-- GitHub Token Modal -->
<div class="modal-overlay" id="githubTokenModal">
    <div class="modal-content">
        <div class="modal-title">GitHub Token</div>
        <p style="font-size: 11px; color: #888; margin-bottom: 16px; text-align: center;">Enter your GitHub personal access token for model access</p>
        <input type="password" class="modal-input" id="githubTokenInput" placeholder="ghp_...">
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideGithubTokenModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="saveGithubToken()">Save Token</button>
        </div>
    </div>
</div>

<!-- Market API Modal - Coming Soon -->
<div class="modal-overlay" id="marketApiModal">
    <div class="modal-content">
        <div class="modal-title">Market API</div>
        <div style="text-align: center; padding: 20px 0;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: #00bfa5; margin-bottom: 16px;">
                <!-- Starlink-inspired satellite/connection icon -->
                <circle cx="12" cy="12" r="3" fill="currentColor"/>
                <path d="M12 2v3" stroke-linecap="round"/>
                <path d="M12 19v3" stroke-linecap="round"/>
                <path d="M2 12h3" stroke-linecap="round"/>
                <path d="M19 12h3" stroke-linecap="round"/>
                <path d="M4.93 4.93l2.12 2.12" stroke-linecap="round"/>
                <path d="M16.95 16.95l2.12 2.12" stroke-linecap="round"/>
                <path d="M4.93 19.07l2.12-2.12" stroke-linecap="round"/>
                <path d="M16.95 7.05l2.12-2.12" stroke-linecap="round"/>
                <circle cx="12" cy="12" r="8" stroke-dasharray="4 2"/>
            </svg>
        </div>
        <p style="font-size: 13px; color: #00bfa5; margin-bottom: 8px; text-align: center; font-weight: 600;">Coming Soon</p>
        <p style="font-size: 11px; color: #888; margin-bottom: 16px; text-align: center;">Real-time market data integration will be available in a future update.</p>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideMarketApiModal()" style="width: 100%;">Close</button>
        </div>
    </div>
</div>
</div>

<script>
    // Configuration constants
    const CONFIG = {
        MAX_SCREENSHOT_SIZE: 2 * 1024 * 1024, // 2MB max for screenshots
        MAX_GRADES_FOR_REVIEW: 10,
        MAX_GRADES_FOR_PATTERNS: 20,
        CHAT_MESSAGE_PREVIEW_LENGTH: 200,
        AI_MAX_TOKENS: 1500,  // Increased for more detailed responses
        AI_TEMPERATURE: 0.7,
        API_ENDPOINT: 'https://models.inference.ai.azure.com/chat/completions',
        // Web Search Configuration
        WEB_SEARCH_ENABLED: false,
        WEB_SEARCH_MAX_ITERATIONS: 5,  // Maximum tool calling iterations
        WEB_SEARCH_MAX_RESULTS: 5,     // Max search results to return
        CORS_PROXY: 'https://api.allorigins.win/raw?url='  // CORS proxy for web fetching
    };

    // Web Search State
    let webSearchEnabled = false;
    let currentSearchAbortController = null;

    const state = {
        pattern: 10,
        risk: 10,
        entry: 5,
        performance: 5,
        time: 10,
        catalyst: 5,
        environment: 5
    };

    // Trade plan state
    const trackerState = {
        ticker: '',
        scores: null,
        total: 0,
        screenshot: null,
        stopLossPercent: 7,
        profitTargetPercent: 20,
        entryPrice: 0,
        thoughts: ''
    };

    let currentScreenshot = null;
    let chatHistory = [];
    let historyFilterTicker = '';
    let historyFilterGrade = '';
    let historyFilterStatus = '';
    let historyFilterStrategy = '';
    let currentFinalizeTradeIndex = null;

    /**
     * Reset all history filter state variables to their default (unfiltered) values.
     * Intended to be called whenever the user clears history filters in the UI.
     */
    function resetHistoryFilters() {
        historyFilterTicker = '';
        historyFilterGrade = '';
        historyFilterStatus = '';
        historyFilterStrategy = '';
    }

    /**
     * Convenience helper: clear filters and, if available, trigger a history refresh.
     * This can be wired to a "Clear Filters" button or similar UI control.
     */
    function clearHistoryFiltersAndRefreshHistory() {
        resetHistoryFilters();

        // If a global history-rendering function exists, call it to refresh the view.
        if (typeof renderHistory === 'function') {
            renderHistory();
        }
    }

    // Expose helpers globally so they can be used from inline handlers or other scripts.
    window.resetHistoryFilters = resetHistoryFilters;
    window.clearHistoryFiltersAndRefreshHistory = clearHistoryFiltersAndRefreshHistory;

    // Toast Notification System
    function showToast(message, type = 'info', title = null, duration = 4000, navigationView = null) {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = 'toast';
        
        // Make toast clickable if navigation is provided
        if (navigationView) {
            toast.style.cursor = 'pointer';
            toast.addEventListener('click', function(e) {
                // Don't navigate if clicking the close button
                if (!e.target.closest('.toast-close')) {
                    switchView(navigationView);
                    closeToast();
                }
            });
        }
        
        const icons = {
            success: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>',
            error: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',
            warning: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            info: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>'
        };
        
        const defaultTitles = {
            success: 'Success',
            error: 'Error',
            warning: 'Warning',
            info: 'Info'
        };
        
        const displayTitle = title || defaultTitles[type] || 'Notification';
        
        // Helper to close toast with animation
        function closeToast() {
            toast.classList.add('toast-exit');
            setTimeout(() => toast.remove(), 300);
        }
        
        toast.innerHTML = `
            <div class="toast-icon ${type}">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-title">${escapeHtml(displayTitle)}</div>
                <div class="toast-message">${message}</div>
                ${navigationView ? '<div style="font-size: 10px; color: rgba(255,255,255,0.6); margin-top: 4px;">Click to view</div>' : ''}
            </div>
            <button class="toast-close" aria-label="Close notification"></button>
        `;
        
        // Add click listener for close button
        toast.querySelector('.toast-close').addEventListener('click', closeToast);
        
        container.appendChild(toast);
        
        // Auto-remove after duration
        setTimeout(() => {
            if (toast.parentElement) {
                closeToast();
            }
        }, duration);
        
        return toast;
    }

    // Security: HTML escape function to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function toggleMenu() {
        const menu = document.getElementById('sideMenu');
        const overlay = document.getElementById('overlay');
        const hamburger = document.querySelector('.hamburger');
        
        menu.classList.toggle('active');
        overlay.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    function switchView(view) {
        const gradeView = document.getElementById('gradeView');
        const trackerView = document.getElementById('trackerView');
        const finalizeView = document.getElementById('finalizeView');
        const historyView = document.getElementById('historyView');
        const aiView = document.getElementById('aiView');
        const chatWindow = document.getElementById('chatWindow');
        const gradeBtn = document.getElementById('gradeBtn');
        const trackerBtn = document.getElementById('trackerBtn');
        const finalizeBtn = document.getElementById('finalizeBtn');
        const historyBtn = document.getElementById('historyBtn');
        const aiBtn = document.getElementById('aiBtn');

        // Hide all views and deactivate all buttons
        gradeView.style.display = 'none';
        trackerView.style.display = 'none';
        finalizeView.style.display = 'none';
        historyView.style.display = 'none';
        aiView.style.display = 'none';
        if (chatWindow) chatWindow.style.display = 'none';
        gradeBtn.classList.remove('active');
        trackerBtn.classList.remove('active');
        finalizeBtn.classList.remove('active');
        historyBtn.classList.remove('active');
        aiBtn.classList.remove('active');

        if (view === 'grade') {
            gradeView.style.display = 'block';
            gradeBtn.classList.add('active');
        } else if (view === 'tracker') {
            trackerView.style.display = 'block';
            trackerBtn.classList.add('active');
            initializeTracker();
        } else if (view === 'finalize') {
            finalizeView.style.display = 'block';
            finalizeBtn.classList.add('active');
            loadFinalizeView();
        } else if (view === 'history') {
            historyView.style.display = 'block';
            historyBtn.classList.add('active');
            loadHistory();
        } else if (view === 'ai') {
            aiView.style.display = 'block';
            aiBtn.classList.add('active');
            loadToken();
            // Show chat window when AI view is active
            if (chatWindow) {
                chatWindow.style.display = 'flex';
            }
        }
        
        // Only toggle menu if it's open (for menu button clicks)
        const menu = document.getElementById('sideMenu');
        if (menu.classList.contains('active')) {
            toggleMenu();
        }
    }

    function updateSlider(name, value, max) {
        state[name] = parseInt(value);
        document.getElementById(`${name}-value`).textContent = value;
        
        const slider = document.getElementById(`${name}-slider`);
        const percent = ((value - 1) / (max - 1)) * 100;
        slider.style.background = `linear-gradient(to right, #cc0000 0%, #cc0000 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        
        updateTotal();
    }

    function updateTotal() {
        const total = Object.values(state).reduce((a, b) => a + b, 0);
        document.getElementById('totalScore').textContent = total;
        document.getElementById('progressFill').style.width = `${(total / 100) * 100}%`;
    }

    // Trade Plan Functions
    function continueToTracker() {
        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        
        if (!ticker) {
            showToast('Please enter a ticker symbol', 'warning', 'Missing Ticker');
            return;
        }

        // Store grade data in trade plan state
        trackerState.ticker = ticker;
        trackerState.scores = { ...state };
        trackerState.total = Object.values(state).reduce((a, b) => a + b, 0);
        trackerState.screenshot = currentScreenshot;
        
        // Navigate to trade plan view
        switchView('tracker');
    }

    function initializeTracker() {
        // Display ticker and score
        document.getElementById('trackerTickerLabel').textContent = trackerState.ticker || '---';
        document.getElementById('trackerScoreLabel').textContent = trackerState.total || '--';
        
        // Reset entry price input
        document.getElementById('entryPriceInput').value = '';
        
        // Reset thoughts input
        document.getElementById('tradeThoughtsInput').value = '';
        
        // Initialize slider values and display
        trackerState.stopLossPercent = 7;
        trackerState.profitTargetPercent = 20;
        trackerState.entryPrice = 0;
        trackerState.thoughts = '';
        
        document.getElementById('stopLoss-slider').value = 7;
        document.getElementById('profitTarget-slider').value = 20;
        
        updateTrackerSlider('stopLoss', 7);
        updateTrackerSlider('profitTarget', 20);
        updateTrackerCalculations();
        
        // Add entry price input listener (only once)
        const entryInput = document.getElementById('entryPriceInput');
        if (entryInput && !entryInput._hasTrackerListener) {
            entryInput.addEventListener('input', function() {
                trackerState.entryPrice = parseFloat(this.value) || 0;
                updateTrackerCalculations();
            });
            entryInput._hasTrackerListener = true;
        }
    }

    function updateTrackerSlider(name, value) {
        const floatValue = parseFloat(value);
        
        if (name === 'stopLoss') {
            trackerState.stopLossPercent = floatValue;
            document.getElementById('stopLoss-value').textContent = floatValue + '%';
            
            // Update slider background
            const percent = ((floatValue - 5) / (10 - 5)) * 100;
            document.getElementById('stopLoss-slider').style.background = 
                `linear-gradient(to right, #ff4444 0%, #ff4444 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        } else if (name === 'profitTarget') {
            trackerState.profitTargetPercent = floatValue;
            document.getElementById('profitTarget-value').textContent = floatValue + '%';
            
            // Update slider background
            const percent = ((floatValue - 15) / (30 - 15)) * 100;
            document.getElementById('profitTarget-slider').style.background = 
                `linear-gradient(to right, #00ff00 0%, #00ff00 ${percent}%, #1a1a1a ${percent}%, #1a1a1a 100%)`;
        }
        
        updateTrackerCalculations();
    }

    function updateTrackerCalculations() {
        const entry = trackerState.entryPrice;
        const stopPercent = trackerState.stopLossPercent;
        const targetPercent = trackerState.profitTargetPercent;
        
        if (entry > 0) {
            const stopPrice = entry * (1 - stopPercent / 100);
            const targetPrice = entry * (1 + targetPercent / 100);
            const riskAmount = entry - stopPrice;
            const rewardAmount = targetPrice - entry;
            const rrRatio = riskAmount > 0 ? (rewardAmount / riskAmount).toFixed(1) : 0;
            
            // Update displays
            document.getElementById('stopPriceDisplay').textContent = '$' + stopPrice.toFixed(2);
            document.getElementById('targetPriceDisplay').textContent = '$' + targetPrice.toFixed(2);
            document.getElementById('summaryEntry').textContent = '$' + entry.toFixed(2);
            document.getElementById('summaryStop').textContent = '$' + stopPrice.toFixed(2);
            document.getElementById('summaryTarget').textContent = '$' + targetPrice.toFixed(2);
            document.getElementById('rrRatioValue').textContent = rrRatio;
            
            // Update R:R quality indicator
            const rrQualityEl = document.getElementById('rrQuality');
            const rrNum = parseFloat(rrRatio);
            if (rrNum >= 3) {
                rrQualityEl.textContent = ' Excellent';
                rrQualityEl.style.background = 'rgba(0, 255, 0, 0.3)';
                rrQualityEl.style.color = '#00ff00';
            } else if (rrNum >= 2) {
                rrQualityEl.textContent = ' Good';
                rrQualityEl.style.background = 'rgba(0, 200, 0, 0.3)';
                rrQualityEl.style.color = '#00cc00';
            } else if (rrNum >= 1.5) {
                rrQualityEl.textContent = ' Acceptable';
                rrQualityEl.style.background = 'rgba(255, 204, 0, 0.3)';
                rrQualityEl.style.color = '#ffcc00';
            } else {
                rrQualityEl.textContent = ' Poor';
                rrQualityEl.style.background = 'rgba(255, 68, 68, 0.3)';
                rrQualityEl.style.color = '#ff4444';
            }
        } else {
            // Reset displays when no entry price
            document.getElementById('stopPriceDisplay').textContent = '$0.00';
            document.getElementById('targetPriceDisplay').textContent = '$0.00';
            document.getElementById('summaryEntry').textContent = '$0.00';
            document.getElementById('summaryStop').textContent = '$0.00';
            document.getElementById('summaryTarget').textContent = '$0.00';
            document.getElementById('rrRatioValue').textContent = '0.0';
            
            const rrQualityEl = document.getElementById('rrQuality');
            rrQualityEl.textContent = 'Enter price';
            rrQualityEl.style.background = 'rgba(136, 136, 136, 0.3)';
            rrQualityEl.style.color = '#888';
        }
    }

    function saveTradePlan() {
        if (!trackerState.ticker) {
            showToast('No trade to save. Please grade a stock first.', 'warning', 'Missing Data');
            return;
        }
        
        const entry = trackerState.entryPrice;
        if (!entry || entry <= 0) {
            showToast('Please enter a valid entry price', 'warning', 'Invalid Price');
            return;
        }
        
        // Get the thoughts from the textarea
        const thoughts = document.getElementById('tradeThoughtsInput').value.trim();
        
        const stopPrice = entry * (1 - trackerState.stopLossPercent / 100);
        const targetPrice = entry * (1 + trackerState.profitTargetPercent / 100);
        const riskAmount = entry - stopPrice;
        const rewardAmount = targetPrice - entry;
        const rrRatio = riskAmount > 0 ? parseFloat((rewardAmount / riskAmount).toFixed(1)) : 0;
        
        const trade = {
            id: Date.now().toString(),
            ticker: trackerState.ticker,
            timestamp: new Date().toISOString(),
            grade: {
                scores: trackerState.scores,
                total: trackerState.total
            },
            screenshot: trackerState.screenshot,
            plan: {
                entry: entry,
                stopLoss: parseFloat(stopPrice.toFixed(2)),
                stopPercent: trackerState.stopLossPercent,
                target: parseFloat(targetPrice.toFixed(2)),
                targetPercent: trackerState.profitTargetPercent,
                riskReward: rrRatio,
                thoughts: thoughts
            },
            execution: {
                actualEntry: null,
                actualExit: null,
                outcome: null,
                pnl: null
            }
        };
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.unshift(trade);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        showToast(`Entry: $${entry.toFixed(2)} | Stop: $${stopPrice.toFixed(2)} | Target: $${targetPrice.toFixed(2)}<br>R:R Ratio: ${rrRatio}:1`, 'success', `${trade.ticker} Trade Plan Saved`, 5000, 'history');
        
        // Reset for next trade
        document.getElementById('tickerInput').value = '';
        clearScreenshot();
        resetSliders();
        trackerState.ticker = '';
        trackerState.scores = null;
        trackerState.total = 0;
        trackerState.screenshot = null;
        trackerState.thoughts = '';
        
        // Go back to grade view
        switchView('grade');
    }

    function getGradeLetter(total) {
        if (total >= 90) return 'A';
        if (total >= 75) return 'B';
        if (total >= 60) return 'C';
        return 'D';
    }

    function filterHistory() {
        historyFilterTicker = document.getElementById('historySearchInput').value.trim().toUpperCase();
        historyFilterGrade = document.getElementById('historyGradeFilter').value;
        historyFilterStatus = document.getElementById('historyStatusFilter').value;
        historyFilterStrategy = document.getElementById('historyStrategyFilter').value;
        loadHistory();
    }

    // Screenshot handling functions with size validation
    function handleScreenshot(input) {
        const file = input.files[0];
        if (file) {
            // Validate file size
            if (file.size > CONFIG.MAX_SCREENSHOT_SIZE) {
                showToast(`Maximum size is ${CONFIG.MAX_SCREENSHOT_SIZE / (1024 * 1024)}MB. Please choose a smaller image.`, 'error', 'Screenshot Too Large');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                currentScreenshot = e.target.result;
                document.getElementById('previewImg').src = currentScreenshot;
                document.getElementById('screenshotPreview').style.display = 'block';
                document.getElementById('screenshotBtnText').textContent = 'Change Screenshot';
            };
            reader.onerror = function() {
                showToast('Failed to read the selected file. Please try again with a different screenshot.', 'error', 'File Error');
                clearScreenshot();
            };
            reader.readAsDataURL(file);
        }
    }

    function clearScreenshot() {
        currentScreenshot = null;
        document.getElementById('screenshotPreview').style.display = 'none';
        document.getElementById('screenshotInput').value = '';
        document.getElementById('screenshotBtnText').textContent = 'Add Screenshot';
    }

    function saveGrade() {
        const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
        
        if (!ticker) {
            showToast('Please enter a ticker symbol', 'warning', 'Missing Ticker');
            return;
        }

        const grade = {
            id: Date.now().toString(),
            ticker: ticker,
            timestamp: new Date().toISOString(),
            scores: { ...state },
            total: Object.values(state).reduce((a, b) => a + b, 0),
            screenshot: currentScreenshot
        };

        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.unshift(grade);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));

        showToast(`Score: ${grade.total}/100`, 'success', `${ticker} Saved`);
        
        document.getElementById('tickerInput').value = '';
        clearScreenshot();
        resetSliders();
    }

    function resetSliders() {
        state.pattern = 10;
        state.risk = 10;
        state.entry = 5;
        state.performance = 5;
        state.time = 10;
        state.catalyst = 5;
        state.environment = 5;

        document.getElementById('pattern-slider').value = 10;
        document.getElementById('risk-slider').value = 10;
        document.getElementById('entry-slider').value = 5;
        document.getElementById('performance-slider').value = 5;
        document.getElementById('time-slider').value = 10;
        document.getElementById('catalyst-slider').value = 5;
        document.getElementById('environment-slider').value = 5;

        updateSlider('pattern', 10, 20);
        updateSlider('risk', 10, 20);
        updateSlider('entry', 5, 10);
        updateSlider('performance', 5, 10);
        updateSlider('time', 10, 20);
        updateSlider('catalyst', 5, 10);
        updateSlider('environment', 5, 10);
    }

    function loadHistory() {
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const container = document.getElementById('historyContainer');

        // Populate strategy filter dropdown with unique strategies
        const strategySet = new Set();
        for (const g of grades) {
            if (g && g.outcome && g.outcome.strategy) {
                strategySet.add(g.outcome.strategy);
            }
        }
        const strategies = Array.from(strategySet);
        const strategyFilter = document.getElementById('historyStrategyFilter');
        if (strategyFilter) {
            const currentValue = strategyFilter.value;
            strategyFilter.innerHTML = '<option value="">All Strategies</option>' + 
                strategies.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
            strategyFilter.value = currentValue;
        }

        // Apply filters
        if (historyFilterTicker) {
            grades = grades.filter(g => g.ticker === historyFilterTicker);
        }
        if (historyFilterGrade) {
            grades = grades.filter(g => {
                const total = g.total || (g.grade ? g.grade.total : 0);
                const letter = getGradeLetter(total);
                return letter === historyFilterGrade;
            });
        }
        if (historyFilterStatus) {
            if (historyFilterStatus === 'finalized') {
                grades = grades.filter(g => g.finalized === true);
            } else if (historyFilterStatus === 'non-finalized') {
                grades = grades.filter(g => !g.finalized);
            }
        }
        if (historyFilterStrategy) {
            grades = grades.filter(g => g.outcome && g.outcome.strategy === historyFilterStrategy);
        }

        if (grades.length === 0) {
            const hasFilters = historyFilterTicker || historyFilterGrade || historyFilterStatus || historyFilterStrategy;
            container.innerHTML = `
                <div class="card empty-state" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                            <polyline points="17 6 23 6 23 12"/>
                        </svg>
                    </div>
                    <div class="empty-text">${hasFilters ? 'No trades match your filters' : 'No trades saved yet'}</div>
                    <div class="empty-subtext">${hasFilters ? 'Try adjusting your search criteria' : 'Start grading stocks to build your history'}</div>
                </div>
            `;
            return;
        }

        container.innerHTML = grades.map((grade, index) => {
            // Handle both old format (scores at top level) and new format (grade.scores)
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const hasPlan = grade.plan && grade.plan.entry;
            const isFinalized = grade.finalized === true;
            const gradeLetter = getGradeLetter(total);
            const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
            
            // Finalized status badge
            let statusBadge = '';
            let outcomeDisplay = '';
            if (isFinalized && grade.outcome) {
                const isWin = grade.outcome.result === 'target';
                const pnl = grade.outcome.pnlPercent;
                const pnlColor = isWin ? '#00ff00' : '#ff4444';
                const pnlIcon = isWin ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><polyline points="20 6 9 17 4 12"></polyline></svg>' : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                statusBadge = `<span style="color: ${pnlColor}; font-size: 16px; margin-left: 4px;">${pnlIcon}</span>`;
                outcomeDisplay = `<span style="color: ${pnlColor}; font-weight: 600; font-size: 12px;">${isWin ? '+' : ''}${pnl.toFixed(1)}%</span>`;
            } else if (hasPlan && !isFinalized) {
                statusBadge = '<span style="color: #888; font-size: 16px; margin-left: 4px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="vertical-align: middle;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></span>';
            }
            
            return `
            <div class="history-item" data-index="${index}" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="showTradeDetailsModal(${index})">
                <div class="history-left">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="history-ticker">${escapeHtml(grade.ticker)}</div>
                        <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;">${gradeLetter}</span>
                        ${statusBadge}
                        ${outcomeDisplay}
                    </div>
                    ${hasPlan ? `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; font-size: 10px;">
                        <div style="text-align: center; padding: 4px; background: rgba(255, 204, 0, 0.15); border-radius: 4px;">
                            <div style="color: #ffcc00;">ENTRY</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(255, 68, 68, 0.15); border-radius: 4px; ${isFinalized && grade.outcome && grade.outcome.result === 'stop' ? 'border: 2px solid #ff4444;' : ''}">
                            <div style="color: #ff4444;">STOP</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.stopLoss.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(0, 255, 0, 0.15); border-radius: 4px; ${isFinalized && grade.outcome && grade.outcome.result === 'target' ? 'border: 2px solid #00ff00;' : ''}">
                            <div style="color: #00ff00;">TARGET</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.target.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 6px; text-align: center; font-size: 11px; color: #888;">
                        R:R <span style="color: white; font-weight: 600;">${grade.plan.riskReward}:1</span>
                        ${grade.plan.thoughts ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-left: 8px;"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' : ''}
                    </div>
                    ${isFinalized && grade.outcome ? `
                        <div style="margin-top: 4px; text-align: center; font-size: 10px;">
                            ${grade.outcome.strategy ? `<span style="color: #6495ed;">Strategy: ${escapeHtml(grade.outcome.strategy)}</span>` : ''}
                            ${grade.outcome.positionSize ? `<span style="color: #888; margin-left: 8px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg><span role="img" aria-label="Position size">${grade.outcome.positionSize} ${grade.outcome.positionUnit ?? 'shares'}</span></span>` : ''}
                        </div>
                    ` : ''}
                    ` : `
                    <div class="history-grades-grid" style="margin-top: 8px;">
                        <div class="history-grade-item">
                            <span class="history-grade-letter">P</span>
                            <span class="history-grade-value">${scores.pattern || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">R</span>
                            <span class="history-grade-value">${scores.risk || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">E</span>
                            <span class="history-grade-value">${scores.entry || 0}</span>
                        </div>
                        <div class="history-grade-item">
                            <span class="history-grade-letter">P</span>
                            <span class="history-grade-value">${scores.performance || 0}</span>
                        </div>
                    </div>
                    `}
                </div>
                <div class="history-center">
                    <div class="history-score-value">${total}</div>
                </div>
                <div class="history-right">
                    ${grade.screenshot && grade.screenshot.startsWith('data:image/') ? `
                        <img src="${encodeURI(grade.screenshot)}" class="history-screenshot" onclick="event.stopPropagation(); showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                    ` : `
                        <div class="history-no-screenshot">No screenshot</div>
                    `}
                </div>
                <div class="history-footer">
                    <button class="delete-btn history-analyze-btn" style="flex: 1;" data-index="${index}">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="7.5" cy="14.5" r="1.5" fill="currentColor"/><circle cx="16.5" cy="14.5" r="1.5" fill="currentColor"/></svg>
                        Analyze
                    </button>
                    <button class="delete-btn history-delete-btn" style="flex: 1;" data-index="${index}">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                        Delete
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }

    const historyContainer = document.getElementById('historyContainer');
    if (historyContainer) {
        historyContainer.addEventListener('click', function (event) {
            const analyzeButton = event.target.closest('button.history-analyze-btn');
            const deleteButton = event.target.closest('button.history-delete-btn');

            if (analyzeButton && historyContainer.contains(analyzeButton)) {
                event.stopPropagation();
                const index = parseInt(analyzeButton.getAttribute('data-index'), 10);
                if (!Number.isNaN(index)) {
                    analyzeGradeWithAI(index);
                }
            } else if (deleteButton && historyContainer.contains(deleteButton)) {
                event.stopPropagation();
                const index = parseInt(deleteButton.getAttribute('data-index'), 10);
                if (!Number.isNaN(index)) {
                    deleteGrade(index);
                }
            }
        });
    }
    
    function viewScreenshot(gradeIdOrIndex) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        // Try to find by ID first, then fall back to index for legacy grades
        let grade = grades.find(g => g.id === gradeIdOrIndex);
        if (!grade) {
            const index = parseInt(gradeIdOrIndex, 10);
            if (!isNaN(index) && index >= 0 && index < grades.length) {
                grade = grades[index];
            }
        }
        if (grade && grade.screenshot) {
            showImageViewer(grade.screenshot);
        }
    }

    function showImageViewer(imageData) {
        const modal = document.getElementById('imageViewerModal');
        const img = document.getElementById('fullScreenImage');
        img.src = imageData;
        modal.classList.add('active');
    }

    function hideImageViewer() {
        const modal = document.getElementById('imageViewerModal');
        modal.classList.remove('active');
        document.getElementById('fullScreenImage').src = '';
    }

    // GitHub Token Modal functions
    function showGithubTokenModal() {
        const modal = document.getElementById('githubTokenModal');
        const input = document.getElementById('githubTokenInput');
        // Load existing token if available
        const token = localStorage.getItem('githubToken');
        if (token) {
            input.value = token;
        }
        modal.classList.add('active');
        input.focus();
    }

    function hideGithubTokenModal() {
        const modal = document.getElementById('githubTokenModal');
        modal.classList.remove('active');
        // Don't clear the input - preserve it in case user reopens
    }

    async function saveGithubToken() {
        const token = document.getElementById('githubTokenInput').value.trim();
        if (token) {
            localStorage.setItem('githubToken', token);
            document.getElementById('githubTokenInput').value = ''; // Clear for security after save
            hideGithubTokenModal();
            
            // Update status displays
            updateGithubTokenStatus(true, 'Token configured');
            updateModelStatus('loading', 'Loading models...', '#ff9800');
            
            showToast('Token saved, fetching available models...', 'success', 'Token Saved');
            
            // Fetch and cache user avatar
            await fetchAndCacheUserAvatar(token);
            
            await fetchAvailableModels(token);
        } else {
            showToast('Please enter a valid token', 'warning', 'Invalid Token');
        }
    }

    // Fetch and cache GitHub user avatar
    async function fetchAndCacheUserAvatar(token) {
        try {
            const response = await fetch('https://api.github.com/user', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const userData = await response.json();
                if (userData.avatar_url) {
                    // Cache the avatar URL and username
                    localStorage.setItem('githubAvatarUrl', userData.avatar_url);
                    localStorage.setItem('githubUsername', userData.login || 'User');
                    console.log('GitHub avatar cached:', userData.avatar_url);
                }
            } else {
                console.warn('Could not fetch GitHub user info:', response.status);
            }
        } catch (error) {
            console.error('Error fetching GitHub user avatar:', error);
        }
    }

    // Get cached user avatar URL
    function getUserAvatarUrl() {
        return localStorage.getItem('githubAvatarUrl');
    }

    // Get Copilot SVG for AI avatar
    function getCopilotSvg() {
        return `<svg viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
        </svg>`;
    }

    // API Token Modal functions
    function showApiTokenModal() {
        const modal = document.getElementById('apiTokenModal');
        modal.classList.add('active');
    }

    function hideApiTokenModal() {
        const modal = document.getElementById('apiTokenModal');
        modal.classList.remove('active');
    }

    // Market API Modal functions
    function showMarketApiModal() {
        const modal = document.getElementById('marketApiModal');
        modal.classList.add('active');
    }

    function hideMarketApiModal() {
        const modal = document.getElementById('marketApiModal');
        modal.classList.remove('active');
    }

    // Quick Actions Popup functions
    function toggleQuickActionsPopup(event) {
        event.stopPropagation();
        const popup = document.getElementById('quickActionsPopup');
        popup.classList.toggle('active');
        
        // Close popup when clicking outside
        if (popup.classList.contains('active')) {
            document.addEventListener('click', closeQuickActionsPopupOnOutsideClick);
        }
    }

    function hideQuickActionsPopup() {
        const popup = document.getElementById('quickActionsPopup');
        popup.classList.remove('active');
        document.removeEventListener('click', closeQuickActionsPopupOnOutsideClick);
    }

    function closeQuickActionsPopupOnOutsideClick(event) {
        const popup = document.getElementById('quickActionsPopup');
        const moreBtn = event.target.closest('.more-menu-btn');
        if (!popup.contains(event.target) && !moreBtn) {
            hideQuickActionsPopup();
        }
    }

    // Usage Stats tracking
    let usageStats = {
        messages: 0,
        searches: 0,
        tokensUsed: 0
    };

    function updateUsageStats(type, value) {
        if (type === 'message') {
            usageStats.messages++;
            document.getElementById('statMessages').textContent = usageStats.messages;
        } else if (type === 'search') {
            usageStats.searches++;
            document.getElementById('statSearches').textContent = usageStats.searches;
        } else if (type === 'tokens') {
            usageStats.tokensUsed += value;
            // Format large numbers: show "1.2k" for 1200+ tokens for compact display
            const formatted = usageStats.tokensUsed > 1000 
                ? (usageStats.tokensUsed / 1000).toFixed(1) + 'k' 
                : usageStats.tokensUsed.toString();
            document.getElementById('statTokensUsed').textContent = formatted;
        } else if (type === 'model') {
            // Shorten model name for display (max 8 chars to fit stat card width)
            const shortName = value.split('/').pop().split('-')[0].substring(0, 8);
            document.getElementById('statModel').textContent = shortName || '--';
        }
    }

    // Load non-finalized trades for finalization
    function loadFinalizeView() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const container = document.getElementById('finalizeContainer');

        // Filter for non-finalized trades that have plans
        const nonFinalizedTrades = grades.filter(g => {
            const hasPlan = g.plan && g.plan.entry;
            const isFinalized = g.finalized === true;
            return hasPlan && !isFinalized;
        });

        if (nonFinalizedTrades.length === 0) {
            container.innerHTML = `
                <div class="card empty-state" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
                    <div class="empty-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="1.5">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                    </div>
                    <div class="empty-text">No trades to finalize</div>
                    <div class="empty-subtext">Create and save trade plans to track their outcomes</div>
                </div>
            `;
            return;
        }

        container.innerHTML = nonFinalizedTrades.map(grade => {
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const gradeLetter = getGradeLetter(total);
            const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
            const originalIndex = grades.indexOf(grade);
            
            return `
            <div class="history-item" style="background: linear-gradient(135deg, rgba(40, 40, 40, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer;" onclick="showFinalizeModal(${originalIndex})">
                <div class="history-left">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="history-ticker">${escapeHtml(grade.ticker)}</div>
                        <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;">${gradeLetter}</span>
                        <span style="color: #ffcc00; font-size: 11px;">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 2px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span role="img" aria-label="Pending">Pending</span>
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; font-size: 10px;">
                        <div style="text-align: center; padding: 4px; background: rgba(255, 204, 0, 0.15); border-radius: 4px;">
                            <div style="color: #ffcc00;">ENTRY</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(255, 68, 68, 0.15); border-radius: 4px;">
                            <div style="color: #ff4444;">STOP</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.stopLoss.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 4px; background: rgba(0, 255, 0, 0.15); border-radius: 4px;">
                            <div style="color: #00ff00;">TARGET</div>
                            <div style="color: white; font-weight: 600;">$${grade.plan.target.toFixed(2)}</div>
                        </div>
                    </div>
                    <div style="margin-top: 6px; text-align: center; font-size: 11px; color: #888;">
                        R:R <span style="color: white; font-weight: 600;">${grade.plan.riskReward}:1</span>
                    </div>
                </div>
                <div class="history-center">
                    <div class="history-score-value">${total}</div>
                </div>
                <div class="history-right">
                    ${grade.screenshot && grade.screenshot.startsWith('data:image/') ? `
                        <img src="${encodeURI(grade.screenshot)}" class="history-screenshot" onclick="event.stopPropagation(); showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                    ` : `
                        <div class="history-no-screenshot">No screenshot</div>
                    `}
                </div>
            </div>
        `;
        }).join('');
    }

    // Show finalize modal with reject/accept options
    function showFinalizeModal(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        
        if (!grade) return;
        
        currentFinalizeTradeIndex = index;
        const modal = document.getElementById('finalizeTradeModal');
        document.getElementById('finalizeModalTicker').textContent = grade.ticker;
        
        // Show initial choice: Reject or Accept
        document.getElementById('finalizeModalContent').innerHTML = `
            <div style="text-align: center; padding: 16px 0;">
                <p style="margin-bottom: 16px; line-height: 1.5;">Did you execute this trade?</p>
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 11px; color: #888; margin-bottom: 4px;">TRADE PLAN</div>
                    <div style="display: flex; justify-content: space-around; font-size: 12px;">
                        <div><span style="color: #ffcc00;">Entry:</span> $${grade.plan.entry.toFixed(2)}</div>
                        <div><span style="color: #ff4444;">Stop:</span> $${grade.plan.stopLoss.toFixed(2)}</div>
                        <div><span style="color: #00ff00;">Target:</span> $${grade.plan.target.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('finalizeModalButtons').innerHTML = `
            <button class="modal-btn" onclick="rejectTrade()" style="flex: 1; background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3);">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                Rejected (Not Taken)
            </button>
            <button class="modal-btn modal-btn-confirm" onclick="showAcceptForm()" style="flex: 1;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Accepted (Executed)
            </button>
        `;
        
        modal.classList.add('active');
    }

    function hideFinalizeModal() {
        document.getElementById('finalizeTradeModal').classList.remove('active');
        currentFinalizeTradeIndex = null;
    }

    // Reject trade - delete it from the journal
    function rejectTrade() {
        if (currentFinalizeTradeIndex === null) return;
        
        if (!confirm('Are you sure you want to reject this trade? It will be deleted from your journal.')) {
            return;
        }
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        grades.splice(currentFinalizeTradeIndex, 1);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        showToast(`Trade plan deleted`, 'info', `${grade.ticker} Rejected`, 4000, 'history');
        hideFinalizeModal();
        loadFinalizeView();
    }

    // Show form to accept trade and enter details
    function showAcceptForm() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        if (!grade) return;
        
        document.getElementById('finalizeModalContent').innerHTML = `
            <div style="margin-bottom: 12px;">
                <label class="label-text">Which target was satisfied?</label>
                <div style="display: flex; gap: 8px; margin-top: 4px;">
                    <button id="stopLossBtn" class="modal-btn" onclick="selectOutcome('stop')" aria-label="Select Stop Loss" style="flex: 1; background: rgba(255, 68, 68, 0.2); color: #ff4444; border: 1px solid rgba(255, 68, 68, 0.3);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Stop Loss<br>
                        <span style="font-size: 10px;">$${grade.plan.stopLoss.toFixed(2)} (-${grade.plan.stopPercent}%)</span>
                    </button>
                    <button id="targetBtn" class="modal-btn modal-btn-confirm" onclick="selectOutcome('target')" aria-label="Select Profit Target" style="flex: 1;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 8v8m-4-4h8"></path>
                        </svg>
                        Profit Target<br>
                        <span style="font-size: 10px;">$${grade.plan.target.toFixed(2)} (+${grade.plan.targetPercent}%)</span>
                    </button>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                    <label class="label-text">Position Size</label>
                    <input type="number" id="positionSizeInput" class="ticker-input" placeholder="e.g., 100" min="1" style="text-transform: none; font-size: 12px; padding: 8px;">
                </div>
                <div>
                    <label class="label-text">Unit</label>
                    <select id="positionUnitSelect" class="ticker-input" style="text-transform: none; font-size: 12px; padding: 8px; cursor: pointer;">
                        <option value="shares">Shares</option>
                        <option value="contracts">Contracts</option>
                        <option value="lots">Lots</option>
                    </select>
                </div>
            </div>
            <div style="margin-bottom: 12px;">
                <label class="label-text">Strategy Used</label>
                <textarea id="strategyInput" class="ticker-input" placeholder="e.g., 52w High Breakout, Support Bounce, etc." style="text-transform: none; font-size: 12px; min-height: 60px; resize: vertical;"></textarea>
            </div>
            <input type="hidden" id="selectedOutcome" value="">
        `;
        
        document.getElementById('finalizeModalButtons').innerHTML = `
            <button class="modal-btn modal-btn-cancel" onclick="showFinalizeModal(${currentFinalizeTradeIndex})">
                Back
            </button>
            <button class="modal-btn modal-btn-confirm" onclick="acceptTrade()">
                Finalize Trade
            </button>
        `;
    }

    function selectOutcome(outcome) {
        document.getElementById('selectedOutcome').value = outcome;
        
        // Visual feedback
        const stopBtn = document.getElementById('stopLossBtn');
        const targetBtn = document.getElementById('targetBtn');
        
        if (outcome === 'stop') {
            stopBtn.style.border = '2px solid #ff4444';
            stopBtn.style.background = 'rgba(255, 68, 68, 0.3)';
            targetBtn.style.border = '1px solid rgba(0, 255, 0, 0.3)';
            targetBtn.style.background = 'rgba(0, 255, 0, 0.2)';
        } else {
            targetBtn.style.border = '2px solid #00ff00';
            targetBtn.style.background = 'rgba(0, 255, 0, 0.3)';
            stopBtn.style.border = '1px solid rgba(255, 68, 68, 0.3)';
            stopBtn.style.background = 'rgba(255, 68, 68, 0.2)';
        }
    }

    // Accept trade and finalize with outcome
    function acceptTrade() {
        if (currentFinalizeTradeIndex === null) return;
        
        const outcome = document.getElementById('selectedOutcome').value;
        const strategy = document.getElementById('strategyInput').value.trim();
        const positionSize = document.getElementById('positionSizeInput').value.trim();
        const positionUnit = document.getElementById('positionUnitSelect').value;
        
        if (!outcome) {
            showToast('Please select which target was satisfied', 'warning', 'Missing Information');
            return;
        }
        
        if (!strategy) {
            showToast('Please enter the strategy you used', 'warning', 'Missing Strategy');
            return;
        }
        
        const parsedPositionSize = parseFloat(positionSize);
        if (!positionSize || isNaN(parsedPositionSize) || parsedPositionSize <= 0) {
            showToast('Please enter a valid position size', 'warning', 'Missing Position Size');
            return;
        }
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[currentFinalizeTradeIndex];
        
        // Calculate P&L
        const entryPrice = grade.plan.entry;
        const exitPrice = outcome === 'stop' ? grade.plan.stopLoss : grade.plan.target;
        const pnlPercent = outcome === 'stop' ? -grade.plan.stopPercent : grade.plan.targetPercent;
        
        // Update grade with finalization data
        grade.finalized = true;
        grade.finalizedAt = new Date().toISOString();
        grade.outcome = {
            result: outcome,
            exitPrice: exitPrice,
            pnlPercent: pnlPercent,
            strategy: strategy,
            positionSize: parsedPositionSize,
            positionUnit: positionUnit
        };
        
        grades[currentFinalizeTradeIndex] = grade;
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        
        const outcomeText = outcome === 'stop' ? `Loss: -${grade.plan.stopPercent}%` : `Win: +${grade.plan.targetPercent}%`;
        showToast(`Exit: $${exitPrice.toFixed(2)} | ${outcomeText}<br>Strategy: ${strategy}<br>Position: ${parsedPositionSize} ${positionUnit}`, 'success', `${grade.ticker} Trade Finalized`, 5000, 'history');
        
        hideFinalizeModal();
        loadFinalizeView();
        if (typeof loadHistory === 'function') {
            loadHistory();
        }
    }


    function analyzeGradeWithAI(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        if (grade) {
            // Handle both old format (scores at top level) and new format (grade.scores)
            const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
            const total = grade.total || (grade.grade ? grade.grade.total : 0);
            const hasPlan = grade.plan && grade.plan.entry;
            
            // Set the prompt value directly since DOM is already loaded
            const aiPrompt = document.getElementById('aiPrompt');
            if (aiPrompt) {
                let prompt = `Analyze this trade grade for ${grade.ticker}:\nTotal Score: ${total}/100\nPattern: ${scores.pattern || 0}/20\nRisk/Reward: ${scores.risk || 0}/20\nEntry/Exit: ${scores.entry || 0}/10\nPast Performance: ${scores.performance || 0}/10\nTiming: ${scores.time || 0}/20\nCatalyst: ${scores.catalyst || 0}/10\nEnvironment: ${scores.environment || 0}/10`;
                
                if (hasPlan) {
                    prompt += `\n\nTrade Plan:\nEntry: $${grade.plan.entry.toFixed(2)}\nStop Loss: $${grade.plan.stopLoss.toFixed(2)} (${grade.plan.stopPercent}%)\nTarget: $${grade.plan.target.toFixed(2)} (${grade.plan.targetPercent}%)\nRisk/Reward Ratio: ${grade.plan.riskReward}:1`;
                }
                
                prompt += '\n\nProvide insights and suggestions for improvement.';
                aiPrompt.value = prompt;
            }
            switchView('ai');
        }
    }

    function deleteGrade(index) {
        if (!confirm('Delete this grade?')) return;
        
        let grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        grades.splice(index, 1);
        localStorage.setItem('prepareGrades', JSON.stringify(grades));
        loadHistory();
    }

    // Ticker Modal functions
    function showTickerModal() {
        document.getElementById('tickerModal').classList.add('active');
        document.getElementById('tickerModalInput').value = '';
        document.getElementById('tickerModalInput').focus();
    }

    function hideTickerModal() {
        document.getElementById('tickerModal').classList.remove('active');
    }

    function confirmTickerAnalysis() {
        const ticker = document.getElementById('tickerModalInput').value.trim().toUpperCase();
        if (ticker) {
            document.getElementById('aiPrompt').value = `Analyze ${ticker} for trading:\n- Technical setup quality\n- Key support/resistance levels\n- Recent price action\n- Volume analysis\n- Risk/reward for entry today\n\nProvide a PREPARE score estimate.`;
            hideTickerModal();
            // Auto-trigger the send
            askAI();
        }
    }

    // Trade Details Modal functions
    function showTradeDetailsModal(index) {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        const grade = grades[index];
        
        if (!grade) return;
        
        const scores = grade.scores || (grade.grade ? grade.grade.scores : {});
        const total = grade.total || (grade.grade ? grade.grade.total : 0);
        const hasPlan = grade.plan && grade.plan.entry;
        const isFinalized = grade.finalized === true;
        const gradeLetter = getGradeLetter(total);
        const gradeColor = gradeLetter === 'A' ? '#00ff00' : gradeLetter === 'B' ? '#00cc00' : gradeLetter === 'C' ? '#ffcc00' : '#ff4444';
        
        // Build the modal content
        let content = `
            <div style="margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; justify-content: center; margin-bottom: 12px;">
                    <span style="font-size: 24px; font-weight: 700; color: white;">${escapeHtml(grade.ticker)}</span>
                    <span style="background: ${gradeColor}22; color: ${gradeColor}; padding: 4px 12px; border-radius: 8px; font-size: 14px; font-weight: 700;">${gradeLetter} - ${total}/100</span>
                </div>
                <div style="font-size: 10px; color: #888; text-align: center;">
                    ${new Date(grade.timestamp).toLocaleString()}
                </div>
            </div>
        `;
        
        // Add finalized status if applicable
        if (isFinalized && grade.outcome) {
            const isWin = grade.outcome.result === 'target';
            const pnl = grade.outcome.pnlPercent;
            const pnlColor = isWin ? '#00ff00' : '#ff4444';
            const statusText = isWin ? 'WIN' : 'LOSS';
            
            content += `
                <div style="background: ${isWin ? 'rgba(0, 255, 0, 0.15)' : 'rgba(255, 68, 68, 0.15)'}; padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid ${pnlColor};">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: ${pnlColor}; font-weight: 700; margin-bottom: 4px;">${statusText}: ${isWin ? '+' : ''}${pnl.toFixed(1)}%</div>
                        <div style="font-size: 11px; color: #888;">Exit Price: $${grade.outcome.exitPrice.toFixed(2)}</div>
                        <div style="font-size: 11px; color: #888;">Finalized: ${new Date(grade.finalizedAt).toLocaleString()}</div>
                    </div>
                </div>
            `;
        } else if (hasPlan && !isFinalized) {
            content += `
                <div style="background: rgba(255, 204, 0, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid rgba(255, 204, 0, 0.3);">
                    <div style="text-align: center;">
                        <div style="font-size: 14px; color: #ffcc00; font-weight: 700;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <span role="img" aria-label="Pending">PENDING FINALIZATION</span>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">Visit "Finalize Trades" to record the outcome</div>
                    </div>
                </div>
            `;
        }
        
        // Add PREPARE scores
        content += `
            <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">PREPARE Scores</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 11px;">
                    <div><span style="color: #cc0000; font-weight: 600;">P</span> Pattern: <span style="color: white;">${scores.pattern || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">R</span> Risk: <span style="color: white;">${scores.risk || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">E</span> Entry: <span style="color: white;">${scores.entry || 0}/10</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">P</span> Performance: <span style="color: white;">${scores.performance || 0}/10</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">A</span> Timing: <span style="color: white;">${scores.time || 0}/20</span></div>
                    <div><span style="color: #cc0000; font-weight: 600;">R</span> Catalyst: <span style="color: white;">${scores.catalyst || 0}/10</span></div>
                    <div style="grid-column: 1 / -1;"><span style="color: #cc0000; font-weight: 600;">E</span> Environment: <span style="color: white;">${scores.environment || 0}/10</span></div>
                </div>
            </div>
        `;
        
        // Add trade plan if available
        if (hasPlan) {
            content += `
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">Trade Plan</div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="text-align: center; padding: 8px; background: rgba(255, 204, 0, 0.15); border-radius: 6px;">
                            <div style="color: #ffcc00; font-size: 10px;">ENTRY</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.entry.toFixed(2)}</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(255, 68, 68, 0.15); border-radius: 6px; ${isFinalized && grade.outcome && grade.outcome.result === 'stop' ? 'border: 2px solid #ff4444;' : ''}">
                            <div style="color: #ff4444; font-size: 10px;">STOP</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.stopLoss.toFixed(2)}</div>
                            <div style="color: #ff4444; font-size: 9px;">${grade.plan.stopPercent}%</div>
                        </div>
                        <div style="text-align: center; padding: 8px; background: rgba(0, 255, 0, 0.15); border-radius: 6px; ${isFinalized && grade.outcome && grade.outcome.result === 'target' ? 'border: 2px solid #00ff00;' : ''}">
                            <div style="color: #00ff00; font-size: 10px;">TARGET</div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">$${grade.plan.target.toFixed(2)}</div>
                            <div style="color: #00ff00; font-size: 9px;">${grade.plan.targetPercent}%</div>
                        </div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: rgba(100, 149, 237, 0.15); border-radius: 6px;">
                        <span style="color: #6495ed; font-size: 10px;">RISK/REWARD RATIO: </span>
                        <span style="color: white; font-weight: 600; font-size: 14px;">${grade.plan.riskReward}:1</span>
                    </div>
                </div>
            `;
            
            // Add strategy and position size if finalized
            if (isFinalized && grade.outcome) {
                if (grade.outcome.strategy || grade.outcome.positionSize) {
                    content += `
                        <div style="background: rgba(100, 149, 237, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                            ${grade.outcome.strategy ? `
                                <div style="margin-bottom: ${grade.outcome.positionSize ? '8px' : '0'};">
                                    <div style="font-weight: 600; margin-bottom: 4px; color: #6495ed; font-size: 11px;">STRATEGY USED</div>
                                    <div style="font-size: 12px; line-height: 1.5; color: #e0e0e0;">${escapeHtml(grade.outcome.strategy)}</div>
                                </div>
                            ` : ''}
                            ${grade.outcome.positionSize ? `
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px; color: #6495ed; font-size: 11px;">POSITION SIZE</div>
                                    <div style="font-size: 12px; line-height: 1.5; color: #e0e0e0;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                                            <rect x="3" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="14" width="7" height="7"></rect>
                                            <rect x="3" y="14" width="7" height="7"></rect>
                                        </svg>
                                        <span role="img" aria-label="Position size">${grade.outcome.positionSize} ${grade.outcome.positionUnit ?? 'shares'}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
            }
            
            // Add trade thoughts if available
            if (grade.plan.thoughts) {
                content += `
                    <div style="background: rgba(100, 149, 237, 0.15); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #6495ed; display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6495ed" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Trade Thoughts</span>
                        </div>
                        <div style="font-size: 11px; line-height: 1.5; color: #e0e0e0; white-space: pre-wrap;">${escapeHtml(grade.plan.thoughts)}</div>
                    </div>
                `;
            }
        }
        
        // Add screenshot if available
        if (grade.screenshot && grade.screenshot.startsWith('data:image/')) {
            content += `
                <div style="background: rgba(40, 40, 40, 0.5); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #cc0000;">Screenshot</div>
                    <img src="${encodeURI(grade.screenshot)}" style="width: 100%; border-radius: 6px; cursor: pointer;" onclick="showImageViewer('${encodeURI(grade.screenshot).replace(/'/g, "\\'")}');" alt="Trade screenshot for ${escapeHtml(grade.ticker)}">
                </div>
            `;
        }
        
        document.getElementById('tradeDetailsTitle').textContent = `${grade.ticker} - Trade Details`;
        document.getElementById('tradeDetailsContent').innerHTML = content;
        document.getElementById('tradeDetailsModal').classList.add('active');
    }

    function hideTradeDetailsModal() {
        document.getElementById('tradeDetailsModal').classList.remove('active');
    }

    // AI Assistant functions
    // Legacy function - kept for compatibility but now uses modal
    async function saveToken() {
        // This function is no longer directly called from UI
        // Token saving is handled by saveGithubToken in the modal
    }

    // Update model status display - now updates stats card
    function updateModelStatus(status, message, iconColor) {
        // The model status is now shown in the stats card
        // Keep function for backwards compatibility but update the active model display
        const statModel = document.getElementById('statModel');
        if (statModel) {
            if (status === 'ready') {
                // Will be updated when a model is selected/used
            } else if (status === 'loading') {
                statModel.textContent = '...';
            } else if (status === 'error') {
                statModel.textContent = '!';
            } else {
                statModel.textContent = '--';
            }
        }
    }

    // Update GitHub token status display
    function updateGithubTokenStatus(hasToken, message) {
        const statusText = document.getElementById('githubTokenStatusText');
        
        if (statusText) {
            statusText.textContent = message || (hasToken ? 'Token configured' : 'Click to configure');
            statusText.style.color = hasToken ? '#00bfa5' : '#666';
        }
    }

    function loadToken() {
        const token = localStorage.getItem('githubToken');
        if (token) {
            // Update token status
            updateGithubTokenStatus(true, 'Token configured');
            // Fetch avatar if not already cached
            if (!localStorage.getItem('githubAvatarUrl')) {
                fetchAndCacheUserAvatar(token);
            }
            // Fetch models on load if token exists
            fetchAvailableModels(token);
        } else {
            // No token available, clear model picker
            updateGithubTokenStatus(false);
            updateModelStatus('none', 'Configure token first', '#666');
            clearModelPicker();
        }
    }

    async function fetchAvailableModels(token) {
        updateModelStatus('loading', 'Loading models...', '#ff9800');
        
        try {
            // Use GitHub REST API to get models enabled for the user
            // This endpoint returns models the user has access to in their account
            const response = await fetch('https://api.github.com/models', {
                headers: {
                    'Accept': 'application/vnd.github+json',
                    'Authorization': `Bearer ${token}`,
                    'X-GitHub-Api-Version': '2022-11-28'
                }
            });

            if (response.ok) {
                const data = await response.json();
                // The API returns { models: [...] } structure
                const models = Array.isArray(data) ? data : (data.models || data);
                
                // Filter to only chat/text models (exclude image/audio models)
                const chatModels = models.filter(m => {
                    const task = (m.task || m.model_type || '').toLowerCase();
                    const name = (m.name || m.id || '').toLowerCase();
                    // Include chat-completion models and general LLMs
                    return task.includes('chat') || 
                           task.includes('text') || 
                           task.includes('completion') ||
                           name.includes('gpt') ||
                           name.includes('claude') ||
                           name.includes('gemini') ||
                           name.includes('llama') ||
                           name.includes('mistral') ||
                           name.includes('phi') ||
                           name.includes('grok') ||
                           name.includes('codex') ||
                           name.includes('cohere');
                });
                
                console.log('Available models from GitHub API:', models.length);
                console.log('Filtered chat models:', chatModels.length);
                
                // If we got models, use them
                const modelsToUse = chatModels.length > 0 ? chatModels : models;
                
                if (modelsToUse.length === 0) {
                    showToast('No models found. Please enable models in your GitHub account settings.', 'warning', 'No Models');
                    updateModelStatus('error', 'No models enabled', '#ff4444');
                    clearModelPicker();
                    return;
                }
                
                // Show the first few model names in the toast
                const modelNamesToShow = modelsToUse.slice(0, 3).map(m => m.friendly_name || m.display_name || m.name);
                const moreText = modelsToUse.length > 3 ? ` and ${modelsToUse.length - 3} more` : '';
                showToast(`Models: ${modelNamesToShow.join(', ')}${moreText}`, 'success', `${modelsToUse.length} Models Loaded`, 5000);
                
                // Update status to show models are ready
                updateModelStatus('ready', `${modelsToUse.length} models ready`, '#00bfa5');
                
                localStorage.setItem('availableModels', JSON.stringify(modelsToUse));
                // Populate the model picker with fetched models
                populateModelPicker(modelsToUse);
            } else if (response.status === 401) {
                console.error('Authentication failed:', response.status);
                showToast('Invalid GitHub token. Please check your token has the correct permissions.', 'error', 'Auth Error');
                updateModelStatus('error', 'Invalid token', '#ff4444');
                clearModelPicker();
            } else if (response.status === 404) {
                // Fallback to Azure inference API if GitHub API doesn't work
                console.log('GitHub Models API not available, falling back to inference API');
                await fetchModelsFromInferenceAPI(token);
            } else {
                const errorText = await response.text();
                console.error('Failed to fetch models from GitHub API:', response.status, errorText);
                // Try fallback
                await fetchModelsFromInferenceAPI(token);
            }
        } catch (error) {
            console.error('Error fetching models:', error);
            // Try fallback to inference API
            await fetchModelsFromInferenceAPI(token);
        }
    }
    
    // Fallback function to fetch from Azure inference API
    async function fetchModelsFromInferenceAPI(token) {
        try {
            const response = await fetch('https://models.inference.ai.azure.com/models', {
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const models = await response.json();
                const chatModels = models.filter(m => m.task === 'chat-completion');
                
                if (chatModels.length === 0) {
                    showToast('No chat models available.', 'warning', 'No Models');
                    updateModelStatus('error', 'No models available', '#ff4444');
                    clearModelPicker();
                    return;
                }
                
                const modelNamesToShow = chatModels.slice(0, 3).map(m => m.friendly_name || m.name);
                const moreText = chatModels.length > 3 ? ` and ${chatModels.length - 3} more` : '';
                showToast(`Models: ${modelNamesToShow.join(', ')}${moreText}`, 'success', `${chatModels.length} Models Loaded`, 5000);
                
                updateModelStatus('ready', `${chatModels.length} models ready`, '#00bfa5');
                localStorage.setItem('availableModels', JSON.stringify(chatModels));
                populateModelPicker(chatModels);
            } else {
                showToast('Failed to load models. Please check your token permissions.', 'error', 'API Error');
                updateModelStatus('error', 'Failed to load', '#ff4444');
                clearModelPicker();
            }
        } catch (error) {
            console.error('Fallback fetch failed:', error);
            showToast('Network error while fetching models.', 'error', 'Connection Error');
            updateModelStatus('error', 'Network error', '#ff4444');
            clearModelPicker();
        }
    }

    // Helper function to get model ID for API calls
    function getModelId(model) {
        return model.name || model.id;
    }

    // Helper function to get model display name for UI
    function getModelDisplayName(model) {
        return model.friendly_name || model.display_name || model.name || model.id;
    }

    // Populate model picker dropdown with available models from GitHub API
    function populateModelPicker(models) {
        const modelSelect = document.getElementById('chatModelSelect');
        if (!modelSelect) return;

        // Save currently selected model
        const currentSelection = modelSelect.value || localStorage.getItem('selectedModel');
        
        // Remove any existing change listeners by cloning the element
        const newModelSelect = modelSelect.cloneNode(false);
        modelSelect.parentNode.replaceChild(newModelSelect, modelSelect);

        if (!models || models.length === 0) {
            // No models available
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No models available';
            option.disabled = true;
            newModelSelect.appendChild(option);
            newModelSelect.disabled = true;
            newModelSelect.setAttribute('aria-label', 'No AI models available - Check token permissions');
            resizeModelSelector();
            return;
        }

        // Enable the select if it was disabled
        newModelSelect.disabled = false;
        newModelSelect.setAttribute('aria-label', `AI Model Selector - ${models.length} models available`);

        // Use fetched models from GitHub API
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = getModelId(model);
            option.textContent = getModelDisplayName(model);
            newModelSelect.appendChild(option);
        });

        // Restore previous selection if it exists in the new list
        const options = Array.from(newModelSelect.options);
        const matchingOption = options.find(opt => opt.value === currentSelection);
        if (matchingOption) {
            newModelSelect.value = currentSelection;
        } else if (newModelSelect.options.length > 0) {
            // Default to first option if previous selection not found
            newModelSelect.selectedIndex = 0;
            localStorage.setItem('selectedModel', newModelSelect.value);
        }

        // Save selection when changed and resize (single listener)
        newModelSelect.addEventListener('change', function() {
            localStorage.setItem('selectedModel', this.value);
            resizeModelSelector();
        });
        
        // Initial resize
        resizeModelSelector();
    }

    // Dynamically resize model selector based on selected option text
    function resizeModelSelector() {
        const modelSelect = document.getElementById('chatModelSelect');
        if (!modelSelect) return;
        
        // Constants for width calculation
        const PADDING_AND_ARROW_SPACE = 40; // Extra space for padding and dropdown arrow
        const MIN_WIDTH = 150; // Minimum width in pixels
        const MAX_WIDTH_PERCENTAGE = 0.9; // Max width as percentage of parent
        const FALLBACK_MAX_WIDTH = 400; // Fallback max width if no parent
        
        // Get computed styles once for better performance
        const computedStyle = window.getComputedStyle(modelSelect);
        
        // Create a temporary span to measure text width
        const tempSpan = document.createElement('span');
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.whiteSpace = 'nowrap';
        tempSpan.style.font = computedStyle.font;
        tempSpan.style.fontSize = computedStyle.fontSize;
        tempSpan.style.fontWeight = computedStyle.fontWeight;
        
        // Get selected option text
        const selectedOption = modelSelect.options[modelSelect.selectedIndex];
        tempSpan.textContent = selectedOption ? selectedOption.textContent : '';
        
        try {
            document.body.appendChild(tempSpan);
            
            // Calculate width with some padding for dropdown arrow and borders
            const textWidth = tempSpan.offsetWidth;
            const newWidth = Math.max(textWidth + PADDING_AND_ARROW_SPACE, MIN_WIDTH);
            const maxWidth = modelSelect.parentElement 
                ? modelSelect.parentElement.offsetWidth * MAX_WIDTH_PERCENTAGE 
                : FALLBACK_MAX_WIDTH;
            
            modelSelect.style.width = Math.min(newWidth, maxWidth) + 'px';
        } finally {
            // Always remove the temporary element
            if (tempSpan.parentNode) {
                document.body.removeChild(tempSpan);
            }
        }
    }

    // Clear model picker when models cannot be fetched
    function clearModelPicker() {
        const modelSelect = document.getElementById('chatModelSelect');
        if (!modelSelect) return;

        modelSelect.innerHTML = '';
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'Unable to load models';
        option.disabled = true;
        modelSelect.appendChild(option);
        modelSelect.disabled = true;
        resizeModelSelector();
    }

    // Chat window functions
    function showChatWindow() {
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow) {
            chatWindow.style.display = 'flex';
        }
    }

    function hideChatWindow() {
        const chatWindow = document.getElementById('chatWindow');
        if (chatWindow) {
            chatWindow.style.display = 'none';
        }
    }

    // Auto-resize textarea as user types
    function autoResizeTextarea(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    // Handle Enter key to send message (Shift+Enter for new line)
    function handleChatKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            askAI();
        }
    }

    // Handle file upload for chat
    function handleChatFileUpload(input) {
        const file = input.files[0];
        if (file) {
            showToast('File attachment feature coming soon!', 'info', 'Feature Preview');
            input.value = '';
        }
    }

    // Simple syntax highlighter for code blocks
    function highlightCode(code, lang) {
        if (!lang) return code;
        
        const langLower = lang.toLowerCase();
        
        // Keywords by language
        const keywords = {
            javascript: /\b(const|let|var|function|return|if|else|for|while|class|import|export|from|default|async|await|try|catch|throw|new|this|typeof|instanceof|null|undefined|true|false)\b/g,
            js: /\b(const|let|var|function|return|if|else|for|while|class|import|export|from|default|async|await|try|catch|throw|new|this|typeof|instanceof|null|undefined|true|false)\b/g,
            python: /\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with|lambda|True|False|None|and|or|not|in|is|self)\b/g,
            py: /\b(def|class|if|elif|else|for|while|return|import|from|as|try|except|finally|with|lambda|True|False|None|and|or|not|in|is|self)\b/g,
            html: /\b(html|head|body|div|span|p|a|img|script|style|link|meta|title|h[1-6]|ul|ol|li|table|tr|td|th|form|input|button|select|option)\b/g,
            css: /\b(color|background|margin|padding|border|font|width|height|display|position|flex|grid|transform|transition|animation)\b/g,
            ruby: /\b(def|class|module|if|elsif|else|unless|case|when|while|until|for|do|end|return|yield|begin|rescue|ensure|raise|nil|true|false|self|require|include)\b/g,
            sql: /\b(SELECT|FROM|WHERE|INSERT|UPDATE|DELETE|CREATE|DROP|ALTER|TABLE|INDEX|JOIN|LEFT|RIGHT|INNER|OUTER|ON|AND|OR|NOT|NULL|AS|ORDER|BY|GROUP|HAVING|LIMIT)\b/gi,
            json: /("[\w]+")(?=\s*:)/g,
            bash: /\b(if|then|else|fi|for|while|do|done|case|esac|function|return|echo|exit|cd|ls|mkdir|rm|cp|mv|cat|grep|sed|awk)\b/g,
            sh: /\b(if|then|else|fi|for|while|do|done|case|esac|function|return|echo|exit|cd|ls|mkdir|rm|cp|mv|cat|grep|sed|awk)\b/g
        };
        
        let highlighted = code;
        
        // Highlight strings (must do first to avoid conflicts)
        highlighted = highlighted.replace(/(["'`])(?:(?!\1)[^\\]|\\.)*\1/g, '<span class="string">$&</span>');
        
        // Highlight comments
        highlighted = highlighted.replace(/(\/\/.*$|\/\*[\s\S]*?\*\/|#.*$)/gm, '<span class="comment">$&</span>');
        
        // Highlight numbers
        highlighted = highlighted.replace(/\b(\d+\.?\d*)\b/g, '<span class="number">$1</span>');
        
        // Highlight keywords based on language
        if (keywords[langLower]) {
            highlighted = highlighted.replace(keywords[langLower], '<span class="keyword">$&</span>');
        }
        
        // Highlight function calls
        highlighted = highlighted.replace(/\b([a-zA-Z_]\w*)\s*\(/g, '<span class="function">$1</span>(');
        
        return highlighted;
    }

    // Format text to HTML with markdown-like features
    function formatMessageText(text) {
        // Escape HTML first
        let formatted = text.replace(/&/g, '&amp;')
                           .replace(/</g, '&lt;')
                           .replace(/>/g, '&gt;');
        
        // Format code blocks (```...```) with syntax highlighting
        formatted = formatted.replace(/```([a-zA-Z0-9+-]*)\n?([\s\S]*?)```/g, function(match, lang, code) {
            const langLabel = lang || 'code';
            const highlightedCode = highlightCode(code.trim(), lang);
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            return `<div class="code-block-wrapper">
                <div class="code-block-header">
                    <span class="code-lang-label">${langLabel}</span>
                    <button class="code-copy-btn" onclick="copyCodeBlock('${codeId}')">Copy</button>
                </div>
                <pre><code id="${codeId}" class="language-${lang}">${highlightedCode}</code></pre>
            </div>`;
        });
        
        // Format inline code (`...`)
        formatted = formatted.replace(/`([^`]*)`/g, '<code>$1</code>');
        
        // Format bold (**...** or __...__)
        formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        formatted = formatted.replace(/__([^_]+)__/g, '<strong>$1</strong>');
        
        // Format bullet points (- ... or * ...)
        const lines = formatted.split('\n');
        let inList = false;
        let listType = '';
        const processedLines = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (line.match(/^[\-\*]\s+/)) {
                if (!inList) {
                    processedLines.push('<ul>');
                    inList = true;
                    listType = 'ul';
                }
                processedLines.push('<li>' + line.replace(/^[\-\*]\s+/, '') + '</li>');
            } else if (line.match(/^\d+\.\s+/)) {
                if (!inList) {
                    processedLines.push('<ol>');
                    inList = true;
                    listType = 'ol';
                } else if (listType === 'ul') {
                    processedLines.push('</ul>');
                    processedLines.push('<ol>');
                    listType = 'ol';
                }
                processedLines.push('<li>' + line.replace(/^\d+\.\s+/, '') + '</li>');
            } else {
                if (inList) {
                    processedLines.push(listType === 'ol' ? '</ol>' : '</ul>');
                    inList = false;
                    listType = '';
                }
                if (line.trim()) {
                    processedLines.push('<p>' + line + '</p>');
                } else if (i > 0 && processedLines.length > 0 && processedLines[processedLines.length - 1] !== '<br>') {
                    processedLines.push('<br>');
                }
            }
        }
        
        if (inList) {
            processedLines.push(listType === 'ol' ? '</ol>' : '</ul>');
        }
        
        return processedLines.join('\n');
    }

    // Copy code block content to clipboard
    function copyCodeBlock(codeId) {
        const codeElement = document.getElementById(codeId);
        if (codeElement) {
            // Get text content (without HTML tags)
            const code = codeElement.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('Code copied to clipboard!', 'success', 'Copied');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy code', 'error', 'Error');
            });
        }
    }

    // Add a message to the chat
    function addChatMessage(role, content) {
        const container = document.getElementById('chatMessagesContainer');
        
        // Remove empty state if it exists
        const emptyState = container.querySelector('.chat-empty-state');
        if (emptyState) {
            emptyState.remove();
        }
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;
        
        const avatarDiv = document.createElement('div');
        avatarDiv.className = 'chat-avatar';
        
        if (role === 'user') {
            // User avatar - use GitHub avatar if available
            const avatarUrl = getUserAvatarUrl();
            if (avatarUrl) {
                const img = document.createElement('img');
                img.src = avatarUrl;
                img.alt = 'User';
                img.onerror = function() { this.parentElement.textContent = 'U'; };
                avatarDiv.appendChild(img);
            } else {
                avatarDiv.textContent = 'U';
            }
        } else {
            // AI avatar - use Copilot SVG
            avatarDiv.innerHTML = getCopilotSvg();
        }
        
        const bubbleDiv = document.createElement('div');
        bubbleDiv.className = 'chat-bubble';
        
        if (role === 'user') {
            // User messages - plain text
            bubbleDiv.textContent = content;
        } else {
            // AI messages - formatted with markdown-like features
            bubbleDiv.innerHTML = formatMessageText(content);
        }
        
        messageDiv.appendChild(avatarDiv);
        messageDiv.appendChild(bubbleDiv);
        container.appendChild(messageDiv);
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
        
        // Add to chat history
        chatHistory.push({ role, content });
    }

    // Helper function to restore send button to normal state
    function restoreSendButton(sendBtn) {
        if (!sendBtn) return;
        sendBtn.disabled = false;
        sendBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        `;
    }

    // Helper function to set send button to loading state
    function setSendButtonLoading(sendBtn) {
        if (!sendBtn) return;
        sendBtn.disabled = true;
        sendBtn.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 6v6l4 2"></path>
            </svg>
        `;
    }

    // =============================================
    // Web Search Toggle and Status Functions
    // =============================================

    function toggleWebSearch() {
        webSearchEnabled = !webSearchEnabled;
        const toggle = document.getElementById('webSearchToggle');
        if (toggle) {
            if (webSearchEnabled) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }
        
        // Update placeholder text based on web search state
        const textarea = document.getElementById('aiPrompt');
        if (textarea) {
            textarea.placeholder = webSearchEnabled 
                ? 'Search the web or ask about markets...' 
                : 'Talk about Markets...';
        }
    }

    function showChatStatus(statusType, message) {
        const statusIndicator = document.getElementById('chatStatusIndicator');
        if (!statusIndicator) return;
        
        // Remove all status classes
        statusIndicator.classList.remove('status-searching', 'status-crawling', 'status-processing', 'status-complete');
        
        // Add the appropriate status class
        statusIndicator.classList.add(`status-${statusType}`);
        
        // Update the status text
        const statusText = statusIndicator.querySelector('.status-text');
        if (statusText) {
            statusText.textContent = message;
        }
        
        // Show the indicator
        statusIndicator.style.display = 'flex';
    }

    function hideChatStatus() {
        const statusIndicator = document.getElementById('chatStatusIndicator');
        if (statusIndicator) {
            statusIndicator.style.display = 'none';
        }
    }

    // =============================================
    // Web Search Tool Definitions
    // =============================================

    const webSearchTools = [
        {
            type: 'function',
            function: {
                name: 'web_search',
                description: 'Search the web for current information, news, stock prices, market data, or any other real-time information. Use this when the user asks about current events, recent news, live prices, or anything that requires up-to-date information.',
                parameters: {
                    type: 'object',
                    properties: {
                        query: {
                            type: 'string',
                            description: 'The search query to find information on the web'
                        }
                    },
                    required: ['query']
                }
            }
        },
        {
            type: 'function',
            function: {
                name: 'fetch_url',
                description: 'Fetch and read the content of a specific URL. Use this to get detailed information from a webpage when you have a specific URL to read.',
                parameters: {
                    type: 'object',
                    properties: {
                        url: {
                            type: 'string',
                            description: 'The full URL to fetch content from (must start with http:// or https://)'
                        }
                    },
                    required: ['url']
                }
            }
        }
    ];

    // =============================================
    // Web Search Implementation Functions
    // =============================================

    /**
     * Validates if a string is a valid URL
     */
    function isValidUrl(string) {
        try {
            const url = new URL(string);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch (_) {
            return false;
        }
    }

    /**
     * Performs a web search using DuckDuckGo's HTML interface (CORS-friendly)
     */
    async function performWebSearch(query) {
        showChatStatus('searching', `Searching: "${query}"`);
        
        try {
            // Use DuckDuckGo's instant answer API (JSON, more CORS-friendly)
            const searchUrl = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`;
            
            const response = await fetch(searchUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Search failed: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Build results from DuckDuckGo instant answers
            const results = [];
            
            // Add abstract if available
            if (data.Abstract) {
                results.push({
                    title: data.Heading || 'Summary',
                    snippet: data.Abstract,
                    url: data.AbstractURL || data.AbstractSource
                });
            }
            
            // Add related topics
            if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                for (const topic of data.RelatedTopics.slice(0, CONFIG.WEB_SEARCH_MAX_RESULTS - 1)) {
                    if (topic.Text && topic.FirstURL) {
                        results.push({
                            title: topic.Text.split(' - ')[0] || 'Related',
                            snippet: topic.Text,
                            url: topic.FirstURL
                        });
                    } else if (topic.Topics) {
                        // Handle nested topics
                        for (const subtopic of topic.Topics.slice(0, 2)) {
                            if (subtopic.Text && subtopic.FirstURL) {
                                results.push({
                                    title: subtopic.Text.split(' - ')[0] || 'Related',
                                    snippet: subtopic.Text,
                                    url: subtopic.FirstURL
                                });
                            }
                        }
                    }
                }
            }
            
            // If no results from instant answers, return a message indicating we need to try fetching directly
            if (results.length === 0) {
                return {
                    success: true,
                    query: query,
                    results: [],
                    message: `No instant results found for "${query}". The AI should provide information from its knowledge or suggest specific URLs to fetch.`
                };
            }
            
            return {
                success: true,
                query: query,
                results: results.slice(0, CONFIG.WEB_SEARCH_MAX_RESULTS),
                resultCount: results.length
            };
            
        } catch (error) {
            console.error('Web search error:', error);
            return {
                success: false,
                query: query,
                error: error.message || 'Search failed',
                message: 'Unable to perform web search. Please try again or ask a question that can be answered from AI knowledge.'
            };
        }
    }

    /**
     * Fetches and parses content from a URL
     */
    async function fetchUrlContent(url) {
        showChatStatus('crawling', `Fetching: ${new URL(url).hostname}`);
        
        if (!isValidUrl(url)) {
            return {
                success: false,
                url: url,
                error: 'Invalid URL format'
            };
        }
        
        try {
            // Use CORS proxy for fetching
            const proxyUrl = CONFIG.CORS_PROXY + encodeURIComponent(url);
            
            const response = await fetch(proxyUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch: ${response.status}`);
            }
            
            const html = await response.text();
            
            // Parse and extract main content
            const content = extractMainContent(html, url);
            
            return {
                success: true,
                url: url,
                title: content.title,
                content: content.text,
                wordCount: content.wordCount
            };
            
        } catch (error) {
            console.error('URL fetch error:', error);
            return {
                success: false,
                url: url,
                error: error.message || 'Failed to fetch URL'
            };
        }
    }

    /**
     * Extracts main content from HTML
     */
    function extractMainContent(html, sourceUrl) {
        // Create a temporary DOM parser
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Get title
        const title = doc.querySelector('title')?.textContent || 
                     doc.querySelector('h1')?.textContent || 
                     'Untitled';
        
        // Remove script, style, nav, footer, header, aside elements
        const elementsToRemove = doc.querySelectorAll('script, style, nav, footer, header, aside, iframe, noscript, .ads, .advertisement, .sidebar, .menu, .navigation');
        elementsToRemove.forEach(el => el.remove());
        
        // Try to find main content areas
        let mainContent = doc.querySelector('main, article, .content, .post, .article-content, #content, #main');
        
        if (!mainContent) {
            mainContent = doc.body;
        }
        
        // Extract text content
        let text = mainContent?.textContent || '';
        
        // Clean up the text
        text = text
            .replace(/\s+/g, ' ')           // Normalize whitespace
            .replace(/\n\s*\n/g, '\n\n')    // Normalize line breaks
            .trim();
        
        // Truncate if too long (keep first 4000 chars to stay within token limits)
        const maxLength = 4000;
        if (text.length > maxLength) {
            text = text.substring(0, maxLength) + '...[content truncated]';
        }
        
        return {
            title: title.trim(),
            text: text,
            wordCount: text.split(/\s+/).length
        };
    }

    /**
     * Executes a tool call and returns the result
     */
    async function executeToolCall(toolCall) {
        const functionName = toolCall.function.name;
        let args;
        
        try {
            args = JSON.parse(toolCall.function.arguments);
        } catch (e) {
            return {
                tool_call_id: toolCall.id,
                role: 'tool',
                name: functionName,
                content: JSON.stringify({ error: 'Invalid function arguments' })
            };
        }
        
        let result;
        
        switch (functionName) {
            case 'web_search':
                result = await performWebSearch(args.query);
                break;
            case 'fetch_url':
                result = await fetchUrlContent(args.url);
                break;
            default:
                result = { error: `Unknown function: ${functionName}` };
        }
        
        return {
            tool_call_id: toolCall.id,
            role: 'tool',
            name: functionName,
            content: JSON.stringify(result)
        };
    }

    /**
     * Formats citations from tool results
     */
    function formatCitations(toolResults) {
        const citations = [];
        
        for (const result of toolResults) {
            try {
                const data = JSON.parse(result.content);
                
                if (result.name === 'web_search' && data.results) {
                    for (const item of data.results) {
                        if (item.url && !citations.some(c => c.url === item.url)) {
                            citations.push({
                                title: item.title || new URL(item.url).hostname,
                                url: item.url
                            });
                        }
                    }
                } else if (result.name === 'fetch_url' && data.url) {
                    if (!citations.some(c => c.url === data.url)) {
                        citations.push({
                            title: data.title || new URL(data.url).hostname,
                            url: data.url
                        });
                    }
                }
            } catch (e) {
                // Skip invalid results
            }
        }
        
        return citations;
    }

    /**
     * Adds citations section to message content
     */
    function addCitationsToMessage(content, citations) {
        if (!citations || citations.length === 0) return content;
        
        let citationsHtml = '\n\n<div class="chat-citations-section">';
        citationsHtml += '<div class="chat-citations-label">Sources</div>';
        citationsHtml += '<div class="chat-citations-list">';
        
        for (const citation of citations) {
            const safeTitle = escapeHtml(citation.title);
            const safeUrl = encodeURI(citation.url);
            citationsHtml += `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer" class="chat-citation">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                ${safeTitle}
            </a>`;
        }
        
        citationsHtml += '</div></div>';
        
        return content + citationsHtml;
    }

    // =============================================
    // Main AI Request Function with Tool Calling
    // =============================================

    async function askAI() {
        const token = localStorage.getItem('githubToken');
        const prompt = document.getElementById('aiPrompt').value.trim();
        
        if (!token) {
            showToast('Please enter and save your GitHub token first', 'warning', 'Token Required');
            return;
        }
        
        if (!prompt) {
            showToast('Please enter a question or prompt', 'warning', 'Missing Prompt');
            return;
        }

        // Show chat window if not visible
        showChatWindow();
        
        // Add user message to chat
        addChatMessage('user', prompt);
        
        // Clear input and reset height
        const textarea = document.getElementById('aiPrompt');
        textarea.value = '';
        textarea.style.height = 'auto';
        
        // Disable send button and show loading
        const sendBtn = document.getElementById('chatSendBtn');
        setSendButtonLoading(sendBtn);
        
        // Show initial status
        if (webSearchEnabled) {
            showChatStatus('processing', 'Analyzing your request...');
        }
        
        // Add loading indicator - ensure unique ID or remove existing
        const container = document.getElementById('chatMessagesContainer');
        let loadingDiv = document.getElementById('loading-message');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        
        loadingDiv = document.createElement('div');
        loadingDiv.className = 'chat-message assistant';
        loadingDiv.id = 'loading-message';
        loadingDiv.innerHTML = `
            <div class="chat-avatar">${getCopilotSvg()}</div>
            <div class="chat-bubble">
                <span style="opacity: 0.7;">${webSearchEnabled ? 'Searching...' : 'Thinking...'}</span>
            </div>
        `;
        container.appendChild(loadingDiv);
        container.scrollTop = container.scrollHeight;

        try {
            const modelSelectElement = document.getElementById('chatModelSelect');
            
            if (!modelSelectElement) {
                showToast('Model selector not found. Please refresh the page.', 'error', 'UI Error');
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
                restoreSendButton(sendBtn);
                hideChatStatus();
                return;
            }
            
            const selectedModel = modelSelectElement.value;
            
            if (!selectedModel) {
                showToast('No AI model selected. Please save your GitHub token first to load available models.', 'warning', 'No Model Available');
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.remove();
                }
                restoreSendButton(sendBtn);
                hideChatStatus();
                return;
            }
            
            // Build system prompt
            const systemPrompt = webSearchEnabled 
                ? `You are an expert trading analyst with deep knowledge of technical analysis, fundamental analysis, and market dynamics. You have access to web search tools to find current information.

Your expertise includes:
- Technical patterns (breakouts, reversals, support/resistance)
- Risk management and position sizing
- Entry/exit timing and strategy development
- Market psychology and sentiment analysis
- Current market conditions and sector rotation
- Real-time news impact on stock movements

IMPORTANT: You have web search capabilities enabled. When the user asks about:
- Current stock prices or market data
- Recent news or events
- Live market conditions
- Any time-sensitive information

Use the web_search tool to find current information. Use fetch_url if you need to read a specific webpage in detail.

When analyzing trades:
1. Be specific and actionable - provide exact levels, percentages, and concrete steps
2. Consider current market environment and sentiment
3. Reference relevant technical indicators and patterns
4. Suggest specific risk management rules
5. Provide both bullish and bearish scenarios
6. Keep responses detailed but organized with clear sections

Format your responses with:
- Key findings at the top
- Detailed analysis in the middle
- Actionable recommendations at the bottom
- Use bullet points for clarity
- Include specific price levels and percentages

Be direct, professional, and avoid generic advice. Treat this as real money at stake. When using web search results, cite your sources.`
                : `You are an expert trading analyst with deep knowledge of technical analysis, fundamental analysis, and market dynamics. 

Your expertise includes:
- Technical patterns (breakouts, reversals, support/resistance)
- Risk management and position sizing
- Entry/exit timing and strategy development
- Market psychology and sentiment analysis
- Current market conditions and sector rotation
- Real-time news impact on stock movements

When analyzing trades:
1. Be specific and actionable - provide exact levels, percentages, and concrete steps
2. Consider current market environment and sentiment
3. Reference relevant technical indicators and patterns
4. Suggest specific risk management rules
5. Provide both bullish and bearish scenarios
6. Keep responses detailed but organized with clear sections

Format your responses with:
- Key findings at the top
- Detailed analysis in the middle
- Actionable recommendations at the bottom
- Use bullet points for clarity
- Include specific price levels and percentages

Be direct, professional, and avoid generic advice. Treat this as real money at stake.`;

            // Build initial messages
            const messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: prompt }
            ];
            
            // Tool calling loop
            let iteration = 0;
            let allToolResults = [];
            let finalResponse = null;
            
            while (iteration < CONFIG.WEB_SEARCH_MAX_ITERATIONS) {
                iteration++;
                
                // Build request body
                const requestBody = {
                    model: selectedModel,
                    messages: messages,
                    max_tokens: CONFIG.AI_MAX_TOKENS,
                    temperature: CONFIG.AI_TEMPERATURE
                };
                
                // Only include tools if web search is enabled
                if (webSearchEnabled) {
                    requestBody.tools = webSearchTools;
                    requestBody.tool_choice = 'auto';
                }
                
                // Make API call
                const response = await fetch(CONFIG.API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorData}`);
                }

                const data = await response.json();
                const responseMessage = data.choices[0].message;
                
                // Add response to messages for context
                messages.push(responseMessage);
                
                // Check if the model wants to call tools
                if (responseMessage.tool_calls && responseMessage.tool_calls.length > 0) {
                    // Process each tool call
                    for (const toolCall of responseMessage.tool_calls) {
                        // Update loading indicator with current action
                        const funcName = toolCall.function.name;
                        if (loadingDiv) {
                            const bubble = loadingDiv.querySelector('.chat-bubble span');
                            if (bubble) {
                                bubble.textContent = funcName === 'web_search' ? 'Searching the web...' : 'Reading webpage...';
                            }
                        }
                        
                        // Execute the tool
                        const toolResult = await executeToolCall(toolCall);
                        allToolResults.push(toolResult);
                        
                        // Add tool result to messages
                        messages.push(toolResult);
                    }
                    
                    // Update status
                    showChatStatus('processing', 'Processing results...');
                    
                } else {
                    // No more tool calls, we have the final response
                    finalResponse = responseMessage.content;
                    break;
                }
            }
            
            // If we hit max iterations without a final response, use the last content
            if (!finalResponse && messages.length > 0) {
                const lastAssistantMsg = messages.filter(m => m.role === 'assistant' && m.content).pop();
                finalResponse = lastAssistantMsg?.content || 'I was unable to complete the request. Please try again.';
            }

            // Remove loading indicator
            if (loadingDiv && loadingDiv.parentNode) {
                loadingDiv.remove();
            }
            
            // Hide status indicator
            hideChatStatus();
            
            // Update usage stats
            updateUsageStats('message', 1);
            updateUsageStats('model', selectedModel);
            if (allToolResults.length > 0) {
                updateUsageStats('search', allToolResults.length);
            }
            // Estimate tokens used (~4 chars per token is a rough approximation for English text)
            const estimatedTokens = Math.round((prompt.length + (finalResponse?.length || 0)) / 4);
            updateUsageStats('tokens', estimatedTokens);
            
            // Format citations if we have tool results
            const citations = formatCitations(allToolResults);
            
            // Add AI response to chat (with citations if available)
            if (citations.length > 0) {
                // Use special formatting for messages with citations
                const formattedContent = formatMessageText(finalResponse);
                const contentWithCitations = addCitationsToMessage(formattedContent, citations);
                
                // Add directly as HTML since we need the citation formatting
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message assistant';
                messageDiv.innerHTML = `
                    <div class="chat-avatar">${getCopilotSvg()}</div>
                    <div class="chat-bubble">${contentWithCitations}</div>
                `;
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                chatHistory.push({ role: 'assistant', content: finalResponse });
                
                // Auto-save chat after response
                if (!currentChatId) currentChatId = generateChatId();
                saveCurrentChat();
            } else {
                addChatMessage('assistant', finalResponse);
                
                // Auto-save chat after response
                if (!currentChatId) currentChatId = generateChatId();
                saveCurrentChat();
            }
            
        } catch (error) {
            console.error('AI request failed:', error);
            
            // Remove loading indicator
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg && loadingMsg.parentNode) {
                loadingMsg.remove();
            }
            
            // Hide status indicator
            hideChatStatus();
            
            // Sanitize error message
            const safeErrorMessage = String(error && error.message ? error.message : 'Unknown error')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
            
            addChatMessage('assistant', 'An error occurred while contacting the AI service. Make sure your GitHub token has access to GitHub Models and try again.\n\nError: ' + safeErrorMessage);
        } finally {
            // Re-enable send button
            restoreSendButton(sendBtn);
            hideChatStatus();
        }
    }

    function clearChat() {
        const container = document.getElementById('chatMessagesContainer');
        if (container) {
            container.innerHTML = `
                <div class="chat-empty-state">
                    <div class="chat-empty-icon"></div>
                    <div class="chat-empty-text">Start a conversation</div>
                    <div class="chat-empty-subtext">Ask about trades, patterns, or market sentiment</div>
                </div>
            `;
        }
        chatHistory = [];
    }

    // Chat History Management
    let allChats = JSON.parse(localStorage.getItem('chatSessions') || '[]');
    let currentChatId = null;

    function generateChatId() {
        return 'chat-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }

    function startNewChat() {
        // Save current chat first if it has messages
        if (chatHistory.length > 0 && currentChatId) {
            saveCurrentChat();
        }
        
        // Create new chat
        currentChatId = generateChatId();
        clearChat();
        
        // Reset stats for new conversation
        usageStats.messages = 0;
        document.getElementById('statMessages').textContent = '0';
        
        showToast('New conversation started', 'success', 'New Chat');
        hideChatHistoryDropdown();
    }

    function saveCurrentChat() {
        if (!currentChatId || chatHistory.length === 0) return;
        
        // Generate title from first user message
        const firstUserMsg = chatHistory.find(m => m.role === 'user');
        const title = firstUserMsg 
            ? firstUserMsg.content.substring(0, 40) + (firstUserMsg.content.length > 40 ? '...' : '')
            : 'New Chat';
        
        const chatData = {
            id: currentChatId,
            title: title,
            messages: chatHistory,
            timestamp: Date.now()
        };
        
        // Update or add to allChats
        const existingIndex = allChats.findIndex(c => c.id === currentChatId);
        if (existingIndex >= 0) {
            allChats[existingIndex] = chatData;
        } else {
            allChats.unshift(chatData); // Add to beginning
        }
        
        // Keep only last 20 chats
        if (allChats.length > 20) {
            allChats = allChats.slice(0, 20);
        }
        
        localStorage.setItem('chatSessions', JSON.stringify(allChats));
    }

    function loadChat(chatId) {
        // Save current chat first
        if (chatHistory.length > 0 && currentChatId) {
            saveCurrentChat();
        }
        
        const chat = allChats.find(c => c.id === chatId);
        if (!chat) return;
        
        currentChatId = chatId;
        chatHistory = chat.messages || [];
        
        // Render the chat
        const container = document.getElementById('chatMessagesContainer');
        container.innerHTML = '';
        
        chatHistory.forEach(msg => {
            if (msg.role === 'user' || msg.role === 'assistant') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.role}`;
                
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'chat-avatar';
                
                if (msg.role === 'user') {
                    const avatarUrl = getUserAvatarUrl();
                    if (avatarUrl) {
                        const img = document.createElement('img');
                        img.src = avatarUrl;
                        img.alt = 'User';
                        img.onerror = function() { this.parentElement.textContent = 'U'; };
                        avatarDiv.appendChild(img);
                    } else {
                        avatarDiv.textContent = 'U';
                    }
                } else {
                    avatarDiv.innerHTML = getCopilotSvg();
                }
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'chat-bubble';
                
                if (msg.role === 'user') {
                    bubbleDiv.textContent = msg.content;
                } else {
                    bubbleDiv.innerHTML = formatMessageText(msg.content);
                }
                
                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleDiv);
                container.appendChild(messageDiv);
            }
        });
        
        container.scrollTop = container.scrollHeight;
        hideChatHistoryDropdown();
    }

    function deleteChat(chatId, event) {
        event.stopPropagation();
        
        allChats = allChats.filter(c => c.id !== chatId);
        localStorage.setItem('chatSessions', JSON.stringify(allChats));
        
        // If deleting current chat, start new one
        if (chatId === currentChatId) {
            startNewChat();
        }
        
        renderChatHistoryList();
        showToast('Chat deleted', 'info', 'Deleted');
    }

    function toggleChatHistoryDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('chatHistoryDropdown');
        dropdown.classList.toggle('active');
        
        if (dropdown.classList.contains('active')) {
            renderChatHistoryList();
            document.addEventListener('click', closeChatHistoryOnOutsideClick);
        } else {
            document.removeEventListener('click', closeChatHistoryOnOutsideClick);
        }
    }

    function hideChatHistoryDropdown() {
        const dropdown = document.getElementById('chatHistoryDropdown');
        if (dropdown) {
            dropdown.classList.remove('active');
        }
        document.removeEventListener('click', closeChatHistoryOnOutsideClick);
    }

    function closeChatHistoryOnOutsideClick(event) {
        const dropdown = document.getElementById('chatHistoryDropdown');
        const btn = event.target.closest('.chat-history-btn');
        if (!dropdown.contains(event.target) && !btn) {
            hideChatHistoryDropdown();
        }
    }

    function renderChatHistoryList() {
        const list = document.getElementById('chatHistoryList');
        if (!list) return;
        
        if (allChats.length === 0) {
            list.innerHTML = '<div class="chat-history-empty">No chat history yet</div>';
            return;
        }
        
        list.innerHTML = allChats.map(chat => {
            const date = new Date(chat.timestamp);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isActive = chat.id === currentChatId ? 'background: rgba(204, 0, 0, 0.1);' : '';
            
            return `
                <div class="chat-history-item" style="${isActive}" onclick="loadChat('${chat.id}')">
                    <div class="chat-history-item-content">
                        <div class="chat-history-item-title">${escapeHtml(chat.title)}</div>
                        <div class="chat-history-item-date">${dateStr}</div>
                    </div>
                    <button class="chat-history-item-delete" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    // Auto-save chat when sending messages
    const originalAddChatMessage = addChatMessage;
    // We'll hook into the chat to auto-save periodically

    // Quick action functions - now populate chat instead of separate card
    function reviewGrades() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        if (grades.length === 0) {
            showToast('No grades to review. Save some grades first!', 'info', 'No Grades');
            return;
        }
        
        const summary = grades.slice(0, CONFIG.MAX_GRADES_FOR_REVIEW).map(g => `${g.ticker}: ${g.total}/100`).join(', ');
        document.getElementById('aiPrompt').value = `Review my recent trades and provide insights:\n${summary}\n\nAnalyze patterns, identify strengths/weaknesses, and suggest improvements.`;
        
        // Auto-trigger the send
        askAI();
    }

    function findPatterns() {
        const grades = JSON.parse(localStorage.getItem('prepareGrades') || '[]');
        if (grades.length < 2) {
            showToast('Need at least 2 grades to find patterns. Keep grading!', 'info', 'More Data Needed');
            return;
        }
        
        const data = grades.slice(0, CONFIG.MAX_GRADES_FOR_PATTERNS).map(g => ({
            ticker: g.ticker,
            total: g.total,
            pattern: g.scores.pattern,
            risk: g.scores.risk,
            catalyst: g.scores.catalyst
        }));
        
        document.getElementById('aiPrompt').value = `Find patterns in my trading grades:\n${JSON.stringify(data, null, 2)}\n\nIdentify what makes my high-scoring trades different from low-scoring ones.`;
        
        // Auto-trigger the send
        askAI();
    }

    function getSentiment() {
        document.getElementById('aiPrompt').value = `What is the current market sentiment? Consider:\n- Major indices (SPY, QQQ, DIA)\n- VIX levels\n- Sector rotation\n- Recent market news\n\nProvide a brief actionable summary for day trading.`;
        
        // Auto-trigger the send
        askAI();
    }

    // Refresh service worker only (not local storage or settings)
    function refreshServiceWorker() {
        toggleMenu();
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistration().then(function(registration) {
                if (registration) {
                    registration.update().then(function() {
                        // Force the waiting service worker to become active
                        if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        }
                        // Clear caches to get fresh frontend assets
                        caches.keys().then(function(cacheNames) {
                            return Promise.all(
                                cacheNames.map(function(cacheName) {
                                    return caches.delete(cacheName);
                                })
                            );
                        }).then(function() {
                            window.location.reload();
                        }).catch(function() {
                            window.location.reload();
                        });
                    });
                } else {
                    window.location.reload();
                }
            }).catch(function() {
                window.location.reload();
            });
        } else {
            window.location.reload();
        }
    }

    // Initialize on load - set up all event listeners and initialize UI
    window.onload = function() {
        // Initialize sliders
        updateSlider('pattern', 10, 20);
        updateSlider('risk', 10, 20);
        updateSlider('entry', 5, 10);
        updateSlider('performance', 5, 10);
        updateSlider('time', 10, 20);
        updateSlider('catalyst', 5, 10);
        updateSlider('environment', 5, 10);
        
        // Set up screenshot event listeners
        const screenshotInput = document.getElementById('screenshotInput');
        const addScreenshotBtn = document.getElementById('addScreenshotBtn');
        const clearScreenshotBtn = document.getElementById('clearScreenshotBtn');
        
        if (screenshotInput) {
            screenshotInput.addEventListener('change', function() {
                handleScreenshot(this);
            });
        }
        
        if (addScreenshotBtn) {
            addScreenshotBtn.addEventListener('click', function() {
                screenshotInput.click();
            });
        }
        
        if (clearScreenshotBtn) {
            clearScreenshotBtn.addEventListener('click', clearScreenshot);
        }
        
        // Initialize model picker state on page load
        // Will be populated when token is loaded and models are fetched
        clearModelPicker();
        
        // Set up ticker modal keyboard handling
        const tickerModalInput = document.getElementById('tickerModalInput');
        if (tickerModalInput) {
            tickerModalInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmTickerAnalysis();
                }
            });
        }
        
        // Close modal on overlay click
        const tickerModal = document.getElementById('tickerModal');
        if (tickerModal) {
            tickerModal.addEventListener('click', function(e) {
                if (e.target === tickerModal) {
                    hideTickerModal();
                }
            });
        }
        
        // Close trade details modal on overlay click
        const tradeDetailsModal = document.getElementById('tradeDetailsModal');
        if (tradeDetailsModal) {
            tradeDetailsModal.addEventListener('click', function(e) {
                if (e.target === tradeDetailsModal) {
                    hideTradeDetailsModal();
                }
            });
        }
        
        // Close finalize modal on overlay click
        const finalizeTradeModal = document.getElementById('finalizeTradeModal');
        if (finalizeTradeModal) {
            finalizeTradeModal.addEventListener('click', function(e) {
                if (e.target === finalizeTradeModal) {
                    hideFinalizeModal();
                }
            });
        }
        
        // Close image viewer on overlay click
        const imageViewerModal = document.getElementById('imageViewerModal');
        if (imageViewerModal) {
            imageViewerModal.addEventListener('click', function(e) {
                if (e.target === imageViewerModal) {
                    hideImageViewer();
                }
            });
        }
        
        // Set up GitHub token modal keyboard handling
        const githubTokenInput = document.getElementById('githubTokenInput');
        if (githubTokenInput) {
            githubTokenInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveGithubToken();
                }
            });
        }
        
        // Close GitHub token modal on overlay click
        const githubTokenModal = document.getElementById('githubTokenModal');
        if (githubTokenModal) {
            githubTokenModal.addEventListener('click', function(e) {
                if (e.target === githubTokenModal) {
                    hideGithubTokenModal();
                }
            });
        }
        
        // Close API token modal on overlay click
        const apiTokenModal = document.getElementById('apiTokenModal');
        if (apiTokenModal) {
            apiTokenModal.addEventListener('click', function(e) {
                if (e.target === apiTokenModal) {
                    hideApiTokenModal();
                }
            });
        }
        
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('system/js.on/sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(function(error) {
                    console.log('Service Worker registration failed:', error);
                    showToast('Some offline features may not be available. You can continue using the app online.', 'warning', 'Offline Mode Limited');
                });
        }
    };
</script>
</body>
</html>
